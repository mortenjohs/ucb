<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>class14.html</title>
  <meta name="generator" content="Haroopad 0.13.1" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>div.oembedall-githubrepos{border:1px solid #DDD;border-radius:4px;list-style-type:none;margin:0 0 10px;padding:8px 10px 0;font:13.34px/1.4 helvetica,arial,freesans,clean,sans-serif;width:452px;background-color:#fff}div.oembedall-githubrepos .oembedall-body{background:-moz-linear-gradient(center top,#FAFAFA,#EFEFEF);background:-webkit-gradient(linear,left top,left bottom,from(#FAFAFA),to(#EFEFEF));border-bottom-left-radius:4px;border-bottom-right-radius:4px;border-top:1px solid #EEE;margin-left:-10px;margin-top:8px;padding:5px 10px;width:100%}div.oembedall-githubrepos h3{font-size:14px;margin:0;padding-left:18px;white-space:nowrap}div.oembedall-githubrepos p.oembedall-description{color:#444;font-size:12px;margin:0 0 3px}div.oembedall-githubrepos p.oembedall-updated-at{color:#888;font-size:11px;margin:0}div.oembedall-githubrepos ul.oembedall-repo-stats{border:none;float:right;font-size:11px;font-weight:700;padding-left:15px;position:relative;z-index:5;margin:0}div.oembedall-githubrepos ul.oembedall-repo-stats li{border:none;color:#666;display:inline-block;list-style-type:none;margin:0!important}div.oembedall-githubrepos ul.oembedall-repo-stats li a{background-color:transparent;border:none;color:#666!important;background-position:5px -2px;background-repeat:no-repeat;border-left:1px solid #DDD;display:inline-block;height:21px;line-height:21px;padding:0 5px 0 23px}div.oembedall-githubrepos ul.oembedall-repo-stats li:first-child a{border-left:medium none;margin-right:-3px}div.oembedall-githubrepos ul.oembedall-repo-stats li a:hover{background:5px -27px no-repeat #4183C4;color:#FFF!important;text-decoration:none}div.oembedall-githubrepos ul.oembedall-repo-stats li:first-child a:hover{border-bottom-left-radius:3px;border-top-left-radius:3px}ul.oembedall-repo-stats li:last-child a:hover{border-bottom-right-radius:3px;border-top-right-radius:3px}span.oembedall-closehide{background-color:#aaa;border-radius:2px;cursor:pointer;margin-right:3px}div.oembedall-container{margin-top:5px;text-align:left}.oembedall-ljuser{font-weight:700}.oembedall-ljuser img{vertical-align:bottom;border:0;padding-right:1px}.oembedall-stoqembed{border-bottom:1px dotted #999;float:left;overflow:hidden;width:730px;line-height:1;background:#FFF;color:#000;font-family:Arial,Liberation Sans,DejaVu Sans,sans-serif;font-size:80%;text-align:left;margin:0;padding:0}.oembedall-stoqembed a{color:#07C;text-decoration:none;margin:0;padding:0}.oembedall-stoqembed a:hover{text-decoration:underline}.oembedall-stoqembed a:visited{color:#4A6B82}.oembedall-stoqembed h3{font-family:Trebuchet MS,Liberation Sans,DejaVu Sans,sans-serif;font-size:130%;font-weight:700;margin:0;padding:0}.oembedall-stoqembed .oembedall-reputation-score{color:#444;font-size:120%;font-weight:700;margin-right:2px}.oembedall-stoqembed .oembedall-user-info{height:35px;width:185px}.oembedall-stoqembed .oembedall-user-info .oembedall-user-gravatar32{float:left;height:32px;width:32px}.oembedall-stoqembed .oembedall-user-info .oembedall-user-details{float:left;margin-left:5px;overflow:hidden;white-space:nowrap;width:145px}.oembedall-stoqembed .oembedall-question-hyperlink{font-weight:700}.oembedall-stoqembed .oembedall-stats{background:#EEE;margin:0 0 0 7px;padding:4px 7px 6px;width:58px}.oembedall-stoqembed .oembedall-statscontainer{float:left;margin-right:8px;width:86px}.oembedall-stoqembed .oembedall-votes{color:#555;padding:0 0 7px;text-align:center}.oembedall-stoqembed .oembedall-vote-count-post{font-size:240%;color:#808185;display:block;font-weight:700}.oembedall-stoqembed .oembedall-views{color:#999;padding-top:4px;text-align:center}.oembedall-stoqembed .oembedall-status{margin-top:-3px;padding:4px 0;text-align:center;background:#75845C;color:#FFF}.oembedall-stoqembed .oembedall-status strong{color:#FFF;display:block;font-size:140%}.oembedall-stoqembed .oembedall-summary{float:left;width:635px}.oembedall-stoqembed .oembedall-excerpt{line-height:1.2;margin:0;padding:0 0 5px}.oembedall-stoqembed .oembedall-tags{float:left;line-height:18px}.oembedall-stoqembed .oembedall-tags a:hover{text-decoration:none}.oembedall-stoqembed .oembedall-post-tag{background-color:#E0EAF1;border-bottom:1px solid #3E6D8E;border-right:1px solid #7F9FB6;color:#3E6D8E;font-size:90%;line-height:2.4;margin:2px 2px 2px 0;padding:3px 4px;text-decoration:none;white-space:nowrap}.oembedall-stoqembed .oembedall-post-tag:hover{background-color:#3E6D8E;border-bottom:1px solid #37607D;border-right:1px solid #37607D;color:#E0EAF1}.oembedall-stoqembed .oembedall-fr{float:right}.oembedall-stoqembed .oembedall-statsarrow{background-image:url(http://cdn.sstatic.net/stackoverflow/img/sprites.png?v=3);background-repeat:no-repeat;overflow:hidden;background-position:0 -435px;float:right;height:13px;margin-top:12px;width:7px}.oembedall-facebook1{border:1px solid #1A3C6C;padding:0;font:13.34px/1.4 verdana;width:500px}.oembedall-facebook2{background-color:#627add}.oembedall-facebook2 a{color:#e8e8e8;text-decoration:none}.oembedall-facebookBody{background-color:#fff;vertical-align:top;padding:5px}.oembedall-facebookBody .contents{display:inline-block;width:100%}.oembedall-facebookBody div img{float:left;margin-right:5px}div.oembedall-lanyard{-webkit-box-shadow:none;-webkit-transition-delay:0s;-webkit-transition-duration:.4000000059604645s;-webkit-transition-property:width;-webkit-transition-timing-function:cubic-bezier(0.42,0,.58,1);background-attachment:scroll;background-clip:border-box;background-color:transparent;background-image:none;background-origin:padding-box;border-width:0;box-shadow:none;color:#112644;display:block;float:left;font-family:'Trebuchet MS',Trebuchet,sans-serif;font-size:16px;height:253px;line-height:19px;margin:0;max-width:none;min-height:0;outline:#112644 0;overflow-x:visible;overflow-y:visible;padding:0;position:relative;text-align:left;vertical-align:baseline;width:804px}div.oembedall-lanyard .tagline{font-size:1.5em}div.oembedall-lanyard .wrapper{overflow:hidden;clear:both}div.oembedall-lanyard .split{float:left;display:inline}div.oembedall-lanyard .prominent-place .flag:active,div.oembedall-lanyard .prominent-place .flag:focus,div.oembedall-lanyard .prominent-place .flag:hover,div.oembedall-lanyard .prominent-place .flag:link,div.oembedall-lanyard .prominent-place .flag:visited{float:left;display:block;width:48px;height:48px;position:relative;top:-5px;margin-right:10px}div.oembedall-lanyard .place-context{font-size:.889em}div.oembedall-lanyard .prominent-place .sub-place{display:block}div.oembedall-lanyard .prominent-place{font-size:1.125em;line-height:1.1em;font-weight:400}div.oembedall-lanyard .main-date{color:#8CB4E0;font-weight:700;line-height:1.1}div.oembedall-lanyard .first{width:48.57%;margin:0 0 0 2.857%}.mermaid .label{color:#333}.node circle,.node polygon,.node rect{fill:#cde498;stroke:#13540c;stroke-width:1px}.edgePath .path{stroke:green;stroke-width:1.5px}.cluster rect{fill:#cdffb2;rx:40;stroke:#6eaa49;stroke-width:1px}.cluster text{fill:#333}.actor{stroke:#13540c;fill:#cde498}text.actor{fill:#000;stroke:none}.actor-line{stroke:grey}.messageLine0{stroke-width:1.5;stroke-dasharray:"2 2";marker-end:"url(#arrowhead)";stroke:#333}.messageLine1{stroke-width:1.5;stroke-dasharray:"2 2";stroke:#333}#arrowhead{fill:#333}#crosshead path{fill:#333!important;stroke:#333!important}.messageText{fill:#333;stroke:none}.labelBox{stroke:#326932;fill:#cde498}.labelText,.loopText{fill:#000;stroke:none}.loopLine{stroke-width:2;stroke-dasharray:"2 2";marker-end:"url(#arrowhead)";stroke:#326932}.note{stroke:#6eaa49;fill:#fff5ad}.noteText{fill:#000;stroke:none;font-family:'trebuchet ms',verdana,arial;font-size:14px}.section{stroke:none;opacity:.2}.section0,.section2{fill:#6eaa49}.section1,.section3{fill:#fff;opacity:.2}.sectionTitle0,.sectionTitle1,.sectionTitle2,.sectionTitle3{fill:#333}.sectionTitle{text-anchor:start;font-size:11px;text-height:14px}.grid .tick{stroke:lightgrey;opacity:.3;shape-rendering:crispEdges}.grid path{stroke-width:0}.today{fill:none;stroke:red;stroke-width:2px}.task{stroke-width:2}.taskText{text-anchor:middle;font-size:11px}.taskTextOutsideRight{fill:#000;text-anchor:start;font-size:11px}.taskTextOutsideLeft{fill:#000;text-anchor:end;font-size:11px}.taskText0,.taskText1,.taskText2,.taskText3{fill:#fff}.task0,.task1,.task2,.task3{fill:#487e3a;stroke:#13540c}.taskTextOutside0,.taskTextOutside1,.taskTextOutside2,.taskTextOutside3{fill:#000}.active0,.active1,.active2,.active3{fill:#cde498;stroke:#13540c}.activeText0,.activeText1,.activeText2,.activeText3{fill:#000!important}.done0,.done1,.done2,.done3{stroke:grey;fill:lightgrey;stroke-width:2}.doneText0,.doneText1,.doneText2,.doneText3{fill:#000!important}.crit0,.crit1,.crit2,.crit3{stroke:#f88;fill:red;stroke-width:2}.activeCrit0,.activeCrit1,.activeCrit2,.activeCrit3{stroke:#f88;fill:#cde498;stroke-width:2}.doneCrit0,.doneCrit1,.doneCrit2,.doneCrit3{stroke:#f88;fill:lightgrey;stroke-width:2;cursor:pointer;shape-rendering:crispEdges}.activeCritText0,.activeCritText1,.activeCritText2,.activeCritText3,.doneCritText0,.doneCritText1,.doneCritText2,.doneCritText3{fill:#000!important}.titleText{text-anchor:middle;font-size:18px;fill:#000}text{font-family:'trebuchet ms',verdana,arial;font-size:14px}html{height:100%}body{margin:0!important;padding:5px 20px 26px!important;background-color:#fff;font-family:"Lucida Grande","Segoe UI","Apple SD Gothic Neo","Malgun Gothic","Lucida Sans Unicode",Helvetica,Arial,sans-serif;font-size:.9em;overflow-x:hidden;overflow-y:auto}br,h1,h2,h3,h4,h5,h6{clear:both}hr.page{background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC) repeat-x;border:0;height:3px;padding:0}hr.underscore{border-top-style:dashed!important}body >:first-child{margin-top:0!important}img.plugin{box-shadow:0 1px 3px rgba(0,0,0,.1);border-radius:3px}iframe{border:0}figure{-webkit-margin-before:0;-webkit-margin-after:0;-webkit-margin-start:0;-webkit-margin-end:0}kbd{border:1px solid #aaa;-moz-border-radius:2px;-webkit-border-radius:2px;border-radius:2px;-moz-box-shadow:1px 2px 2px #ddd;-webkit-box-shadow:1px 2px 2px #ddd;box-shadow:1px 2px 2px #ddd;background-color:#f9f9f9;background-image:-moz-linear-gradient(top,#eee,#f9f9f9,#eee);background-image:-o-linear-gradient(top,#eee,#f9f9f9,#eee);background-image:-webkit-linear-gradient(top,#eee,#f9f9f9,#eee);background-image:linear-gradient(top,#eee,#f9f9f9,#eee);padding:1px 3px;font-family:inherit;font-size:.85em}.oembeded .oembed_photo{display:inline-block}img[data-echo]{margin:25px 0;width:100px;height:100px;background:url(../img/ajax.gif) center center no-repeat #fff}.spinner{display:inline-block;width:10px;height:10px;margin-bottom:-.1em;border:2px solid rgba(0,0,0,.5);border-top-color:transparent;border-radius:100%;-webkit-animation:spin 1s infinite linear;animation:spin 1s infinite linear}.spinner:after{content:'';display:block;width:0;height:0;position:absolute;top:-6px;left:0;border:4px solid transparent;border-bottom-color:rgba(0,0,0,.5);-webkit-transform:rotate(45deg);transform:rotate(45deg)}@-webkit-keyframes spin{to{-webkit-transform:rotate(360deg)}}@keyframes spin{to{transform:rotate(360deg)}}p.toc{margin:0!important}p.toc ul{padding-left:10px}p.toc>ul{padding:10px;margin:0 10px;display:inline-block;border:1px solid #ededed;border-radius:5px}p.toc li,p.toc ul{list-style-type:none}p.toc li{width:100%;padding:0;overflow:hidden}p.toc li a::after{content:"."}p.toc li a:before{content:"• "}p.toc h5{text-transform:uppercase}p.toc .title{float:left;padding-right:3px}p.toc .number{margin:0;float:right;padding-left:3px;background:#fff;display:none}input.task-list-item{margin-left:-1.62em}.markdown{font-family:"Hiragino Sans GB","Microsoft YaHei",STHeiti,SimSun,"Lucida Grande","Lucida Sans Unicode","Lucida Sans",'Segoe UI',AppleSDGothicNeo-Medium,'Malgun Gothic',Verdana,Tahoma,sans-serif;padding:20px}.markdown a{text-decoration:none;vertical-align:baseline}.markdown a:hover{text-decoration:underline}.markdown h1{font-size:2.2em;font-weight:700;margin:1.5em 0 1em}.markdown h2{font-size:1.8em;font-weight:700;margin:1.275em 0 .85em}.markdown h3{font-size:1.6em;font-weight:700;margin:1.125em 0 .75em}.markdown h4{font-size:1.4em;font-weight:700;margin:.99em 0 .66em}.markdown h5{font-size:1.2em;font-weight:700;margin:.855em 0 .57em}.markdown h6{font-size:1em;font-weight:700;margin:.75em 0 .5em}.markdown h1+p,.markdown h1:first-child,.markdown h2+p,.markdown h2:first-child,.markdown h3+p,.markdown h3:first-child,.markdown h4+p,.markdown h4:first-child,.markdown h5+p,.markdown h5:first-child,.markdown h6+p,.markdown h6:first-child{margin-top:0}.markdown hr{border:1px solid #ccc}.markdown p{margin:1em 0;word-wrap:break-word}.markdown ol{list-style-type:decimal}.markdown li{display:list-item;line-height:1.4em}.markdown blockquote{margin:1em 20px}.markdown blockquote>:first-child{margin-top:0}.markdown blockquote>:last-child{margin-bottom:0}.markdown blockquote cite:before{content:'\2014 \00A0'}.markdown .code{border-radius:3px;word-wrap:break-word}.markdown pre{border-radius:3px;word-wrap:break-word;border:1px solid #ccc;overflow:auto;padding:.5em}.markdown pre code{border:0;display:block}.markdown pre>code{font-family:Consolas,Inconsolata,Courier,monospace;font-weight:700;white-space:pre;margin:0}.markdown code{border-radius:3px;word-wrap:break-word;border:1px solid #ccc;padding:0 5px;margin:0 2px}.markdown img{max-width:100%}.markdown mark{color:#000;background-color:#fcf8e3}.markdown table{padding:0;border-collapse:collapse;border-spacing:0;margin-bottom:16px}.markdown table tr td,.markdown table tr th{border:1px solid #ccc;margin:0;padding:6px 13px}.markdown table tr th{font-weight:700}.markdown table tr th>:first-child{margin-top:0}.markdown table tr th>:last-child{margin-bottom:0}.markdown table tr td>:first-child{margin-top:0}.markdown table tr td>:last-child{margin-bottom:0}.github{padding:20px;font-family:"Helvetica Neue",Helvetica,"Hiragino Sans GB","Microsoft YaHei",STHeiti,SimSun,"Segoe UI",AppleSDGothicNeo-Medium,'Malgun Gothic',Arial,freesans,sans-serif;font-size:15px;background:#fff;line-height:1.6;-webkit-font-smoothing:antialiased}.github a{color:#3269a0}.github a:hover{color:#4183c4}.github h2{border-bottom:1px solid #e6e6e6;line-height:1.6}.github h6{color:#777}.github hr{border:1px solid #e6e6e6}.github pre>code{font-size:.9em;font-family:Consolas,Inconsolata,Courier,monospace}.github blockquote>code,.github h1>code,.github h2>code,.github h3>code,.github h4>code,.github h5>code,.github h6>code,.github li>code,.github p>code,.github td>code{background-color:rgba(0,0,0,.07);font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;font-size:85%;padding:.2em .5em;border:0}.github blockquote{border-left:4px solid #e6e6e6;padding:0 15px;font-style:italic}.github table{background-color:#fafafa}.github table tr td,.github table tr th{border:1px solid #e6e6e6}.github table tr:nth-child(2n){background-color:#f2f2f2}.hljs{display:block;overflow-x:auto;padding:.5em;color:#333;background:#f8f8f8;-webkit-text-size-adjust:none}.diff .hljs-header,.hljs-comment,.hljs-javadoc{color:#998;font-style:italic}.css .rule .hljs-keyword,.hljs-keyword,.hljs-request,.hljs-status,.hljs-subst,.hljs-winutils,.nginx .hljs-title{color:#333;font-weight:700}.hljs-hexcolor,.hljs-number,.ruby .hljs-constant{color:teal}.hljs-dartdoc,.hljs-phpdoc,.hljs-string,.hljs-tag .hljs-value,.tex .hljs-formula{color:#d14}.hljs-id,.hljs-title,.scss .hljs-preprocessor{color:#900;font-weight:700}.hljs-list .hljs-keyword,.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type,.tex .hljs-command,.vhdl .hljs-literal{color:#458;font-weight:700}.django .hljs-tag .hljs-keyword,.hljs-rules .hljs-property,.hljs-tag,.hljs-tag .hljs-title{color:navy;font-weight:400}.hljs-attribute,.hljs-variable,.lisp .hljs-body{color:teal}.hljs-regexp{color:#009926}.clojure .hljs-keyword,.hljs-prompt,.hljs-symbol,.lisp .hljs-keyword,.ruby .hljs-symbol .hljs-string,.scheme .hljs-keyword,.tex .hljs-special{color:#990073}.hljs-built_in{color:#0086b3}.hljs-cdata,.hljs-doctype,.hljs-pi,.hljs-pragma,.hljs-preprocessor,.hljs-shebang{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.diff .hljs-change{background:#0086b3}.hljs-chunk{color:#aaa}.MathJax_Hover_Frame{border-radius:.25em;-webkit-border-radius:.25em;-moz-border-radius:.25em;-khtml-border-radius:.25em;box-shadow:0 0 15px #83A;-webkit-box-shadow:0 0 15px #83A;-moz-box-shadow:0 0 15px #83A;-khtml-box-shadow:0 0 15px #83A;border:1px solid #A6D!important;display:inline-block;position:absolute}.MathJax_Hover_Arrow{position:absolute;width:15px;height:11px;cursor:pointer}#MathJax_About{position:fixed;left:50%;width:auto;text-align:center;border:3px outset;padding:1em 2em;background-color:#DDD;color:#000;cursor:default;font-family:message-box;font-size:120%;font-style:normal;text-indent:0;text-transform:none;line-height:normal;letter-spacing:normal;word-spacing:normal;word-wrap:normal;white-space:nowrap;float:none;z-index:201;border-radius:15px;-webkit-border-radius:15px;-moz-border-radius:15px;-khtml-border-radius:15px;box-shadow:0 10px 20px gray;-webkit-box-shadow:0 10px 20px gray;-moz-box-shadow:0 10px 20px gray;-khtml-box-shadow:0 10px 20px gray;filter:progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}.MathJax_Menu{position:absolute;background-color:#fff;color:#000;width:auto;padding:5px 0;border:1px solid #CCC;margin:0;cursor:default;font:menu;text-align:left;text-indent:0;text-transform:none;line-height:normal;letter-spacing:normal;word-spacing:normal;word-wrap:normal;white-space:nowrap;float:none;z-index:201;border-radius:5px;-webkit-border-radius:5px;-moz-border-radius:5px;-khtml-border-radius:5px;box-shadow:0 10px 20px gray;-webkit-box-shadow:0 10px 20px gray;-moz-box-shadow:0 10px 20px gray;-khtml-box-shadow:0 10px 20px gray;filter:progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}.MathJax_MenuItem{padding:1px 2em;background:0 0}.MathJax_MenuArrow{position:absolute;right:.5em;color:#666}.MathJax_MenuActive .MathJax_MenuArrow{color:#fff}.MathJax_MenuArrow.RTL{left:.5em;right:auto}.MathJax_MenuCheck{position:absolute;left:.7em}.MathJax_MenuCheck.RTL{right:.7em;left:auto}.MathJax_MenuRadioCheck{position:absolute;left:.7em}.MathJax_MenuRadioCheck.RTL{right:.7em;left:auto}.MathJax_MenuLabel{padding:1px 2em 3px 1.33em;font-style:italic}.MathJax_MenuRule{border-top:1px solid #DDD;margin:4px 3px}.MathJax_MenuDisabled{color:GrayText}.MathJax_MenuActive{background-color:#606872;color:#fff}.MathJax_Menu_Close{position:absolute;width:31px;height:31px;top:-15px;left:-15px}#MathJax_Zoom{position:absolute;background-color:#F0F0F0;overflow:auto;display:block;z-index:301;padding:.5em;border:1px solid #000;margin:0;font-weight:400;font-style:normal;text-align:left;text-indent:0;text-transform:none;line-height:normal;letter-spacing:normal;word-spacing:normal;word-wrap:normal;white-space:nowrap;float:none;box-shadow:5px 5px 15px #AAA;-webkit-box-shadow:5px 5px 15px #AAA;-moz-box-shadow:5px 5px 15px #AAA;-khtml-box-shadow:5px 5px 15px #AAA;filter:progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}#MathJax_ZoomOverlay{position:absolute;left:0;top:0;z-index:300;display:inline-block;width:100%;height:100%;border:0;padding:0;margin:0;background-color:#fff;opacity:0;filter:alpha(opacity=0)}#MathJax_ZoomFrame{position:relative;display:inline-block;height:0;width:0}#MathJax_ZoomEventTrap{position:absolute;left:0;top:0;z-index:302;display:inline-block;border:0;padding:0;margin:0;background-color:#fff;opacity:0;filter:alpha(opacity=0)}.MathJax_Preview{color:#888}#MathJax_Message{position:fixed;left:1px;bottom:2px;background-color:#E6E6E6;border:1px solid #959595;margin:0;padding:2px 8px;z-index:102;color:#000;font-size:80%;width:auto;white-space:nowrap}#MathJax_MSIE_Frame{position:absolute;top:0;left:0;width:0;z-index:101;border:0;margin:0;padding:0}.MathJax_Error{color:#C00;font-style:italic}footer{position:fixed;font-size:.8em;text-align:right;bottom:0;margin-left:-25px;height:20px;width:100%}</style>
</head>
<body class="markdown github">
<h1 id="iteration-and-animation:-loops,-gifs,-and-videos"><a name="iteration-and-animation:-loops,-gifs,-and-videos" href="#iteration-and-animation:-loops,-gifs,-and-videos"></a>Iteration and animation: Loops, GIFs, and videos</h1><p>In today’s class, we will make animated GIFs and videos from charts made in R using <strong>ggplot2</strong>. This depends on connecting R to two software libraries, <a href="http://imagemagick.org/script/index.php"><strong>ImageMagick</strong></a> (for processing images, inlcuding GIFs), and <strong><a href="http://ffmpeg.org/">FFmpeg</a></strong> (for processing video). See the <a href="software.html">software</a> page for installation instructions.</p><h3 id="the-data-we-will-use-today"><a name="the-data-we-will-use-today" href="#the-data-we-will-use-today"></a>The data we will use today</h3><p>Download the data for this session from <a href="data/week14.zip">here</a>, unzip the folder and place it on your desktop. It contains the following folders and files:</p><ul>
<li><code>nations.csv</code> Data from the World Bank Indicators portal, as used in week 3 and subsequently.</li><li><code>warming.csv</code> <a href="http://data.giss.nasa.gov/gistemp/graphs/">NASA data</a> on the annual average global temperature, from 1880 to 2015, compared the the average from 1951-1980.</li><li><code>maps</code> Folder containing individual frames, from 1880 to 2015, each showing annual average temperatures across the globe, from 1880 to 2015, again compared the the average from 1951-1980. These were made from NASA data, using <a href="http://www.giss.nasa.gov/tools/panoply/">this software</a>.</li><li><code>charts</code> <code>combined</code> Empty folders into which we will save individual frames from which to make a video animation.</li></ul><h3 id="setting-up"><a name="setting-up" href="#setting-up"></a>Setting up</h3><p>Launch RStudio, create a new RScript, and set the working directory to the folder with your downloaded data by selecting <code>Session&gt;Set Working Directory&gt;To Source File Location</code>. Save the script as <code>week14.R</code>.</p><h4 id="install-devtools-and-gganimate-packages"><a name="install-devtools-and-gganimate-packages" href="#install-devtools-and-gganimate-packages"></a>Install devtools and gganimate packages</h4><p>We are going to animate <strong>ggplot2</strong> graphics using the <strong><a href="https://github.com/dgrtwo/gganimate">gganimate</a></strong> package, which is an <a href="https://www.ggplot2-exts.org/ggiraph.html">extension</a> to <strong>ggplot2</strong>. It depends upon ImageMagick and FFmpeg to make GIFs and videos.</p><p><strong>gganimate</strong> is available on GitHub. To install from there, you first need to install the <a href="https://github.com/hadley/devtools"><strong>devtools</strong></a> package. For all the code blocks that follow, copy them into your script and run.</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># first install devtools
install.packages(&quot;devtools&quot;)

# then gganimate
devtools::install_github(&quot;dgrtwo/gganimate&quot;)
</code></pre>"><span class="hljs-comment"># first install devtools</span>
install.packages(<span class="hljs-string">"devtools"</span>)

<span class="hljs-comment"># then gganimate</span>
devtools::install_github(<span class="hljs-string">"dgrtwo/gganimate"</span>)
</code></pre><h4 id="load-the-packages-we-will-use-today"><a name="load-the-packages-we-will-use-today" href="#load-the-packages-we-will-use-today"></a>Load the packages we will use today</h4><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># load required packages
library(readr)
library(ggplot2)
library(gganimate)
library(scales)
library(dplyr)
</code></pre>"><span class="hljs-comment"># load required packages</span>
<span class="hljs-keyword">library</span>(readr)
<span class="hljs-keyword">library</span>(ggplot2)
<span class="hljs-keyword">library</span>(gganimate)
<span class="hljs-keyword">library</span>(scales)
<span class="hljs-keyword">library</span>(dplyr)
</code></pre><p>Apart from <strong>gganimate</strong>, we have encountered all of these packages in previous weeks.</p><h3 id="make-a-gapminder-style-animated-bubble-chart"><a name="make-a-gapminder-style-animated-bubble-chart" href="#make-a-gapminder-style-animated-bubble-chart"></a>Make a Gapminder-style animated bubble chart</h3><p>In week 8, we made the following chart, showing GDP per capita, life expectancy at birth and population for the world’s nations in 2014:</p><p><img src="img/class8_23.jpg" alt=""></p><p>This was the code to generate that chart:</p><pre class="r hljs"><code class="r" data-origin="<pre><code class=&quot;r&quot;># load data
nations &amp;lt;- read_csv(&quot;nations.csv&quot;)

# filter for 2014 data only
nations2014 &amp;lt;- nations %&amp;gt;%
  filter(year == 2014)

# make bubble chart
ggplot(nations2014, aes(x = gdp_percap, y = life_expect)) +
  xlab(&quot;GDP per capita&quot;) +
  ylab(&quot;Life expectancy at birth&quot;) +
  theme_minimal(base_size = 12, base_family = &quot;Georgia&quot;) +
  geom_point(aes(size = population, color = region), alpha = 0.7) +
  scale_size_area(guide = FALSE, max_size = 15) +
  scale_x_continuous(labels = dollar) +
  stat_smooth(formula = y ~ log10(x), se = FALSE, size = 0.5, color = &quot;black&quot;, linetype=&quot;dotted&quot;) +
  scale_color_brewer(name = &quot;&quot;, palette = &quot;Set2&quot;) +
  theme(legend.position=c(0.8,0.4))
</code></pre>"><span class="hljs-comment"># load data</span>
nations &lt;- read_csv(<span class="hljs-string">"nations.csv"</span>)

<span class="hljs-comment"># filter for 2014 data only</span>
nations2014 &lt;- nations %&gt;%
  filter(year == <span class="hljs-number">2014</span>)

<span class="hljs-comment"># make bubble chart</span>
ggplot(nations2014, aes(x = gdp_percap, y = life_expect)) +
  xlab(<span class="hljs-string">"GDP per capita"</span>) +
  ylab(<span class="hljs-string">"Life expectancy at birth"</span>) +
  theme_minimal(base_size = <span class="hljs-number">12</span>, base_family = <span class="hljs-string">"Georgia"</span>) +
  geom_point(aes(size = population, color = region), alpha = <span class="hljs-number">0.7</span>) +
  scale_size_area(guide = <span class="hljs-literal">FALSE</span>, max_size = <span class="hljs-number">15</span>) +
  scale_x_continuous(labels = dollar) +
  stat_smooth(formula = y ~ log10(x), se = <span class="hljs-literal">FALSE</span>, size = <span class="hljs-number">0.5</span>, color = <span class="hljs-string">"black"</span>, linetype=<span class="hljs-string">"dotted"</span>) +
  scale_color_brewer(name = <span class="hljs-string">""</span>, palette = <span class="hljs-string">"Set2"</span>) +
  theme(legend.position=c(<span class="hljs-number">0.8</span>,<span class="hljs-number">0.4</span>))
</code></pre><p>Some reminders about what this code does:</p><ul>
<li><p><code>scale_size_area</code> ensures that the size of the circles scales by their area according to the population data, up to the specified <code>max_size</code>; <code>guide = FALSE</code> within the brackets of this function prevents a legend for size being drawn.</p>
</li><li><p><code>labels = dollar</code> from <strong>scales</strong> formats the X axis labels as currency in dollars.</p>
</li><li><p><code>stat_smooth</code> works like <code>geom_smooth</code> but allows you to use a <code>formula</code> to specify the type of curve to use for to trend line fitted to the data, here a logarithmic curve.</p>
</li></ul><p>Now we will use <strong>gganimate</strong> to generate an animation of the chart, from 1990 to 2014. Here is the code:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;>nations_chart &amp;lt;- ggplot(nations, aes(x = gdp_percap, y = life_expect, frame = year)) +
  xlab(&quot;GDP per capita&quot;) +
  ylab(&quot;Life expectancy at birth&quot;) +
  theme_minimal(base_size = 16, base_family = &quot;Georgia&quot;) +
  geom_point(aes(size = population, color = region), alpha = 0.7) +
  scale_size_area(guide = FALSE, max_size = 20) +
  scale_x_continuous(labels = dollar) +
  stat_smooth(aes(group = year), formula = y ~ log10(x), se = FALSE, size = 0.5, color = &quot;black&quot;, linetype=&quot;dotted&quot;) +
  scale_color_brewer(name = &quot;&quot;, palette = &quot;Set2&quot;) +
  theme(legend.position=c(0.8,0.4))
</code></pre>">nations_chart &lt;- ggplot(nations, aes(x = gdp_percap, y = life_expect, frame = year)) +
  xlab(<span class="hljs-string">"GDP per capita"</span>) +
  ylab(<span class="hljs-string">"Life expectancy at birth"</span>) +
  theme_minimal(base_size = <span class="hljs-number">16</span>, base_family = <span class="hljs-string">"Georgia"</span>) +
  geom_point(aes(size = population, color = region), alpha = <span class="hljs-number">0.7</span>) +
  scale_size_area(guide = <span class="hljs-literal">FALSE</span>, max_size = <span class="hljs-number">20</span>) +
  scale_x_continuous(labels = dollar) +
  stat_smooth(aes(group = year), formula = y ~ log10(x), se = <span class="hljs-literal">FALSE</span>, size = <span class="hljs-number">0.5</span>, color = <span class="hljs-string">"black"</span>, linetype=<span class="hljs-string">"dotted"</span>) +
  scale_color_brewer(name = <span class="hljs-string">""</span>, palette = <span class="hljs-string">"Set2"</span>) +
  theme(legend.position=c(<span class="hljs-number">0.8</span>,<span class="hljs-number">0.4</span>))
</code></pre><p>Running this code will create an R object of type <code>gg</code> called <code>nations_chart</code>.</p><p>Now display it in the <code>Viewer</code> panel by running the following:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;>gg_animate(nations_chart)
</code></pre>">gg_animate(nations_chart)
</code></pre><p>This should be the result:</p><p><img src="img/nations.gif" alt=""></p><h4 id="how-the-code-works"><a name="how-the-code-works" href="#how-the-code-works"></a>How the code works</h4><p>I made a couple of small changes to the <strong>ggplot2</strong> code from the static graphic to optimise the appearance of the animation, increasing both the <code>base_size</code> for the text, and the <code>max_size</code> for the scaled circles.</p><p>The most important change, however, is in the initial <code>ggplot()</code> function, which now includes <code>frame = year</code>. In the animation, this is the code that creates a separate chart for each year in the data.</p><p>Also notice that the code that creates the trend line now includes <code>aes(group = year)</code>. This is needed if we want to create a separate trend line for each year. Without this, a single trend line would be calculated for all the data across all the years, and would be static across the animation.</p><h4 id="save-as-a-gif-and-a-video"><a name="save-as-a-gif-and-a-video" href="#save-as-a-gif-and-a-video"></a>Save as a GIF and a video</h4><p>Having made an animation, we can now save it as a GIF or a video:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># save as a GIF
gg_animate(nations_chart, &quot;nations.gif&quot;, ani.width = 750, ani.height = 500, interval = 0.2)

# save as a video 
gg_animate(nations_chart, &quot;nations.mp4&quot;, ani.width = 1600, ani.height = 900, interval = 0.1)
</code></pre>"><span class="hljs-comment"># save as a GIF</span>
gg_animate(nations_chart, <span class="hljs-string">"nations.gif"</span>, ani.width = <span class="hljs-number">750</span>, ani.height = <span class="hljs-number">500</span>, interval = <span class="hljs-number">0.2</span>)

<span class="hljs-comment"># save as a video </span>
gg_animate(nations_chart, <span class="hljs-string">"nations.mp4"</span>, ani.width = <span class="hljs-number">1600</span>, ani.height = <span class="hljs-number">900</span>, interval = <span class="hljs-number">0.1</span>)
</code></pre><p>You can use the options <code>ani.width</code> and <code>ani.height</code> to set the dimensions, in pixels, of the animation; <code>interval</code> sets the interval between the frames, in seconds (the default is 1 second). For the video, I have set the ratio between width and height at 16:9, consistent with YouTube and Vimeo format.</p><p>Here is the video:</p><p>[embed goes here]</p><h3 id="make-a-cumulative-animation-of-historical-global-average-temperature"><a name="make-a-cumulative-animation-of-historical-global-average-temperature" href="#make-a-cumulative-animation-of-historical-global-average-temperature"></a>Make a cumulative animation of historical global average temperature</h3><p>For the Gapminder-style video, we displayed only the data for the year in question in each frame. In some cases, however, you may want to animate by adding data with each frame, and leaving the previously added data in place.</p><p>We will explore that now by making an animation of the dot-and-line chart in this video.</p><p>Here is the code to make a static version of the chart:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># load data
warming &amp;lt;- read_csv(&quot;warming.csv&quot;)

# set color palette and sequence of values to apply it to
pal &amp;lt;- c(&quot;#313695&quot;,&quot;#4575b4&quot;,&quot;#74add1&quot;,&quot;#abd9e9&quot;,&quot;#e0f3f8&quot;,&quot;#ffffbf&quot;,&quot;#fee090&quot;,&quot;#fdae61&quot;,&quot;#f46d43&quot;,&quot;#d73027&quot;,&quot;#a50026&quot;)
vals &amp;lt;- seq(-2, 2, length = 11)

# draw chart
ggplot(warming, aes(x = year, y = annual)) +
  geom_line(colour=&quot;black&quot;) +
  geom_point(shape = 21, colour=&quot;black&quot;, aes(fill=annual), size=5, stroke=1) +
  scale_x_continuous(limits=c(1880,2015)) +
  scale_y_continuous(limits=c(-0.5,1)) +
  theme_minimal() +
  scale_fill_gradientn(colors = pal, values = vals, rescaler = function(x, ...) x, oob = identity, guide=FALSE) +
  xlab(&quot;&quot;) +
  ylab(&quot;Difference from 1951-1980 (ºC)&quot;) +
  theme(text=element_text(size=16, family=&quot;Georgia&quot;))
</code></pre>"><span class="hljs-comment"># load data</span>
warming &lt;- read_csv(<span class="hljs-string">"warming.csv"</span>)

<span class="hljs-comment"># set color palette and sequence of values to apply it to</span>
pal &lt;- c(<span class="hljs-string">"#313695"</span>,<span class="hljs-string">"#4575b4"</span>,<span class="hljs-string">"#74add1"</span>,<span class="hljs-string">"#abd9e9"</span>,<span class="hljs-string">"#e0f3f8"</span>,<span class="hljs-string">"#ffffbf"</span>,<span class="hljs-string">"#fee090"</span>,<span class="hljs-string">"#fdae61"</span>,<span class="hljs-string">"#f46d43"</span>,<span class="hljs-string">"#d73027"</span>,<span class="hljs-string">"#a50026"</span>)
vals &lt;- seq(-<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, length = <span class="hljs-number">11</span>)

<span class="hljs-comment"># draw chart</span>
ggplot(warming, aes(x = year, y = annual)) +
  geom_line(colour=<span class="hljs-string">"black"</span>) +
  geom_point(shape = <span class="hljs-number">21</span>, colour=<span class="hljs-string">"black"</span>, aes(fill=annual), size=<span class="hljs-number">5</span>, stroke=<span class="hljs-number">1</span>) +
  scale_x_continuous(limits=c(<span class="hljs-number">1880</span>,<span class="hljs-number">2015</span>)) +
  scale_y_continuous(limits=c(-<span class="hljs-number">0.5</span>,<span class="hljs-number">1</span>)) +
  theme_minimal() +
  scale_fill_gradientn(colors = pal, values = vals, rescaler = <span class="hljs-keyword">function</span>(x, <span class="hljs-keyword">...</span>) x, oob = identity, guide=<span class="hljs-literal">FALSE</span>) +
  xlab(<span class="hljs-string">""</span>) +
  ylab(<span class="hljs-string">"Difference from 1951-1980 (ºC)"</span>) +
  theme(text=element_text(size=<span class="hljs-number">16</span>, family=<span class="hljs-string">"Georgia"</span>))
</code></pre><p>This should be the result:</p><p><img src="img/warming.jpeg" alt=""></p><p>The file <code>warming.csv</code> contains the fields <code>year</code> and <code>annual</code>, the latter being the global annual average temperature, compared to the 1951-1980 average.</p><p>This code uses a palette of colors running from cool blues, through neutral yellows, to warm reds, and applies them to a sequence of values running from -2 to +2. This is so the chart uses the same color palette as the maps we will animate later on, and combine with the chart. </p><p>The palette is then applied with the function <code>scale_fill_gradientn()</code>, see <a href="http://docs.ggplot2.org/0.9.2.1/scale_gradientn.html">here</a> for more, including the scaling of the colors against the supplied values.</p><p>As this is a dot-and-line chart, it includes both <code>geom_line()</code> and <code>geom_point()</code> layers. Notice that the <code>geom_point()</code> function also defines a numbered <code>shape</code>: <code>21</code> is a circle with a filled area, see <a href="www.cookbook-r.com/Graphs/Shapes_and_line_types/">here</a> for other options. By using this shape, we can set the outline <code>color</code> to black and then use an <code>aes</code> mapping to fill it with color from the selected palette, according to the values for the <code>annual</code> variable.</p><p>To animate this chart, adding a year with each frame, use the following code:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># create the animation
warming_chart &amp;lt;- ggplot(warming, aes(x = year, y = annual, frame = year, cumulative = TRUE)) +
  geom_line(colour=&quot;black&quot;) +
  geom_point(shape = 21, colour=&quot;black&quot;, aes(fill=annual), size=5, stroke=1) +
  scale_x_continuous(limits=c(1880,2015)) +
  scale_y_continuous(limits=c(-0.5,1)) +
  theme_minimal() +
  scale_fill_gradientn(colors = pal, values = vals, rescaler = function(x, ...) x, oob = identity, guide=FALSE) +
  xlab(&quot;&quot;) +
  ylab(&quot;Difference from 1951-1980 (ºC)&quot;) +
  theme(text=element_text(size=16, family=&quot;Georgia&quot;))

# run in the viewer
gg_animate(warming_chart, interval = 0.1)
</code></pre>"><span class="hljs-comment"># create the animation</span>
warming_chart &lt;- ggplot(warming, aes(x = year, y = annual, frame = year, cumulative = <span class="hljs-literal">TRUE</span>)) +
  geom_line(colour=<span class="hljs-string">"black"</span>) +
  geom_point(shape = <span class="hljs-number">21</span>, colour=<span class="hljs-string">"black"</span>, aes(fill=annual), size=<span class="hljs-number">5</span>, stroke=<span class="hljs-number">1</span>) +
  scale_x_continuous(limits=c(<span class="hljs-number">1880</span>,<span class="hljs-number">2015</span>)) +
  scale_y_continuous(limits=c(-<span class="hljs-number">0.5</span>,<span class="hljs-number">1</span>)) +
  theme_minimal() +
  scale_fill_gradientn(colors = pal, values = vals, rescaler = <span class="hljs-keyword">function</span>(x, <span class="hljs-keyword">...</span>) x, oob = identity, guide=<span class="hljs-literal">FALSE</span>) +
  xlab(<span class="hljs-string">""</span>) +
  ylab(<span class="hljs-string">"Difference from 1951-1980 (ºC)"</span>) +
  theme(text=element_text(size=<span class="hljs-number">16</span>, family=<span class="hljs-string">"Georgia"</span>))

<span class="hljs-comment"># run in the viewer</span>
gg_animate(warming_chart, interval = <span class="hljs-number">0.1</span>)
</code></pre><p>This time, the initial <code>ggplot()</code> function also contains the code <code>cumulative = TRUE</code>, which adds one year of data with each frame, and leaves the previously added data in place.</p><p>This should be the result:</p><p><img src="img/warming.gif" alt=""></p><p>Again, we can save as GIF and video:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># save as GIF and video
gg_animate(warming_chart, &quot;warming.gif&quot;, ani.width = 750, ani.height = 500, interval = 0.1)
gg_animate(warming_chart, &quot;warming.mp4&quot;, ani.width = 1600, ani.height = 900, interval = 0.1)
</code></pre>"><span class="hljs-comment"># save as GIF and video</span>
gg_animate(warming_chart, <span class="hljs-string">"warming.gif"</span>, ani.width = <span class="hljs-number">750</span>, ani.height = <span class="hljs-number">500</span>, interval = <span class="hljs-number">0.1</span>)
gg_animate(warming_chart, <span class="hljs-string">"warming.mp4"</span>, ani.width = <span class="hljs-number">1600</span>, ani.height = <span class="hljs-number">900</span>, interval = <span class="hljs-number">0.1</span>)
</code></pre><h3 id="combine-the-chart-with-maps-to-make-a-composite-animation-of-the-historical-temperature-record"><a name="combine-the-chart-with-maps-to-make-a-composite-animation-of-the-historical-temperature-record" href="#combine-the-chart-with-maps-to-make-a-composite-animation-of-the-historical-temperature-record"></a>Combine the chart with maps to make a composite animation of the historical temperature record</h3><p>To replicate <a href="https://www.facebook.com/BuzzFeedScience/videos/753675331429028/">this video</a>, shown above, we need to combine the maps in the <code>maps</code> folder with individual images of each frame of the chart. So rather than using <code>gganimate</code>, we will now write a <strong>for loop</strong> to save the individual frames.</p><h4 id="for-loops:-how-they-work"><a name="for-loops:-how-they-work" href="#for-loops:-how-they-work"></a>For loops: how they work</h4><p>This code should help explain how a for loop works:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># make a list of years, from 1880 to 2015
years &amp;lt;- c(1880:2015)

# for loop to print each year to the console, pausing for one second each time
for (y in years) {
  print(y)
  Sys.sleep(1) 
}
</code></pre>"><span class="hljs-comment"># make a list of years, from 1880 to 2015</span>
years &lt;- c(<span class="hljs-number">1880</span>:<span class="hljs-number">2015</span>)

<span class="hljs-comment"># for loop to print each year to the console, pausing for one second each time</span>
<span class="hljs-keyword">for</span> (y <span class="hljs-keyword">in</span> years) {
  print(y)
  Sys.sleep(<span class="hljs-number">1</span>) 
}
</code></pre><p>The output should begin:</p><pre class="css hljs"><code class="CSS" data-origin="<pre><code class=&quot;CSS&quot;>[1] 1880
[1] 1881
[1] 1882
[1] 1883
[1] 1884
[1] 1885
[1] 1886
[1] 1887
</code></pre>"><span class="hljs-attr_selector">[1]</span> 1880
<span class="hljs-attr_selector">[1]</span> 1881
<span class="hljs-attr_selector">[1]</span> 1882
<span class="hljs-attr_selector">[1]</span> 1883
<span class="hljs-attr_selector">[1]</span> 1884
<span class="hljs-attr_selector">[1]</span> 1885
<span class="hljs-attr_selector">[1]</span> 1886
<span class="hljs-attr_selector">[1]</span> 1887
</code></pre><p>The first line of code creates a list of integers, from 1880 to 2015, as an R object called <code>years</code>.</p><p>This part of the code iterates through each entry in the list: <code>for (y in years)</code>.</p><p>For each iteration, it executes the code in the curly brackets, which here prints <code>y</code>, and then pauses for a second.</p><h4 id="use-a-for-loop-to-draw-and-save-a-chart-for-each-year"><a name="use-a-for-loop-to-draw-and-save-a-chart-for-each-year" href="#use-a-for-loop-to-draw-and-save-a-chart-for-each-year"></a>Use a for loop to draw and save a chart for each year</h4><p>This code uses the same principle to draw and save a chart for each year:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># make a list of years, from 1880 to 2015
years &amp;lt;- c(1880:2015)

# loop to make a chart for each year
for (y in years) {
  tmp &amp;lt;- warming %&amp;gt;%
    filter(year &amp;lt;= y)
  chart &amp;lt;- ggplot(tmp, aes(x=year,y=annual)) %&amp;gt;%
    + geom_line(colour=&quot;black&quot;) %&amp;gt;%
    + geom_point(shape = 21, colour=&quot;black&quot;, aes(fill=annual), size=5, stroke=1) %&amp;gt;%
    + scale_x_continuous(limits=c(1880,2015)) %&amp;gt;%
    + scale_y_continuous(limits=c(-0.5,1)) %&amp;gt;%
    + theme_minimal() %&amp;gt;%
    + scale_fill_gradientn(colors = pal, values=vals, rescaler = function(x, ...) x, oob = identity, guide=FALSE) %&amp;gt;%
    + xlab(&quot;&quot;) %&amp;gt;%
    + ylab(&quot;Difference from 1951-1980 (ºC)&quot;) %&amp;gt;%
    + theme(text=element_text(size=16,family=&quot;Georgia&quot;))
  ggsave(file=paste0(&quot;charts/&quot;,y,&quot;.jpg&quot;), plot = chart, width = 8, height = 4.5, units = &quot;in&quot;, dpi=300)
  print(paste0(&quot;processing: &quot;,y))
}
</code></pre>"><span class="hljs-comment"># make a list of years, from 1880 to 2015</span>
years &lt;- c(<span class="hljs-number">1880</span>:<span class="hljs-number">2015</span>)

<span class="hljs-comment"># loop to make a chart for each year</span>
<span class="hljs-keyword">for</span> (y <span class="hljs-keyword">in</span> years) {
  tmp &lt;- warming %&gt;%
    filter(year &lt;= y)
  chart &lt;- ggplot(tmp, aes(x=year,y=annual)) %&gt;%
    + geom_line(colour=<span class="hljs-string">"black"</span>) %&gt;%
    + geom_point(shape = <span class="hljs-number">21</span>, colour=<span class="hljs-string">"black"</span>, aes(fill=annual), size=<span class="hljs-number">5</span>, stroke=<span class="hljs-number">1</span>) %&gt;%
    + scale_x_continuous(limits=c(<span class="hljs-number">1880</span>,<span class="hljs-number">2015</span>)) %&gt;%
    + scale_y_continuous(limits=c(-<span class="hljs-number">0.5</span>,<span class="hljs-number">1</span>)) %&gt;%
    + theme_minimal() %&gt;%
    + scale_fill_gradientn(colors = pal, values=vals, rescaler = <span class="hljs-keyword">function</span>(x, <span class="hljs-keyword">...</span>) x, oob = identity, guide=<span class="hljs-literal">FALSE</span>) %&gt;%
    + xlab(<span class="hljs-string">""</span>) %&gt;%
    + ylab(<span class="hljs-string">"Difference from 1951-1980 (ºC)"</span>) %&gt;%
    + theme(text=element_text(size=<span class="hljs-number">16</span>,family=<span class="hljs-string">"Georgia"</span>))
  ggsave(file=paste0(<span class="hljs-string">"charts/"</span>,y,<span class="hljs-string">".jpg"</span>), plot = chart, width = <span class="hljs-number">8</span>, height = <span class="hljs-number">4.5</span>, units = <span class="hljs-string">"in"</span>, dpi=<span class="hljs-number">300</span>)
  print(paste0(<span class="hljs-string">"processing: "</span>,y))
}
</code></pre><h4 id="what-this-code-does"><a name="what-this-code-does" href="#what-this-code-does"></a>What this code does</h4><p>For each year, <code>y</code>, the code first makes an R object called <code>tmp</code>, which is the <code>warming</code> data frame, filtered for all years equal or less to <code>y</code>.</p><p>Then it creates an R object called <code>chart</code>, which is a static <strong>ggplot2</strong> chart drawn from that data.</p><p>It then saves that chart using the <code>ggsave()</code> function, at the defined dimensions and resolution, before printing a message to the R console giving a progress update on the loop.</p><p>This code makes use of an R function called <code>paste0()</code>. It is the equivalent of <code>=concatenate()</code> in a spreadsheet formula, appending text into a single string. The elements to be combined are separated by commas, and can be either text, written in quote marks, or a named variable or object that contains text, or a number that can be rendered as text.</p><p>So when <code>y</code> is <code>1880</code>, <code>(paste0("charts/",y,".jpg")</code> is <code>"charts/1880.jpg"</code>. This is how the individual charts get saved with the appropriate names in the <code>charts</code> folder.</p><h4 id="combine-the-charts-and-maps-into-a-single-frame-for-each-year"><a name="combine-the-charts-and-maps-into-a-single-frame-for-each-year" href="#combine-the-charts-and-maps-into-a-single-frame-for-each-year"></a>Combine the charts and maps into a single frame for each year</h4><p>Again, we will use a for loop. This time the loop will be written in R, but it will send ImageMagick code to your wider system using the <code>system()</code> function. It has same effect as if you ran each line of ImageMagick code in the Terminal.</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># combine the maps and charts with ImageMagick, add year label to each frame
for (y in years) {
  system(paste0(&quot;convert charts/&quot;,y,&quot;.jpg maps/map&quot;,y,&quot;.jpg -geometry +305+72 -composite -pointsize 100 -font Georgia -annotate +2000+1120 &quot;,y,&quot; combined/img&quot;,y,&quot;.jpg&quot;))
  print(paste0(&quot;processing: &quot;,y))
}
</code></pre>"><span class="hljs-comment"># combine the maps and charts with ImageMagick, add year label to each frame</span>
<span class="hljs-keyword">for</span> (y <span class="hljs-keyword">in</span> years) {
  system(paste0(<span class="hljs-string">"convert charts/"</span>,y,<span class="hljs-string">".jpg maps/map"</span>,y,<span class="hljs-string">".jpg -geometry +305+72 -composite -pointsize 100 -font Georgia -annotate +2000+1120 "</span>,y,<span class="hljs-string">" combined/img"</span>,y,<span class="hljs-string">".jpg"</span>))
  print(paste0(<span class="hljs-string">"processing: "</span>,y))
}
</code></pre><p>Here’s what the ImageMagick code looks like when <code>y</code> is 1880:</p><pre class="sql hljs"><code class="SQL" data-origin="<pre><code class=&quot;SQL&quot;>convert charts/1880.jpg maps/map1880.jpg -geometry +305+68 -composite -pointsize 100 -font Georgia -annotate +2000+1120 1880 combined/img1880.jpg
</code></pre>">convert charts/1880.jpg maps/map1880.jpg -geometry +305+68 -composite -pointsize 100 -font Georgia -annotate +2000+1120 1880 combined/img1880.jpg
</code></pre><p><code>convert</code> is one of the main commands in ImageMagick, used to convert between image formats as well as to manipulate images in a variety of ways.</p><p>This part of the code takes the two named files, and creates a composite, layering the second over the first with its top left hand corner 305 pixels from the left and 68 pixels from the top of the image:</p><pre class="sql hljs"><code class="SQL" data-origin="<pre><code class=&quot;SQL&quot;>charts/1880.jpg maps/map1880.jpg -geometry +305+68 -composite
</code></pre>">charts/1880.jpg maps/map1880.jpg -geometry +305+68 -composite
</code></pre><p>This part of the code adds an annotation with the text “1880” to the image, 2000 pixels from the left and 1200 pixels from the top, with the defined size and font face:</p><pre class="sql hljs"><code class="SQL" data-origin="<pre><code class=&quot;SQL&quot;>-pointsize 100 -font Georgia -annotate +2000+1120 1880
</code></pre>">-pointsize 100 -font Georgia -annotate +2000+1120 1880
</code></pre><p>Finally, this completes the <code>convert</code> command, saving the result as a new file in the <code>combined</code> folder:</p><pre class="sql hljs"><code class="SQL" data-origin="<pre><code class=&quot;SQL&quot;>combined/img1880.jpg
</code></pre>">combined/img1880.jpg
</code></pre><p>See <a href="https://www.imagemagick.org/script/convert.php">here</a> for ImageMagick <code>convert</code> options; <a href="https://www.imagemagick.org/script/command-line-tools.php">here</a>, <a href="https://www.imagemagick.org/script/command-line-processing.php">here</a>, and <a href="https://www.imagemagick.org/script/index.php">here</a> for more on using the library.</p><h4 id="combine-the-frames-into-a-gif-and-video"><a name="combine-the-frames-into-a-gif-and-video" href="#combine-the-frames-into-a-gif-and-video"></a>Combine the frames into a GIF and video</h4><p>First make a GIF with ImageMagick:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># make a GIF with ImageMagick
system(&quot;convert -delay 10 combined/*.jpg warming2.gif&quot;)
</code></pre>"><span class="hljs-comment"># make a GIF with ImageMagick</span>
system(<span class="hljs-string">"convert -delay 10 combined/*.jpg warming2.gif"</span>)
</code></pre><p>This code creates a GIF called <code>warming2.gif</code> ; <code>-delay</code> defines the interval between each frame in hundredths of a second, so here the delay is 0.1 seconds.</p><p>Now make a video with FFmpeg:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># make a video with FFmpeg
system(&quot;ffmpeg -f image2 -start_number 1880 -i combined/img%d.jpg -vf 'scale=trunc(iw/2)*2:trunc(ih/2)*2' -b 64000k warming2.mp4&quot;)
</code></pre>"><span class="hljs-comment"># make a video with FFmpeg</span>
system(<span class="hljs-string">"ffmpeg -f image2 -start_number 1880 -i combined/img%d.jpg -vf 'scale=trunc(iw/2)*2:trunc(ih/2)*2' -b 64000k warming2.mp4"</span>)
</code></pre><p>This code combined the images into a video called <code>warming2.mp4</code>.</p><p>Don’t worry too much about the details of this code, other than to know that it works. </p><p><code>image2</code> creates a video from a sequence of images. Here the code looks for files with the format <code>combined/img%d.jpg</code>, where <code>%d</code> is an integer, starting at <code>1880</code>; <code>%03d</code> would look for file names ending with a number with three decimal places, for example <code>combined/img.001.jpg</code>. </p><p><code>-r</code> defines the frame rate, in frames per second.</p><p>Having made a video, you can change its speed like this:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># change the speed of the video
system(&quot;ffmpeg -i warming2.mp4 -vf 'setpts=2*PTS' warming3.mp4&quot;)
</code></pre>"><span class="hljs-comment"># change the speed of the video</span>
system(<span class="hljs-string">"ffmpeg -i warming2.mp4 -vf 'setpts=2*PTS' warming3.mp4"</span>)
</code></pre><p>This code creates a new video with half the speed of the first; <code>'setpts=4*PTS'</code> would run at a  quarter of the speed, and so on.</p><p>See <a href="http://ffmpeg.org/documentation.html">here</a> for full documentation for FFmpeg.</p><h4 id="create-smoother-animations,-using-tweenr"><a name="create-smoother-animations,-using-tweenr" href="#create-smoother-animations,-using-tweenr"></a>Create smoother animations, using tweenr</h4><p>Look back at the first GIF we made from the <code>nations</code> data. Wouldn’t it be nicer if all the points moved smoothly, rather than jolting from year to year? It is possible to achieve this effect, using an R package called <strong><a href="https://cran.r-project.org/web/packages/tweenr/tweenr.pdf">tweenr</a></strong>, which can “interpolate” data — provide the “missing” values — for an animation with more frames.</p><p>First, install and load <strong>tweenr</strong></p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># install and load tweenr
install.packages(&quot;tweenr&quot;)
library(tweenr)
</code></pre>"><span class="hljs-comment"># install and load tweenr</span>
install.packages(<span class="hljs-string">"tweenr"</span>)
<span class="hljs-keyword">library</span>(tweenr)
</code></pre><p>To interpolate data using <strong>tweenr’s</strong> <code>tween_elements()</code> function, first create a data frame with the fields <code>x</code> for the co-ordinate on the X axis, <code>y</code> for the co-ordinate on the y axis, <code>time</code> for the data that will be used to make the frames, and <code>id</code> for the unique identifier for each point. You also need a variable called <code>ease</code>, which defines the method to use for the interpolation: <code>"linear"</code> will achieve a smooth, steady animation.</p><p>This code prepares the nations data:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># prepare data
nations_edit &amp;lt;- nations %&amp;gt;%
  arrange(country, year) %&amp;gt;%
  select(gdp_percap,life_expect,year,country) %&amp;gt;%
  rename(x=gdp_percap,y=life_expect,time=year,id=country) %&amp;gt;%
  mutate(ease=&quot;linear&quot;)
</code></pre>"><span class="hljs-comment"># prepare data</span>
nations_edit &lt;- nations %&gt;%
  arrange(country, year) %&gt;%
  select(gdp_percap,life_expect,year,country) %&gt;%
  rename(x=gdp_percap,y=life_expect,time=year,id=country) %&gt;%
  mutate(ease=<span class="hljs-string">"linear"</span>)
</code></pre><p>The new data frame <code>nations_edit</code> should look like this:</p><p><img src="img/class14_1.jpg" alt=""></p><p>Now run the tween:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># tween
nations_tween &amp;lt;- tween_elements(nations_edit, &quot;time&quot;, &quot;id&quot;, &quot;ease&quot;, nframes = 300)
</code></pre>"><span class="hljs-comment"># tween</span>
nations_tween &lt;- tween_elements(nations_edit, <span class="hljs-string">"time"</span>, <span class="hljs-string">"id"</span>, <span class="hljs-string">"ease"</span>, nframes = <span class="hljs-number">300</span>)
</code></pre><p>The new data frame <code>nations_tween</code> should look like this:</p><p><img src="img/class14_2.jpg" alt=""></p><p>The function <code>tween_elements()</code> creates new variables called <code>.frame</code>, one for each of the specified number of frames, and <code>.group</code>, which corresponds to the <code>id</code> in the previous data frame, here the country names. It calculates new <code>x</code>, <code>y</code>, and <code>time</code> values for each frame. Scroll down and you will see that many of the <code>time</code> values now include decimal fractions.</p><p>To make the animated chart, we need to join to the original data, which means creating <code>year</code> and <code>country</code> variables, to match against the original data:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># create year and country fields, for join
nations_tween &amp;lt;- nations_tween %&amp;gt;%
  mutate(year = round(time),
         country = .group)
</code></pre>"><span class="hljs-comment"># create year and country fields, for join</span>
nations_tween &lt;- nations_tween %&gt;%
  mutate(year = round(time),
         country = .group)
</code></pre><p>The data should now look like this:</p><p><img src="img/class14_3.jpg" alt=""></p><p>Now run the join:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># join
nations_tween &amp;lt;- inner_join(nations_tween,nations)
</code></pre>"><span class="hljs-comment"># join</span>
nations_tween &lt;- inner_join(nations_tween,nations)
</code></pre><p>The data should now look like this:</p><p><img src="img/class14_4.jpg" alt=""></p><p>Now we can make the animated chart using <strong>gganimate</strong>:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># make animated chart
nations_tween_chart &amp;lt;- ggplot(nations_tween, aes(x = x, y = y, frame = .frame)) +
  xlab(&quot;GDP per capita&quot;) +
  ylab(&quot;Life expectancy at birth&quot;) +
  theme_minimal(base_size = 16, base_family = &quot;Georgia&quot;) +
  geom_point(aes(size = population, color = region), alpha = 0.7) +
  scale_size_area(guide = FALSE, max_size = 20) +
  scale_x_continuous(labels = dollar) +
  scale_color_brewer(name = &quot;&quot;, palette = &quot;Set2&quot;) +
  theme(legend.position=c(0.8,0.4))

# run in the viewer
gg_animate(nations_tween_chart, title_frame = FALSE, interval = 0.05)
</code></pre>"><span class="hljs-comment"># make animated chart</span>
nations_tween_chart &lt;- ggplot(nations_tween, aes(x = x, y = y, frame = .frame)) +
  xlab(<span class="hljs-string">"GDP per capita"</span>) +
  ylab(<span class="hljs-string">"Life expectancy at birth"</span>) +
  theme_minimal(base_size = <span class="hljs-number">16</span>, base_family = <span class="hljs-string">"Georgia"</span>) +
  geom_point(aes(size = population, color = region), alpha = <span class="hljs-number">0.7</span>) +
  scale_size_area(guide = <span class="hljs-literal">FALSE</span>, max_size = <span class="hljs-number">20</span>) +
  scale_x_continuous(labels = dollar) +
  scale_color_brewer(name = <span class="hljs-string">""</span>, palette = <span class="hljs-string">"Set2"</span>) +
  theme(legend.position=c(<span class="hljs-number">0.8</span>,<span class="hljs-number">0.4</span>))

<span class="hljs-comment"># run in the viewer</span>
gg_animate(nations_tween_chart, title_frame = <span class="hljs-literal">FALSE</span>, interval = <span class="hljs-number">0.05</span>)
</code></pre><p>This should be the result:</p><p><img src="img/nations2.gif" alt=""></p><p>Notice that the <code>gg_animate()</code> function this time includes <code>title_frame = FALSE</code>, which prevents the frame number being shown on each chart. In practice, you would want to display the year on each frame, rather than the frame numbers, which are not informative in this case.</p><p>This is best done with ImageMagick. So rather than using <strong>gganimate</strong>, after creating the tweened data frame <code>nations_tween</code> and joining to the original data, you might instead generate individual image files for each frame using a loop, and then annotate each one.</p><p>In this case there are 12 frames for each year, so you would need to annotate the first 12 frames with “1990”, the next 12 with “1991,” and so on.</p><p>You could do that like this, assuming a list <code>frames</code> with each of the frame numbers, and a folder called <code>edited</code> to save the annotated frames:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># add labels for year
for (f in frames[1:12]) {
  system(paste0(&quot;convert charts/&quot;,f,&quot;.jpg pointsize 100 -font Georgia -annotate +2000+1120 1990 edited/img&quot;,f,&quot;.jpg&quot;))
  print(paste0(&quot;processing: &quot;,f))
}

for (f in frames[13:24]) {
  system(paste0(&quot;convert charts/&quot;,f,&quot;.jpg pointsize 100 -font Georgia -annotate +2000+1120 1991 edited/img&quot;,f,&quot;.jpg&quot;))
  print(paste0(&quot;processing: &quot;,f))
}

# and so on
</code></pre>"><span class="hljs-comment"># add labels for year</span>
<span class="hljs-keyword">for</span> (f <span class="hljs-keyword">in</span> frames[<span class="hljs-number">1</span>:<span class="hljs-number">12</span>]) {
  system(paste0(<span class="hljs-string">"convert charts/"</span>,f,<span class="hljs-string">".jpg pointsize 100 -font Georgia -annotate +2000+1120 1990 edited/img"</span>,f,<span class="hljs-string">".jpg"</span>))
  print(paste0(<span class="hljs-string">"processing: "</span>,f))
}

<span class="hljs-keyword">for</span> (f <span class="hljs-keyword">in</span> frames[<span class="hljs-number">13</span>:<span class="hljs-number">24</span>]) {
  system(paste0(<span class="hljs-string">"convert charts/"</span>,f,<span class="hljs-string">".jpg pointsize 100 -font Georgia -annotate +2000+1120 1991 edited/img"</span>,f,<span class="hljs-string">".jpg"</span>))
  print(paste0(<span class="hljs-string">"processing: "</span>,f))
}

<span class="hljs-comment"># and so on</span>
</code></pre><h3 id="further-reading/resources"><a name="further-reading/resources" href="#further-reading/resources"></a>Further reading/resources</h3><p><a href="http://www.imagemagick.org/Usage/">ImageMagick examples</a></p><p><a href="https://ffmpeg.org/ffmpeg.html">FFmpeg documentation</a></p>

<footer style="position:fixed; font-size:.8em; text-align:right; bottom:0px; margin-left:-25px; height:20px; width:100%;">generated by <a href="http://pad.haroopress.com" target="_blank">haroopad</a></footer>
</body>
</html>
