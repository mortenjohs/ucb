<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>Making static graphics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="../../css/bootstrap.min.css" rel="stylesheet"> 
  <link href="../../css/custom.css" rel="stylesheet">
</head>

<body class="markdown clearness">

	<header class="navbar-inverse navbar-fixed-top">
		<div class="container">
			<nav role="navigation">
				<div class="navbar-header">
					<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
						<span class="sr-only">Toggle navigation</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<a href="index.html" class="navbar-brand">Intro Data Viz</a>
				</div> <!-- /.navbar-header -->
				<!-- Collect the nav links, forms, and other content for toggling -->
				<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
					<ul class="nav navbar-nav">
						<li class="dropdown">
							<a href="#" class="dropdown-toggle" data-toggle="dropdown">Students <b class="caret"></b></a>
							<ul class="dropdown-menu">
								<li><a href="name1.html">Mark Boyer</a></li>
								<li><a href="name2.html">Jennifer Chaussee</a></li>
								<li><a href="name4.html">Andy Mannix</a></li>
								<li><a href="name5.html">Juan Martinez</a></li>
								<li><a href="name6.html">Jake Nicol</a></li>
								<li><a href="name7.html">Jason Paladino</a></li>
								<li><a href="name8.html">Joaquin Palomino</a></li>
								<li><a href="name9.html">Christopher Schodt</a></li>
								<li><a href="name11.html">Xavier Malina</a></li>
								<li><a href="name12.html">Shubham Goel</a></li>
							</ul>
						</li>
						<li class="dropdown">
							<a href="#" class="dropdown-toggle" data-toggle="dropdown">Class notes<b class="caret"></b></a>
							<ul class="dropdown-menu">
								<li><a href="week1.html">What is data?</a></li>
								<li><a href="week2.html">Data visualization: basic principles</a></li>
								<li><a href="week3.html">Interviewing data: exploratory graphical analysis</a></li>
								<li><a href="week4.html">Interviewing data: using databases</a></li>
								<li><a href="week5.html">Acquiring, cleaning and formatting data</a></li>
								<li><a href="week6.html">Making static graphics</a></li>
								<li><a href="week7.html">Polishing static graphics</a></li>
								<li><a href="week8.html">Principles of mapping</a></li>
								<li><a href="week9.html">Making static maps and processing geodata</a></li>
								<li><a href="week11.html">Making interactive maps</a></li>
								<li><a href="week12.html">Visualizing networks</a></li>
								<li><a href="week13.html">Coding interactive graphics</a></li>									
							</ul>
						</li>
						<li>
						<li><a href="software.html">Software</a></li>
						<li><a href="datasets.html">Data</a></li>
						<li><a href="mailto:peter@peteraldhous.com">Email instructor</a></li>					
					</ul>
				</div><!-- /.navbar-collapse -->
			</nav>
		</div> <!-- /.navbar-header -->
	</header>

	<div class="container all">

<h1 id="making-static-graphics-(and-processing-data)-in-r"><a name="making-static-graphics-(and-processing-data)-in-r" href="#making-static-graphics-(and-processing-data)-in-r"></a>Making static graphics (and processing data) in R</h1><h3 id="introducing-r-and-r-studio"><a name="introducing-r-and-r-studio" href="#introducing-r-and-r-studio"></a>Introducing R and R Studio</h3><p>In today’s class we will make graphics and process data using <strong><a href="http://www.r-project.org/">R</a></strong>, which is a very powerful tool, designed by statisticians for data analysis. Described on its archaic-looking website as “free software environment for statistical computing and graphics,” R is a programming language that can be used to run statistical analyses and to make graphics. It can also be used to format and process data.</p><p><strong><a href="http://www.rstudio.com/">R Studio</a></strong> is an “integrated development environment,” or IDE, for R that provides a more user-friendly interface than working in the standard R Console.</p><p>Launch R Studio, and the screen should look like this:</p><p><img src="img/class6_1.jpg" alt=""></p><p>The main panel to the left is the R Console. Type valid R code into here and hit <code>return</code> and it will be run. See what happens if you run:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;print(&quot;Hello World!&quot;)
&lt;/code&gt;&lt;/pre&gt;">print(<span class="hljs-string">"Hello World!"</span>)
</code></pre><p>Typing <code>Ctrl-L</code> will clear the console.</p><h3 id="reproducibility:-save-your-scripts-and-your-environment"><a name="reproducibility:-save-your-scripts-and-your-environment" href="#reproducibility:-save-your-scripts-and-your-environment"></a>Reproducibility: save your scripts and your environment</h3><p>As we have already discussed, we should aim for all of our data journalism to be fully documented and reprodicible. R makes this easy, as every operation performed can be saved in a script. Click on the <img src="img/class6_2.jpg" alt=""> icon at top left and select <code>R Script</code>. A new panel should now open.</p><p>Any code we type in here can be run in the console. Hitting <code>Run</code> will run the line of code on which the cursor is sitting:</p><p><img src="img/class6_3.jpg" alt=""></p><p>To run multiple lines of code, highlight them and click <code>Run</code>.</p><p>Click the disk icon in the script panel and save it as <code>week6</code>. It should automatically save with an <code>R</code> extension.</p><p>The panel at top right has two tabs, the first showing the <code>Environment</code>, or all of the “objects” loaded into memory for this R session. We can save this as well, so we don’t have to load and process data again if we return to return to the project later.</p><p>Click on the disk icon in the <code>Environment</code> panel to save and give the file a suitable name. You should see code in the following format appear in the Console, as the environment is saved with an <code>RData</code> extension:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;save.image(&quot;PathToFile/filename.RData&quot;)
&lt;/code&gt;&lt;/pre&gt;">save.image(<span class="hljs-string">"PathToFile/filename.RData"</span>)
</code></pre><p>(Note, in all today’s code examples, <code>PathToFile</code> would be replaced with an actual location on your computer.)</p><p>The second tab in this panel shows the history of all the code run in the current R session.</p><h3 id="install-and-load-r-packages"><a name="install-and-load-r-packages" href="#install-and-load-r-packages"></a>Install and load R packages</h3><p>Much of the power of R comes from the thousands of “packages” written by its community of Open Source contributors. These are optimized for specific statistical, graphical or data-processing tasks. To see what packages are available, select the <code>Packages</code> tab in the panel at bottom right. To find packages for particular tasks, try searching Google using appropriate keywords and the phrase “R package.”</p><p>In this class, we will work with a series of useful packages, called <strong>dplyr</strong>, <strong>tidyr</strong>, <strong>scales</strong>, <strong>ggplot2</strong>, <strong>RColorBrewer</strong> and <strong>WDI</strong>. Click on <code>Install</code>, and enter these names, separated by commas, as follows:</p><p><img src="img/class6_4.jpg" alt=""></p><p>Make sure that <code>Install dependencies</code> is checked, as some packages will only run correctly if other packages are also installed. Click <code>Install</code> and all of the required packages should install.</p><p>Having installed a package, you can load it into the current R session by checking its box in the <code>Packages</code> tab. However, we will enter the following code into our script, then highlight these lines of code and run them:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;# two packages for manipulating data
library(dplyr)
library(tidyr)

# the main charting package we will use today
library(ggplot2)

# package to format axes as %, $ and so on
library(scales)

# package for ColorBrewer palettes
library(RColorBrewer)

# package to import World Bank data
library(WDI)
&lt;/code&gt;&lt;/pre&gt;"><span class="hljs-comment"># two packages for manipulating data</span>
<span class="hljs-keyword">library</span>(dplyr)
<span class="hljs-keyword">library</span>(tidyr)

<span class="hljs-comment"># the main charting package we will use today</span>
<span class="hljs-keyword">library</span>(ggplot2)

<span class="hljs-comment"># package to format axes as %, $ and so on</span>
<span class="hljs-keyword">library</span>(scales)

<span class="hljs-comment"># package for ColorBrewer palettes</span>
<span class="hljs-keyword">library</span>(RColorBrewer)

<span class="hljs-comment"># package to import World Bank data</span>
<span class="hljs-keyword">library</span>(WDI)
</code></pre><p>By saving this code in our script, the packages will load automatically when we run the script in future. Add comments explaining your code using <code>#</code>, which causes everything written subsequntly on that line to be ignored. It is good practice to comment your code extensively to remind you of what it does: Don’t reply on your memory!</p><p>Each time you start R, it’s a good idea to click on <code>Update</code> in the <code>Packages</code> panel to update all your installed packages to the latest versions.</p><h3 id="data"><a name="data" href="#data"></a>Data</h3><p>The data for today’s class, which includes some files we have used previously, is packaged together <a href="./data/rclass.zip">here</a>. Download and unzip the folder.</p><h3 id="load,-view-and-export-data"><a name="load,-view-and-export-data" href="#load,-view-and-export-data"></a>Load, view and export data</h3><p>We can load data into the current R session by selecting <code>Import Dataset&gt;From Text File...</code> in the <code>Environment</code> tab. Note that data saved in text files on the web can also be imported directly from their urls.</p><p>Import the disease and democracy data in this way. You should see the following dialog box:</p><p><img src="img/class6_5.jpg" alt=""></p><p>Check that R Studio has recognized whether the data has a <code>Heading</code> row, and that it has picked the correct <code>Separator</code> and the correct <code>Quote</code> character designating for text fields. <code>na.strings</code> will replace any null values with <code>NA</code>, which is standard in R. <code>Strings as factors</code> treats any text fields as labels for categorical variables. If this is unchecked they will be imported simply as strings of text.</p><p><code>Import</code> the data, and note that the following code should appear in the Console:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;disease_democ &amp;lt;- read.delim(&quot;PathToFile/disease_democ.txt&quot;)
    View(disease_democ)
&lt;/code&gt;&lt;/pre&gt;">disease_democ &lt;- read.delim(<span class="hljs-string">"PathToFile/disease_democ.txt"</span>)
    View(disease_democ)
</code></pre><p>The data should open for inspection in the upper left panel, as instructed by the second line of the above code, and an object called <code>disease_democ</code> will now be visible in the <code>Environment</code> tab:</p><p>Note that <code>&lt;-</code> is the preferred “assignment operator” in R, although you can use <code>=</code> instead. Essentially, <code>&lt;-</code> means: “make the object named to the left equal to the output of the code to the right.”</p><p><img src="img/class6_6.jpg" alt=""></p><p>The object we have created is a <code>data.frame</code>, the standard format for tables of data in R. Its <code>Value</code> details the number of variables, and the number of records, or observations, in the data.</p><p>We can <code>View</code> data at any time by clicking on its table icon in the <code>Environment</code> tab.</p><p>Data can also be imported by writing code:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;salaries_2013 &amp;lt;- read.delim(&quot;PathToFile/salaries_2013.txt&quot;)
&lt;/code&gt;&lt;/pre&gt;">salaries_2013 &lt;- read.delim(<span class="hljs-string">"PathToFile/salaries_2013.txt"</span>)
</code></pre><p>If importing data in this way, you may need to set the options for Heading, Separator and so on in the code, as <a href="http://stat.ethz.ch/R-manual/R-devel/library/utils/html/read.table.html">explained here</a>.</p><p>Here are some useful commands for looking at data in R:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;str(disease_democ)
&lt;/code&gt;&lt;/pre&gt;">str(disease_democ)
</code></pre><p>This should give the following output in the R Console:</p><pre><code data-origin="&lt;pre&gt;&lt;code&gt;data.frame':    168 obs. of  4 variables:
 $ country     : Factor w/ 168 levels &quot;Afghanistan&quot;,..: 11 10 127 88 13 134 42 101 40 159 ...
 $ income_group: Factor w/ 5 levels &quot;High income: non-OECD&quot;,..: 1 1 1 1 1 1 1 1 1 1 ...
 $ democ_score : num  45.6 48.4 50.4 52.8 46 64 65.8 70.6 57.6 40.6 ...
 $ infect_rate : int  23 24 24 25 26 26 26 26 27 28 ...
&lt;/code&gt;&lt;/pre&gt;">data.frame':    168 obs. of  4 variables:
 $ country     : Factor w/ 168 levels "Afghanistan",..: 11 10 127 88 13 134 42 101 40 159 ...
 $ income_group: Factor w/ 5 levels "High income: non-OECD",..: 1 1 1 1 1 1 1 1 1 1 ...
 $ democ_score : num  45.6 48.4 50.4 52.8 46 64 65.8 70.6 57.6 40.6 ...
 $ infect_rate : int  23 24 24 25 26 26 26 26 27 28 ...
</code></pre><p>The <code>str</code> function shows the structure of a <code>data.frame</code>, telling us here that <code>country</code> and <code>income_group</code> are “Factors,” which is what R calls categorical variables, <code>democ_score</code> is numeric, or a continuous variable, while <code>infect_rate</code> is a continuous variable that contains only integers.</p><p>The following code shows the first <code>n</code> lines from an object, where <code>n</code> is the number given after the comma. It can be useful for quickly examining how data is organized:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;head(disease_democ,10)
&lt;/code&gt;&lt;/pre&gt;">head(disease_democ,<span class="hljs-number">10</span>)
</code></pre><p>This is the output:</p><pre><code data-origin="&lt;pre&gt;&lt;code&gt;                country          income_group democ_score infect_rate
1               Bahrain High income: non-OECD        45.6          23
2          Bahamas, The High income: non-OECD        48.4          24
3                 Qatar High income: non-OECD        50.4          24
4                Latvia High income: non-OECD        52.8          25
5              Barbados High income: non-OECD        46.0          26
6             Singapore High income: non-OECD        64.0          26
7                Cyprus High income: non-OECD        65.8          26
8                 Malta High income: non-OECD        70.6          26
9               Croatia High income: non-OECD        57.6          27
10 United Arab Emirates High income: non-OECD        40.6          28
&lt;/code&gt;&lt;/pre&gt;">                country          income_group democ_score infect_rate
1               Bahrain High income: non-OECD        45.6          23
2          Bahamas, The High income: non-OECD        48.4          24
3                 Qatar High income: non-OECD        50.4          24
4                Latvia High income: non-OECD        52.8          25
5              Barbados High income: non-OECD        46.0          26
6             Singapore High income: non-OECD        64.0          26
7                Cyprus High income: non-OECD        65.8          26
8                 Malta High income: non-OECD        70.6          26
9               Croatia High income: non-OECD        57.6          27
10 United Arab Emirates High income: non-OECD        40.6          28
</code></pre><p>Often you may want to export data as a delimited text file after processing in R. So let’s do this now for the disease and democracy data:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;write.table(disease_democ, &quot;PathToFile/disease_democ_export.txt&quot;, row.names = FALSE, sep = &quot;\t&quot;, na = &quot;&quot;)
&lt;/code&gt;&lt;/pre&gt;">write.table(disease_democ, <span class="hljs-string">"PathToFile/disease_democ_export.txt"</span>, row.names = <span class="hljs-literal">FALSE</span>, sep = <span class="hljs-string">"\t"</span>, na = <span class="hljs-string">""</span>)
</code></pre><p>If <code>row.names = FALSE</code> is not included, R will automatically add a number label to each row; <code>sep = "\t"</code> ensures that the delimiter or separator is <code>tab</code>. <code>na = ""</code> explains how to export any null values. Here they will be left blank, because there is nothing between the quote marks.</p><h3 id="draw-a-scatter-plot-from-the-disease-and-democracy-data"><a name="draw-a-scatter-plot-from-the-disease-and-democracy-data" href="#draw-a-scatter-plot-from-the-disease-and-democracy-data"></a>Draw a scatter plot from the disease and democracy data</h3><p>Now we will use the <a href="http://ggplot2.org/">ggplot2</a> charting package to draw the scatter plot from week 1. Return to the <a href="http://rweb.stat.ucla.edu/ggplot2/">ggplot2 web app</a> and create the chart again. Then select <code>View</code> from the top menu and and check <code>code panel</code>. This will open a panel at the base of the page illustrating the ggplot2 code that would be used to create the graphic. (You cannot manipulate this code to change a chart in the app, but this feature makes the app a good tool for learning how to code ggplot2 graphics.)</p><p>Copy that code, and insert into your R script, replacing <code>myData</code> with <code>disease_democ</code>, as follows:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;ggplot(disease_democ, aes(x=infect_rate, y=democ_score)) + geom_point(size=4) + geom_smooth(se=FALSE, method=&quot;lm&quot;)
&lt;/code&gt;&lt;/pre&gt;">ggplot(disease_democ, aes(x=infect_rate, y=democ_score)) + geom_point(size=<span class="hljs-number">4</span>) + geom_smooth(se=<span class="hljs-literal">FALSE</span>, method=<span class="hljs-string">"lm"</span>)
</code></pre><p>Run that code, and the scatterplot will appear in the panel at bottom right, in the <code>Plots</code> tab:</p><p><img src="img/class6_7.jpg" alt=""></p><p>We can also first save the chart as an R object, and then plot it:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;disease_democ_scatter &amp;lt;- ggplot(disease_democ, aes(x=infect_rate, y=democ_score)) + geom_point(size=4) + geom_smooth(se=FALSE, method=&quot;lm&quot;)
plot (disease_democ_scatter)
&lt;/code&gt;&lt;/pre&gt;">disease_democ_scatter &lt;- ggplot(disease_democ, aes(x=infect_rate, y=democ_score)) + geom_point(size=<span class="hljs-number">4</span>) + geom_smooth(se=<span class="hljs-literal">FALSE</span>, method=<span class="hljs-string">"lm"</span>)
plot (disease_democ_scatter)
</code></pre><p>Notice that an object with the Type <code>gg</code> appears in the <code>Environment</code> tab.</p><p>Now we can customize the chart, taking that object and defining ranges for the axes, and adding more informative labels for each. (This will gave the same result as entering the original code with the additional code appended.)</p><p>This is the code:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;disease_democ_scatter + coord_cartesian(xlim=c(0,70), ylim=c(0,100)) + xlab(&quot;Infectious disease prevalence score&quot;) + ylab(&quot;Democratization score&quot;)
&lt;/code&gt;&lt;/pre&gt;">disease_democ_scatter + coord_cartesian(xlim=c(<span class="hljs-number">0</span>,<span class="hljs-number">70</span>), ylim=c(<span class="hljs-number">0</span>,<span class="hljs-number">100</span>)) + xlab(<span class="hljs-string">"Infectious disease prevalence score"</span>) + ylab(<span class="hljs-string">"Democratization score"</span>)
</code></pre><p>Notice the <code>c</code> or “combine” function. This takes a series of values, and combines them into a list. It crops up frequently in R code.</p><p>You may see ggplot2 examples in which the range for axes are set using simpler code, for example:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;disease_democ_scatter + xlim=(0,70) + ylim(0,100) + xlab(&quot;Infectious disease prevalence score&quot;) + ylab(&quot;Democratization score&quot;)
&lt;/code&gt;&lt;/pre&gt;">disease_democ_scatter + xlim=(<span class="hljs-number">0</span>,<span class="hljs-number">70</span>) + ylim(<span class="hljs-number">0</span>,<span class="hljs-number">100</span>) + xlab(<span class="hljs-string">"Infectious disease prevalence score"</span>) + ylab(<span class="hljs-string">"Democratization score"</span>)
</code></pre><p>While it has the same result in this case, I do not suggest using this option. As well as setting the axis ranges, the simpler code discards any data that appears outside the range, so that it will not be taken into account when drawing a trend line, for instance. The more complex version is safer, as it retains all the data.</p><p>The chart should now look like this:</p><p><img src="img/class6_8.jpg" alt=""></p><h3 id="export-your-plots"><a name="export-your-plots" href="#export-your-plots"></a>Export your plots</h3><p>R Studio makes it easy to export graphics from R. Select <code>Export&gt;Save Plot as PDF...</code> from the menu in the <code>Plots</code> tab. At the dialog box, you can select the size and orientation for the export, choose where to save it, and give it an appropriate name:</p><p><img src="img/class6_9.jpg" alt=""></p><p>R Studio also offers the option to export in various image formats. If you are intending to edit the graphic subsequently, however, save as a PDF. For all the graphics we export today, export at <code>US Letter</code> size and <code>Landscape</code> orientation.</p><p>Notice also the arrows at top left of the <code>Plots</code> tab. These allow us to browse back and forth through the charts drawn in the current R session.</p><h3 id="ggplot2-and-the-grammar-of-graphics"><a name="ggplot2-and-the-grammar-of-graphics" href="#ggplot2-and-the-grammar-of-graphics"></a>ggplot2 and the grammar of graphics</h3><p>The “gg” in ggplot2 stands for <a href="http://www.amazon.com/The-Grammar-Graphics-Statistics-Computing/dp/0387245448">“grammar of graphics,”</a> an approach to drawing charts devised by the statistician Leland Wilkinson. Rather than thinking in terms of finished charts like a scatter plot or a column chart, it starts by defining the coordinate system (usually the X and Y axes of a cartesian system), maps data onto those coordinates, and then adds layers such as points, bars and so on. This is the logic behind ggplot2 code.</p><p>The function <code>aes</code>, for aesthetic mapping, is used whenever we map data values onto a chart — to an axis, to a color scale, and so on. So ggplot2 code starts by mapping variables to the X and Y axes. Layers are then added the the graphic using various <code>geom</code> functions. The brackets following each of these each functions may contain global operations to be applied to every item in the layer, and also further <code>aes</code> mappings so that the color of points, for example, can be mapped to values of a categorical variable.</p><p>To see this in action, let’s color the points in our scatter plot according to each country’s income group:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;ggplot(disease_democ, aes(x=infect_rate, y=democ_score)) + geom_point(size=4, aes(color=income_group)) + geom_smooth(se=FALSE,method=&quot;lm&quot;)
&lt;/code&gt;&lt;/pre&gt;">ggplot(disease_democ, aes(x=infect_rate, y=democ_score)) + geom_point(size=<span class="hljs-number">4</span>, aes(color=income_group)) + geom_smooth(se=<span class="hljs-literal">FALSE</span>,method=<span class="hljs-string">"lm"</span>)
</code></pre><p><img src="img/class6_10.jpg" alt=""></p><p>Note the difference between this plot, and the result we obtain by mapping color to income group in the initial aesthetic mapping, rather than specifically for the points:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;ggplot(disease_democ, aes(x=infect_rate, y=democ_score, color=income_group)) + geom_point(size=4) + geom_smooth(se=FALSE,method=&quot;lm&quot;)
&lt;/code&gt;&lt;/pre&gt;">ggplot(disease_democ, aes(x=infect_rate, y=democ_score, color=income_group)) + geom_point(size=<span class="hljs-number">4</span>) + geom_smooth(se=<span class="hljs-literal">FALSE</span>,method=<span class="hljs-string">"lm"</span>)
</code></pre><p><img src="img/class6_11.jpg" alt=""></p><h3 id="draw-box-plots-from-the-baseball-salary-data"><a name="draw-box-plots-from-the-baseball-salary-data" href="#draw-box-plots-from-the-baseball-salary-data"></a>Draw box plots from the baseball salary data</h3><p>Here is the code for the basic baseball salaries boxplot:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;ggplot(salaries_2013, aes(x=team, y=salary, color=team)) + geom_boxplot()
&lt;/code&gt;&lt;/pre&gt;">ggplot(salaries_2013, aes(x=team, y=salary, color=team)) + geom_boxplot()
</code></pre><p><img src="img/class6_12.jpg" alt=""></p><p>Let’s customize this plot to remove the legend, which adds little, format the salary axis in $ millions, and turn the team labels through 90 degrees to make them legible.</p><p>First make a new variable giving salary in millions, by dividing <code>salary</code> by 1 million:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;salaries_2013$millions &amp;lt;- salaries_2013$salary/1000000
&lt;/code&gt;&lt;/pre&gt;">salaries_2013$millions &lt;- salaries_2013$salary/<span class="hljs-number">1000000</span>
</code></pre><p>Notice how <code>$</code> is used to specify a variable within a <code>data.frame</code>.</p><p>We can also do this with the <code>mutate</code> function from the <a href="http://cran.rstudio.com/web/packages/dplyr/vignettes/introduction.html">dplyr</a> package:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;salaries_2013 &amp;lt;- mutate(salaries_2013, millions2=salary/1000000)
&lt;/code&gt;&lt;/pre&gt;">salaries_2013 &lt;- mutate(salaries_2013, millions2=salary/<span class="hljs-number">1000000</span>)
</code></pre><p>Notice that here the object to the left of <code>&lt;-</code> has the same name as the old object. This allows us to an edit an object with new code as we go along. We will do this later on with saved ggplot2 charts.</p><p>View the data, and see that the new variables <code>millions</code> and <code>millions2</code> are identical.</p><p>Now redraw the plot with the <code>millions</code> variable on y axis:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;ggplot(salaries_2013, aes(x=team, y=millions, color=team)) + geom_boxplot()
&lt;/code&gt;&lt;/pre&gt;">ggplot(salaries_2013, aes(x=team, y=millions, color=team)) + geom_boxplot()
</code></pre><p>Again, let’s save that chart:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;baseball_box &amp;lt;- ggplot(salaries_2013, aes(x=team, y=millions, colour=team)) + geom_boxplot()
&lt;/code&gt;&lt;/pre&gt;">baseball_box &lt;- ggplot(salaries_2013, aes(x=team, y=millions, colour=team)) + geom_boxplot()
</code></pre><p>Now customize the plot to remove the legend and change the axis labels:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;baseball_box + theme(legend.position=&quot;none&quot;, axis.text.x = element_text(angle=90)) + xlab(&quot;Team&quot;) + ylab(&quot;Salary ($ millions)&quot;)
&lt;/code&gt;&lt;/pre&gt;">baseball_box + theme(legend.position=<span class="hljs-string">"none"</span>, axis.text.x = element_text(angle=<span class="hljs-number">90</span>)) + xlab(<span class="hljs-string">"Team"</span>) + ylab(<span class="hljs-string">"Salary ($ millions)"</span>)
</code></pre><p>This code introduces the <code>theme</code> function, which is used to custom various aspects of a chart’s appearance.</p><p>The final chart should look like this:</p><p><img src="img/class6_13.jpg" alt=""></p><h3 id="draw-column,-line-and-other-charts-from-food-stamps-data"><a name="draw-column,-line-and-other-charts-from-food-stamps-data" href="#draw-column,-line-and-other-charts-from-food-stamps-data"></a>Draw column, line and other charts from food stamps data</h3><p>Now we will draw the variety of charts used in week 2 to illustrate different ways of charting participation over time in the U.S. federal government’s food stamps nutritional assistance program.</p><p>First import the food stamps data. The number of participants is in thousands. Again we can make a new column giving the number in millions:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;food_stamps &amp;lt;- mutate(food_stamps, mil_particip=particip/1000)
&lt;/code&gt;&lt;/pre&gt;">food_stamps &lt;- mutate(food_stamps, mil_particip=particip/<span class="hljs-number">1000</span>)
</code></pre><p>First create a basic plot area with no layers:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;food_stamps_chart &amp;lt;- ggplot(food_stamps, aes(x=year, y=mil_particip)) + coord_cartesian(xlim = c(1968, 2014), ylim = c(0, 50)) + xlab(&quot;Year&quot;) + ylab(&quot;Participants (millions)&quot;)
&lt;/code&gt;&lt;/pre&gt;">food_stamps_chart &lt;- ggplot(food_stamps, aes(x=year, y=mil_particip)) + coord_cartesian(xlim = c(<span class="hljs-number">1968</span>, <span class="hljs-number">2014</span>), ylim = c(<span class="hljs-number">0</span>, <span class="hljs-number">50</span>)) + xlab(<span class="hljs-string">"Year"</span>) + ylab(<span class="hljs-string">"Participants (millions)"</span>)
</code></pre><p>Notice how the ranges for the X and Y axes have been set after looking at the data to see the maximum values.</p><p>Now we can use this object as the base to draw charts of different types. Let’s start with a column chart. To make the height of the columns correspond to data values we use <code>stat="identity"</code>. Other options for <code>geom_bar</code> are explained <a href="http://docs.ggplot2.org/0.9.3.1/geom_bar.html">here</a>.</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;food_stamps_chart + geom_bar(stat=&quot;identity&quot;) + ggtitle(&quot;Column chart&quot;)
&lt;/code&gt;&lt;/pre&gt;">food_stamps_chart + geom_bar(stat=<span class="hljs-string">"identity"</span>) + ggtitle(<span class="hljs-string">"Column chart"</span>)
</code></pre><p>Notice the use of <code>ggtitle</code> to add a title to the chart.</p><p>And now a series of other chart types:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;# line chart, note use of &quot;size&quot; to draw thicker line
food_stamps_chart + geom_line(size=2) + ggtitle(&quot;Line chart&quot;)

# dot-and-line chart, note how more than one layer can be added to the chart
food_stamps_chart + geom_line() + geom_point(size=4) + ggtitle(&quot;Dot-and-line chart&quot;)

# dot-column chart, note the more complex code to draw the vertical lines
food_stamps_chart + geom_linerange(aes(ymax=0,ymin=mil_particip)) + geom_point(size=4) + ggtitle(&quot;Dot-column chart&quot;)
&lt;/code&gt;&lt;/pre&gt;"><span class="hljs-comment"># line chart, note use of "size" to draw thicker line</span>
food_stamps_chart + geom_line(size=<span class="hljs-number">2</span>) + ggtitle(<span class="hljs-string">"Line chart"</span>)

<span class="hljs-comment"># dot-and-line chart, note how more than one layer can be added to the chart</span>
food_stamps_chart + geom_line() + geom_point(size=<span class="hljs-number">4</span>) + ggtitle(<span class="hljs-string">"Dot-and-line chart"</span>)

<span class="hljs-comment"># dot-column chart, note the more complex code to draw the vertical lines</span>
food_stamps_chart + geom_linerange(aes(ymax=<span class="hljs-number">0</span>,ymin=mil_particip)) + geom_point(size=<span class="hljs-number">4</span>) + ggtitle(<span class="hljs-string">"Dot-column chart"</span>)
</code></pre><p>This will draw the series of charts we saw in week 2:</p><p><img src="img/class2_9.jpg" alt=""></p><h3 id="draw-stacked-bar-chart-and-pie-charts-from-presidential-approval-polling-data"><a name="draw-stacked-bar-chart-and-pie-charts-from-presidential-approval-polling-data" href="#draw-stacked-bar-chart-and-pie-charts-from-presidential-approval-polling-data"></a>Draw stacked bar chart and pie charts from presidential approval polling data</h3><p>Next we will draw the charts from the presidential approval polling data we saw in week 2. Import and view the data, in the file <code>obama.txt</code>:</p><p><img src="img/class6_14.jpg" alt=""></p><p>This data is in “wide” format — much like the pivot table we made in week 4. We need to convert it to “long” format before we can use ggplot2 to chart the data. This is where the <a href="http://blog.rstudio.org/2014/07/22/introducing-tidyr/">tidyr</a> package comes in. It has two main functions: <code>gather</code>, which converts from wide to long, and <code>spread</code>, which converts from long to wide.</p><p>The following code tells tidyr to gather data from the obama <code>data.frame</code>, putting  existing column labels into a new variable called <code>category</code>, and the values for each record into a new variable called <code>rating</code>. The hyphen before <code>policy</code> specificies that this variable is not to be gathered.</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;obama_long &amp;lt;- gather(obama, category, rating, -policy)
&lt;/code&gt;&lt;/pre&gt;">obama_long &lt;- gather(obama, category, rating, -policy)
</code></pre><p>The data should now look like this:</p><p><img src="img/class6_15.jpg" alt=""></p><p>Now we will set a custom color palette, by creating a list of hex color values:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;palette &amp;lt;- c(&quot;#003380&quot;, &quot;#aaccff&quot;, &quot;#dbdee3&quot;)
&lt;/code&gt;&lt;/pre&gt;">palette &lt;- c(<span class="hljs-string">"#003380"</span>, <span class="hljs-string">"#aaccff"</span>, <span class="hljs-string">"#dbdee3"</span>)
</code></pre><p>This code saves and then plots the stacked column chart:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;poll_stacked_bar &amp;lt;- ggplot(obama_long, aes(x=policy, y=rating)) + geom_bar(stat=&quot;identity&quot;, aes(fill=category)) + scale_fill_manual(values=palette)
plot(poll_stacked_bar)
&lt;/code&gt;&lt;/pre&gt;">poll_stacked_bar &lt;- ggplot(obama_long, aes(x=policy, y=rating)) + geom_bar(stat=<span class="hljs-string">"identity"</span>, aes(fill=category)) + scale_fill_manual(values=palette)
plot(poll_stacked_bar)
</code></pre><p><img src="img/class6_16.jpg" alt=""></p><p>Mapping <code>category</code> to the <code>fill</code> for the columns is what makes this into a stacked column chart.</p><p>Notice how <code>fill</code> is used here rather than <code>color</code>, which would affect the outlines of the columns, not the color used to fill them. To see how this works, run this code:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;ggplot(obama_long, aes(x=policy, y=rating)) + geom_bar(stat=&quot;identity&quot;, aes(fill=category), color=&quot;black&quot;) + scale_fill_manual(values=palette)
&lt;/code&gt;&lt;/pre&gt;">ggplot(obama_long, aes(x=policy, y=rating)) + geom_bar(stat=<span class="hljs-string">"identity"</span>, aes(fill=category), color=<span class="hljs-string">"black"</span>) + scale_fill_manual(values=palette)
</code></pre><p>Note that R understands some colors, like “black,” <a href="http://www.stat.columbia.edu/~tzheng/files/Rcolor.pdf">by name</a> — but we could also have used its hex value.</p><p>The gray background does not work with this color palette. So let’s customize the chart, switching to ggplot2’s built-in alternate black-and-white theme:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;poll_stacked_bar + theme_bw()
&lt;/code&gt;&lt;/pre&gt;">poll_stacked_bar + theme_bw()
</code></pre><p><img src="img/class6_17.jpg" alt=""></p><p>As noted earlier, the <code>theme</code> function can be used to customize a basic R plot, see <a href="http://docs.ggplot2.org/current/theme.html">here</a> for a complete reference. Here we will remove the panel border and grid lines, saving those changes:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;poll_stacked_bar &amp;lt;- poll_stacked_bar + theme_bw() + theme(panel.border=element_blank(), panel.grid=element_blank())
plot(poll_stacked_bar)
&lt;/code&gt;&lt;/pre&gt;">poll_stacked_bar &lt;- poll_stacked_bar + theme_bw() + theme(panel.border=element_blank(), panel.grid=element_blank())
plot(poll_stacked_bar)
</code></pre><p><img src="img/class6_18.jpg" alt=""></p><p>Now add labels to the chart showing data values:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;poll_stacked_bar + geom_text(aes(label = rating), size = 5, vjust = 1.2, color = &quot;#ffffff&quot;, position = &quot;stack&quot;)
&lt;/code&gt;&lt;/pre&gt;">poll_stacked_bar + geom_text(aes(label = rating), size = <span class="hljs-number">5</span>, vjust = <span class="hljs-number">1.2</span>, color = <span class="hljs-string">"#ffffff"</span>, position = <span class="hljs-string">"stack"</span>)
</code></pre><p>Try altering the <code>vjust</code> value to see how this part of the code works to set the vertical position of each label.</p><p><img src="img/class6_19.jpg" alt=""></p><p>This chart is still not finished, but from here is makes more sense to polish in a vector graphics editor such as Inkscape, as we will do next week. So export this chart as a PDF, so we can edit it later.</p><p>ggplot2 can also be tortured into drawing pie charts, but the code gets rather complex. For completeness, here it is:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;ggplot(obama_long, aes(x=&quot;1&quot;, y=rating)) + geom_bar(stat=&quot;identity&quot;, aes(fill=category)) + coord_polar(theta=&quot;y&quot;) + facet_grid(facets=. ~ policy) + scale_fill_manual(values=palette) + theme_bw()
&lt;/code&gt;&lt;/pre&gt;">ggplot(obama_long, aes(x=<span class="hljs-string">"1"</span>, y=rating)) + geom_bar(stat=<span class="hljs-string">"identity"</span>, aes(fill=category)) + coord_polar(theta=<span class="hljs-string">"y"</span>) + facet_grid(facets=. ~ policy) + scale_fill_manual(values=palette) + theme_bw()
</code></pre><h3 id="draw-a-scatter-plot-from-gender-pay-gap-data-and-add-fixed-lines"><a name="draw-a-scatter-plot-from-gender-pay-gap-data-and-add-fixed-lines" href="#draw-a-scatter-plot-from-gender-pay-gap-data-and-add-fixed-lines"></a>Draw a scatter plot from gender pay gap data and add fixed lines</h3><p>Now we will draw the gender pay gap scatterplot shown in week 2, to illustrate adding fixed lines to a chart. Import the data, and notice that there are three years of data - so first we will need to filter to select just the data for 2013.</p><p>We can do this with R’s built-in <code>subset</code> function:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;gender_pay_2013 &amp;lt;- subset(gender_pay, year==2013)
&lt;/code&gt;&lt;/pre&gt;">gender_pay_2013 &lt;- subset(gender_pay, year==<span class="hljs-number">2013</span>)
</code></pre><p>Or we can the use the <code>filter</code> function from dplyr:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;gender_pay_2013 &amp;lt;- filter(gender_pay, year==2013)
&lt;/code&gt;&lt;/pre&gt;">gender_pay_2013 &lt;- filter(gender_pay, year==<span class="hljs-number">2013</span>)
</code></pre><p>Now let’s draw and customize the scatter plot, mapping the variables representating men’s and women’s median weekly earnings for each job to the X and Y axes, respectively:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;# save and draw basic scatterplot, note use of &quot;alpha&quot; to set transparency for the points
gender_pay_scatter &amp;lt;- ggplot(gender_pay_2013, aes(x=m_median_weekly_earnings, y=w_median_weekly_earnings)) + geom_point(size=4, alpha=0.5)
plot(gender_pay_scatter)

# set both axes to run from zero to 2500, and to have a size ratio of 1:1
gender_pay_scatter &amp;lt;- gender_pay_scatter + coord_fixed(ratio = 1, xlim = c(0,2500), ylim = c(0,2500))
plot(gender_pay_scatter)

# set axis labels and bw theme
gender_pay_scatter &amp;lt;- gender_pay_scatter + xlab(&quot;Men's median weekly earnings&quot;) + ylab(&quot;Women's median weekly earnings&quot;) + theme_bw()
plot(gender_pay_scatter)
&lt;/code&gt;&lt;/pre&gt;"><span class="hljs-comment"># save and draw basic scatterplot, note use of "alpha" to set transparency for the points</span>
gender_pay_scatter &lt;- ggplot(gender_pay_2013, aes(x=m_median_weekly_earnings, y=w_median_weekly_earnings)) + geom_point(size=<span class="hljs-number">4</span>, alpha=<span class="hljs-number">0.5</span>)
plot(gender_pay_scatter)

<span class="hljs-comment"># set both axes to run from zero to 2500, and to have a size ratio of 1:1</span>
gender_pay_scatter &lt;- gender_pay_scatter + coord_fixed(ratio = <span class="hljs-number">1</span>, xlim = c(<span class="hljs-number">0</span>,<span class="hljs-number">2500</span>), ylim = c(<span class="hljs-number">0</span>,<span class="hljs-number">2500</span>))
plot(gender_pay_scatter)

<span class="hljs-comment"># set axis labels and bw theme</span>
gender_pay_scatter &lt;- gender_pay_scatter + xlab(<span class="hljs-string">"Men's median weekly earnings"</span>) + ylab(<span class="hljs-string">"Women's median weekly earnings"</span>) + theme_bw()
plot(gender_pay_scatter)
</code></pre><p>The chart should now look like this:</p><p><img src="img/class6_20.jpg" alt=""></p><p>You should now be getting sufficiently familiar with R and ggplot2 code that you can work out the logic of each step.</p><p>Next we will customize the chart further, using the <code>labels</code> function from the <a href="http://cran.r-project.org/web/packages/scales/scales.pdf">scales</a> package to display dollar values, and the <code>geom_abline</code> function to add fixed reference lines to the chart.</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;# remove panel and tick marks, set axes to display dollar values using scales package
gender_pay_scatter &amp;lt;- gender_pay_scatter + theme(panel.border=element_blank(), axis.ticks=element_blank()) + scale_x_continuous(labels = dollar) + scale_y_continuous(labels = dollar)
plot(gender_pay_scatter)

# add lines for equal pay and for women paid 75% of men's salaries; note use of &quot;intercept&quot; to define where line crosses Y axis
gender_pay_scatter &amp;lt;- gender_pay_scatter + geom_abline(intercept = 0, slope = 1) + geom_abline(intercept = 0, slope = 0.75, linetype=&quot;dashed&quot;)
plot(gender_pay_scatter)
&lt;/code&gt;&lt;/pre&gt;"><span class="hljs-comment"># remove panel and tick marks, set axes to display dollar values using scales package</span>
gender_pay_scatter &lt;- gender_pay_scatter + theme(panel.border=element_blank(), axis.ticks=element_blank()) + scale_x_continuous(labels = dollar) + scale_y_continuous(labels = dollar)
plot(gender_pay_scatter)

<span class="hljs-comment"># add lines for equal pay and for women paid 75% of men's salaries; note use of "intercept" to define where line crosses Y axis</span>
gender_pay_scatter &lt;- gender_pay_scatter + geom_abline(intercept = <span class="hljs-number">0</span>, slope = <span class="hljs-number">1</span>) + geom_abline(intercept = <span class="hljs-number">0</span>, slope = <span class="hljs-number">0.75</span>, linetype=<span class="hljs-string">"dashed"</span>)
plot(gender_pay_scatter)
</code></pre><p>The final chart should look like this:</p><p><img src="img/class6_21.jpg" alt=""></p><p>Export the chart as PDF, so we can edit it further and annotate later.</p><h3 id="use-dplyr-to-filter-pfizer-payments-data,-then-draw-bar-chart"><a name="use-dplyr-to-filter-pfizer-payments-data,-then-draw-bar-chart" href="#use-dplyr-to-filter-pfizer-payments-data,-then-draw-bar-chart"></a>Use dplyr to filter Pfizer payments data, then draw bar chart</h3><p>You may be wondering why we bothered loading the dplyr package, as so far everything we have done with it could be achieved with standard R code.</p><p>In this example we will see why dplyr is particularly useful for data processing by replicating one of the SQL queries we ran in Week 4, before drawing a chart from the data.</p><p>Load the Pfizer payments data.</p><p>We can use dplyr’s SQL-like functions to repeat our task from Week 4 of filtering the data to select all doctors in California paid more than $10,000 to run Expert-led forums.</p><ul>
<li><p><code>select</code> does much the same job as <code>SELECT</code> in SQL, picking which fields or variables to return.</p>
</li>
<li><p><code>filter</code> corresponds to <code>WHERE</code> and follows Boolean logic with <code>|</code> representing <code>OR</code> and <code>&amp;</code> representing <code>AND</code>.</p>
</li>
<li><p><code>arrange</code> does the same job as <code>ORDER BY</code> in SQL, sorting the data. </p>
</li>
<li><p>dplyr also allows you to “chain” these functions together using <code>%&gt;%</code>, or “then,” making the output from one function the input for the next.</p>
</li>
</ul><p>This is the dplyr version of our SQL query:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;ca_docs &amp;lt;- select(pfizer, first_plus, last_name, city, state, category, total) %&amp;gt;%
  filter(category==&quot;Expert-Led Forums&quot; &amp;amp; state==&quot;CA&quot; &amp;amp; total &amp;gt;= 10000) %&amp;gt;%
  arrange(desc(total))
&lt;/code&gt;&lt;/pre&gt;">ca_docs &lt;- select(pfizer, first_plus, last_name, city, state, category, total) %&gt;%
  filter(category==<span class="hljs-string">"Expert-Led Forums"</span> &amp; state==<span class="hljs-string">"CA"</span> &amp; total &gt;= <span class="hljs-number">10000</span>) %&gt;%
  arrange(desc(total))
</code></pre><p>View the data to see the results.</p><p>Next we want to draw a bar chart showing how much these doctors were paid. We want to label each bar with the doctor’s full name, which means creating a new variable combining <code>first_plus</code> and <code>last_name</code>.</p><p>We can use dplyr’s <code>mutate</code> function for this:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;ca_docs &amp;lt;- mutate(ca_docs, full_name=paste(first_plus, last_name, sep=&quot; &quot;))
&lt;/code&gt;&lt;/pre&gt;">ca_docs &lt;- mutate(ca_docs, full_name=paste(first_plus, last_name, sep=<span class="hljs-string">" "</span>))
</code></pre><p>In this code, <code>sep = " "</code> ensures that the given and family names are separated by a space.</p><p>Let’s examine the structure of the data:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;str(ca_docs)
&lt;/code&gt;&lt;/pre&gt;">str(ca_docs)
</code></pre><p>Which gives the output:</p><pre><code data-origin="&lt;pre&gt;&lt;code&gt;'data.frame':    31 obs. of  7 variables:
 $ first_plus: Factor w/ 4048 levels &quot;&quot;,&quot;A MARK&quot;,&quot;AAKASH MOHAN&quot;,..: 1286 2611 3617 784 3368 1357 1516 2466 2974 1863 ...
 $ last_name : Factor w/ 3617 levels &quot;---&quot;,&quot;ABBO&quot;,&quot;ABEBE&quot;,..: 2824 2324 2570 1145 1933 3068 202 432 2317 2944 ...
 $ city      : Factor w/ 1318 levels &quot;A&quot;,&quot;ABERDEEN&quot;,..: 1058 673 867 673 1024 1303 122 701 612 1137 ...
 $ state     : Factor w/ 52 levels &quot;AK&quot;,&quot;AL&quot;,&quot;AR&quot;,..: 5 5 5 5 5 5 5 5 5 5 ...
 $ category  : Factor w/ 9 levels &quot;&quot;,&quot;Business Related Travel&quot;,..: 4 4 4 4 4 4 4 4 4 4 ...
 $ total     : int  146500 70500 48350 45750 41250 40000 26400 24000 22500 21500 ...
 $ full_name : chr  &quot;GERALD MICHAEL SACKS&quot; &quot;MITCHELL NIDES&quot; &quot;STEVEN GARTH POTKIN&quot; &quot;DAVID ALAN GINSBERG&quot; ...
&lt;/code&gt;&lt;/pre&gt;">'data.frame':    31 obs. of  7 variables:
 $ first_plus: Factor w/ 4048 levels "","A MARK","AAKASH MOHAN",..: 1286 2611 3617 784 3368 1357 1516 2466 2974 1863 ...
 $ last_name : Factor w/ 3617 levels "---","ABBO","ABEBE",..: 2824 2324 2570 1145 1933 3068 202 432 2317 2944 ...
 $ city      : Factor w/ 1318 levels "A","ABERDEEN",..: 1058 673 867 673 1024 1303 122 701 612 1137 ...
 $ state     : Factor w/ 52 levels "AK","AL","AR",..: 5 5 5 5 5 5 5 5 5 5 ...
 $ category  : Factor w/ 9 levels "","Business Related Travel",..: 4 4 4 4 4 4 4 4 4 4 ...
 $ total     : int  146500 70500 48350 45750 41250 40000 26400 24000 22500 21500 ...
 $ full_name : chr  "GERALD MICHAEL SACKS" "MITCHELL NIDES" "STEVEN GARTH POTKIN" "DAVID ALAN GINSBERG" ...
</code></pre><p>Notice that the <code>full_name</code> isn’t treated as a categorical variable, or <code>Factor</code>, but instead is a “character” variable, or <code>chr</code>, which is a simple string of text.</p><p>Now we can make a bar charts from the filtered data. The code is the same as for a column chart, except that <code>coord_flip</code> is used to switch from vertical bars to horizontal columns.</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;ggplot(ca_docs, aes(x=full_name, y=total)) + geom_bar(stat=&quot;identity&quot;) + coord_flip()
&lt;/code&gt;&lt;/pre&gt;">ggplot(ca_docs, aes(x=full_name, y=total)) + geom_bar(stat=<span class="hljs-string">"identity"</span>) + coord_flip()
</code></pre><p><img src="img/class6_22.jpg" alt=""></p><p>It makes more sense to sort the bars according to how much each doctor was paid, which we can do in either ascending or descending order by using the <code>reorder</code> function:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;#descending order
ggplot(ca_docs, aes(x=reorder(full_name, total), y=total)) + geom_bar(stat=&quot;identity&quot;) + coord_flip()

#ascending order
ggplot(ca_docs, aes(x=reorder(full_name, -total), y=total)) + geom_bar(stat=&quot;identity&quot;) + coord_flip()
&lt;/code&gt;&lt;/pre&gt;"><span class="hljs-comment">#descending order</span>
ggplot(ca_docs, aes(x=reorder(full_name, total), y=total)) + geom_bar(stat=<span class="hljs-string">"identity"</span>) + coord_flip()

<span class="hljs-comment">#ascending order</span>
ggplot(ca_docs, aes(x=reorder(full_name, -total), y=total)) + geom_bar(stat=<span class="hljs-string">"identity"</span>) + coord_flip()
</code></pre><p>Here is the chart in descending order:</p><p><img src="img/class6_23.jpg" alt=""></p><p>That’s fine, except it would look nicer if the names were not capitalized, and instead were written with inital capitals only — proper case. We can fix that with a custom R function. You don’t need to understand the details of how it works, but it is worth saving for future use:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;# function to convert any text string into proper case
toproper &amp;lt;- function(x) {
  sapply(x, function(strn)
  { s &amp;lt;- strsplit(strn, &quot;\\s&quot;)[[1]]
    paste0(toupper(substring(s, 1,1)), 
           tolower(substring(s, 2)),
           collapse=&quot; &quot;)}, USE.NAMES=FALSE)
}
&lt;/code&gt;&lt;/pre&gt;"><span class="hljs-comment"># function to convert any text string into proper case</span>
toproper &lt;- <span class="hljs-keyword">function</span>(x) {
  sapply(x, <span class="hljs-keyword">function</span>(strn)
  { s &lt;- strsplit(strn, <span class="hljs-string">"\\s"</span>)[[<span class="hljs-number">1</span>]]
    paste0(toupper(substring(s, <span class="hljs-number">1</span>,<span class="hljs-number">1</span>)), 
           tolower(substring(s, <span class="hljs-number">2</span>)),
           collapse=<span class="hljs-string">" "</span>)}, USE.NAMES=<span class="hljs-literal">FALSE</span>)
}
</code></pre><p>Notice that when you run this code, the new function appears in the <code>Environment</code>.</p><p>Having defined this function, we can now use it with dplyr’s <code>mutate</code> to make a new variable giving each doctor’s name in proper case:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;ca_docs &amp;lt;- mutate(ca_docs, proper_name = toproper(full_name))
&lt;/code&gt;&lt;/pre&gt;">ca_docs &lt;- mutate(ca_docs, proper_name = toproper(full_name))
</code></pre><p>Now let’s redraw the bar chart using these names, and improve the formatting:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;# with improved axis labels
pfizer_bars &amp;lt;- ggplot(ca_docs, aes(x=reorder(proper_name, total), y=total)) + geom_bar(stat=&quot;identity&quot;) + xlab(&quot;&quot;) + ylab(&quot;Total payments&quot;) + coord_flip()
plot(pfizer_bars)

# display dollar values, and move the names close to the start of the bars by expanding the grid just $500 from them
pfizer_bars + scale_y_continuous(label = dollar, expand=c(0,500))
&lt;/code&gt;&lt;/pre&gt;"><span class="hljs-comment"># with improved axis labels</span>
pfizer_bars &lt;- ggplot(ca_docs, aes(x=reorder(proper_name, total), y=total)) + geom_bar(stat=<span class="hljs-string">"identity"</span>) + xlab(<span class="hljs-string">""</span>) + ylab(<span class="hljs-string">"Total payments"</span>) + coord_flip()
plot(pfizer_bars)

<span class="hljs-comment"># display dollar values, and move the names close to the start of the bars by expanding the grid just $500 from them</span>
pfizer_bars + scale_y_continuous(label = dollar, expand=c(<span class="hljs-number">0</span>,<span class="hljs-number">500</span>))
</code></pre><p>This is the final bar chart:</p><p><img src="img/class6_24.jpg" alt=""></p><p>Export the bar chart as a PDF so we can edit it later in Inkscape.</p><h3 id="use-dplyr-to-filter-by-date,-and-to-join-data"><a name="use-dplyr-to-filter-by-date,-and-to-join-data" href="#use-dplyr-to-filter-by-date,-and-to-join-data"></a>Use dplyr to filter by date, and to join data</h3><p>Now import the FDA warning letters data, so we can see how R handles dates.</p><p>Examine the structure of this data:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;str(fda)
&lt;/code&gt;&lt;/pre&gt;">str(fda)
</code></pre><p>This is the output:</p><pre><code data-origin="&lt;pre&gt;&lt;code&gt;'data.frame':    272 obs. of  5 variables:
 $ name_last  : Factor w/ 253 levels &quot;ADELGLASS&quot;,&quot;ADKINSON&quot;,..: 1 2 3 4 5 6 7 8 9 10 ...
 $ name_first : Factor w/ 162 levels &quot;A.&quot;,&quot;ABDOOL&quot;,..: 70 108 96 32 59 24 33 122 119 75 ...
 $ name_middle: Factor w/ 51 levels &quot;&quot;,&quot;A&quot;,&quot;A.&quot;,&quot;AL&quot;,..: 32 18 44 1 8 28 50 1 35 13 ...
 $ issued     : Factor w/ 239 levels &quot;1996-11-19&quot;,&quot;1997-01-10&quot;,..: 29 46 77 131 122 40 53 89 111 38 ...
 $ office     : Factor w/ 8 levels &quot;Baltimore District Office&quot;,..: 4 2 3 2 3 3 2 3 3 3 ...
&lt;/code&gt;&lt;/pre&gt;">'data.frame':    272 obs. of  5 variables:
 $ name_last  : Factor w/ 253 levels "ADELGLASS","ADKINSON",..: 1 2 3 4 5 6 7 8 9 10 ...
 $ name_first : Factor w/ 162 levels "A.","ABDOOL",..: 70 108 96 32 59 24 33 122 119 75 ...
 $ name_middle: Factor w/ 51 levels "","A","A.","AL",..: 32 18 44 1 8 28 50 1 35 13 ...
 $ issued     : Factor w/ 239 levels "1996-11-19","1997-01-10",..: 29 46 77 131 122 40 53 89 111 38 ...
 $ office     : Factor w/ 8 levels "Baltimore District Office",..: 4 2 3 2 3 3 2 3 3 3 ...
</code></pre><p>Note that <code>issued</code> is being treated as a categorical variable, rather than a date. That is easy to fix:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;fda$issued &amp;lt;- as.Date(fda$issued)
&lt;/code&gt;&lt;/pre&gt;">fda$issued &lt;- as.Date(fda$issued)
</code></pre><p>Look at the structure of the data again, and this should be the output:</p><pre><code data-origin="&lt;pre&gt;&lt;code&gt;'data.frame':    272 obs. of  5 variables:
 $ name_last  : Factor w/ 253 levels &quot;ADELGLASS&quot;,&quot;ADKINSON&quot;,..: 1 2 3 4 5 6 7 8 9 10 ...
 $ name_first : Factor w/ 162 levels &quot;A.&quot;,&quot;ABDOOL&quot;,..: 70 108 96 32 59 24 33 122 119 75 ...
 $ name_middle: Factor w/ 51 levels &quot;&quot;,&quot;A&quot;,&quot;A.&quot;,&quot;AL&quot;,..: 32 18 44 1 8 28 50 1 35 13 ...
 $ issued     : Date, format: &quot;1999-05-25&quot; &quot;2000-04-19&quot; &quot;2002-01-28&quot; &quot;2004-11-17&quot; ...
 $ office     : Factor w/ 8 levels &quot;Baltimore District Office&quot;,..: 4 2 3 2 3 3 2 3 3 3 ...
&lt;/code&gt;&lt;/pre&gt;">'data.frame':    272 obs. of  5 variables:
 $ name_last  : Factor w/ 253 levels "ADELGLASS","ADKINSON",..: 1 2 3 4 5 6 7 8 9 10 ...
 $ name_first : Factor w/ 162 levels "A.","ABDOOL",..: 70 108 96 32 59 24 33 122 119 75 ...
 $ name_middle: Factor w/ 51 levels "","A","A.","AL",..: 32 18 44 1 8 28 50 1 35 13 ...
 $ issued     : Date, format: "1999-05-25" "2000-04-19" "2002-01-28" "2004-11-17" ...
 $ office     : Factor w/ 8 levels "Baltimore District Office",..: 4 2 3 2 3 3 2 3 3 3 ...
</code></pre><p>Other functions to convert variables from one format to another include:</p><ul>
<li><code>as.character</code> converts to text string</li>
<li><code>as.numeric</code> converts to number</li>
<li><code>as.factor</code> converts to categorical variable</li>
<li><code>as.integer</code> converts to integer</li>
</ul><p>Now we can use dplyr to repeat our SQL query of filtering for letters published since the start of 2005:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;post2005 &amp;lt;- filter(fda, issued &amp;gt;= &quot;2005-01-01&quot;) %&amp;gt;%
  arrange(desc(issued))
&lt;/code&gt;&lt;/pre&gt;">post2005 &lt;- filter(fda, issued &gt;= <span class="hljs-string">"2005-01-01"</span>) %&gt;%
  arrange(desc(issued))
</code></pre><p>The dplyr package can handle joins, too. This, for example, is how to run the query that identified the four doctors paid by Pfizer to run Expert-Led Forums who had also received a warning letter from the FDA:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;matches &amp;lt;- inner_join(pfizer, fda, by=c(&quot;first_name&quot; = &quot;name_first&quot;, &quot;last_name&quot; = &quot;name_last&quot;)) %&amp;gt;%
  filter(category==&quot;Expert-Led Forums&quot;)
&lt;/code&gt;&lt;/pre&gt;">matches &lt;- inner_join(pfizer, fda, by=c(<span class="hljs-string">"first_name"</span> = <span class="hljs-string">"name_first"</span>, <span class="hljs-string">"last_name"</span> = <span class="hljs-string">"name_last"</span>)) %&gt;%
  filter(category==<span class="hljs-string">"Expert-Led Forums"</span>)
</code></pre><p>dplyr actually supports a wider variety of join types than SQLite: <a href="http://stat545-ubc.github.io/bit001_dplyr-cheatsheet.html">here is a useful reference</a>.</p><h3 id="import-and-process-world-bank-data"><a name="import-and-process-world-bank-data" href="#import-and-process-world-bank-data"></a>Import and process World Bank data</h3><p>In week 5, we noted that some organizations make their available online via APIs. When working in R, it is worthwhile to run some Google searches to find out if the data you are interested in is provided via an API, and whether anyone has written an R package to import data from this API.</p><p>The <a href="https://github.com/vincentarelbundock/WDI">WDI</a> package allows  a wealth of <a href="Explain WDI package gives access to World Bank indicators. http://data.worldbank.org/indicator/all">data from the World Bank</a> to be imported into R from the World Bank <a href="http://data.worldbank.org/node/9">API</a>.</p><p>You can search for indicators containing key words, such as “gdp,” using the following code:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;WDIsearch(&quot;gdp&quot;)
&lt;/code&gt;&lt;/pre&gt;">WDIsearch(<span class="hljs-string">"gdp"</span>)
</code></pre><p>Having identified which indicators you want to import, create a list of them:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;indic_list &amp;lt;- c(&quot;NY.GDP.PCAP.PP.KD&quot;,&quot;SP.DYN.LE00.IN&quot;,&quot;SH.XPD.PCAP.PP.KD&quot;,&quot;SP.DYN.IMRT.IN&quot;,&quot;SP.DYN.TFRT.IN&quot;)
&lt;/code&gt;&lt;/pre&gt;">indic_list &lt;- c(<span class="hljs-string">"NY.GDP.PCAP.PP.KD"</span>,<span class="hljs-string">"SP.DYN.LE00.IN"</span>,<span class="hljs-string">"SH.XPD.PCAP.PP.KD"</span>,<span class="hljs-string">"SP.DYN.IMRT.IN"</span>,<span class="hljs-string">"SP.DYN.TFRT.IN"</span>)
</code></pre><p>Now import the data for all countries and all available years (the data go back at most to 1960):</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;indicators &amp;lt;- WDI(indicator=indic_list, country=&quot;all&quot;, start=1960, end=2014)
&lt;/code&gt;&lt;/pre&gt;">indicators &lt;- WDI(indicator=indic_list, country=<span class="hljs-string">"all"</span>, start=<span class="hljs-number">1960</span>, end=<span class="hljs-number">2014</span>)
</code></pre><p>This code will take a little time to run. Once the data imports, you will see a column for each indicator, plus three columns giving the year, country (or group of countries), and a two-letter identifying code for each country.</p><p>The indicators are:</p><ul>
<li><code>NY.GDP.PCAP.PP.KD</code> <a href="http://data.worldbank.org/indicator/NY.GDP.PCAP.PP.KD">GPD per capita, purchasing power parity (constant 2011 $)</a></li>
<li><code>SP.DYN.LE00.IN</code> <a href="http://data.worldbank.org/indicator/SP.DYN.LE00.IN">Life expectancy at birth (years)</a></li>
<li><code>SH.XPD.PCAP.PP.KD</code> <a href="http://data.worldbank.org/indicator/SH.XPD.PCAP.PP.KD">Health expenditure per capita. purchasing power parity (constant 2005 $)</a></li>
<li><code>SP.DYN.IMRT.IN</code> <a href="http://data.worldbank.org/indicator/SP.DYN.IMRT.IN">Infant mortality rate (per 1,000 live births)</a></li>
<li><code>SP.DYN.TFRT.IN</code> <a href="SP.DYN.TFRT.IN">Fertility rate (births per woman)</a></li>
</ul><p>First we will filter this data to use later for maps showing GDP per capita by country for each year from 2009 to 2013.</p><p>Use dplyr to select the data we want:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;gdp_pc &amp;lt;- select(indicators, year, iso2c, country, NY.GDP.PCAP.PP.KD) %&amp;gt;%
  filter(year &amp;gt;= 2009)
&lt;/code&gt;&lt;/pre&gt;">gdp_pc &lt;- select(indicators, year, iso2c, country, NY.GDP.PCAP.PP.KD) %&gt;%
  filter(year &gt;= <span class="hljs-number">2009</span>)
</code></pre><p>Look at the data, which is in long format. To join to our map, we will need the data in a wide format, with each year’s values in a separate column. So we need to use tidyr’s <code>spread</code> function.</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;gdp_pc_wide &amp;lt;- spread(gdp_pc, year, NY.GDP.PCAP.PP.KD)
&lt;/code&gt;&lt;/pre&gt;">gdp_pc_wide &lt;- spread(gdp_pc, year, NY.GDP.PCAP.PP.KD)
</code></pre><p>Now export this data:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;write.table(gdp_pc_wide, &quot;PathtoFile/gdp_pc.txt&quot;, row.names = FALSE, sep = &quot;\t&quot;, na = &quot;-99&quot;)
&lt;/code&gt;&lt;/pre&gt;">write.table(gdp_pc_wide, <span class="hljs-string">"PathtoFile/gdp_pc.txt"</span>, row.names = <span class="hljs-literal">FALSE</span>, sep = <span class="hljs-string">"\t"</span>, na = <span class="hljs-string">"-99"</span>)
</code></pre><p>This is one of the files we used to demonstrate a SQL <code>LEFT JOIN</code> in Week 4. Note that we have set the null <code>na</code> values as -99.</p><p>Just for practice with tidyr’s <code>gather</code> function, let’s convert the data back to long format:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;gdp_pc_long &amp;lt;- gather(gdp_pc_wide, year, gdp_pc, -iso2c, -country)
&lt;/code&gt;&lt;/pre&gt;">gdp_pc_long &lt;- gather(gdp_pc_wide, year, gdp_pc, -iso2c, -country)
</code></pre><h3 id="draw-charts-illustrating-development-of-the-brics-nations-from-world-bank-data"><a name="draw-charts-illustrating-development-of-the-brics-nations-from-world-bank-data" href="#draw-charts-illustrating-development-of-the-brics-nations-from-world-bank-data"></a>Draw charts illustrating development of the BRICS nations from World Bank data</h3><p>Now let’s draw some charts from the World Bank data. I selected these indicators to look at the wealth and well-being of the BRICS nations: Brazil, Russia, India, China and South Africa.</p><p>BRICs is a grouping of the world’s five most important emerging economies. However, the  circumstances of their recent economic growth and development are rather different, so there should be interesting stories to tell about the differences between these countries by charting these indicators.</p><p>First, filter the imported data using dplyr to focus on the BRICS nations from 1990 onwards:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;brics &amp;lt;- filter(indicators, (iso2c==&quot;BR&quot; | iso2c==&quot;CN&quot; | iso2c==&quot;IN&quot; | iso2c==&quot;RU&quot; | iso2c==&quot;ZA&quot;) &amp;amp; year &amp;gt;= 1990)
&lt;/code&gt;&lt;/pre&gt;">brics &lt;- filter(indicators, (iso2c==<span class="hljs-string">"BR"</span> | iso2c==<span class="hljs-string">"CN"</span> | iso2c==<span class="hljs-string">"IN"</span> | iso2c==<span class="hljs-string">"RU"</span> | iso2c==<span class="hljs-string">"ZA"</span>) &amp; year &gt;= <span class="hljs-number">1990</span>)
</code></pre><p>In making charts from this data, we will use palettes from ColorBrewer, so let’s look at the possibilities allowed by RColorBrewer:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;display.brewer.all()
&lt;/code&gt;&lt;/pre&gt;">display.brewer.all()
</code></pre><p><img src="img/class6_25.jpg" alt=""></p><p>This image is worth exporting as PDF and saving for future reference.</p><p>First let’s draw a line chart, showing how GDP per capita has changed over time for each of the five countries, using the ColorBrewer <code>Set1</code> qualitative color scheme:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;ggplot(brics, aes(x=year, y=NY.GDP.PCAP.PP.KD)) + geom_line(aes(color=country), size=2) + scale_color_brewer(palette = &quot;Set1&quot;)
&lt;/code&gt;&lt;/pre&gt;">ggplot(brics, aes(x=year, y=NY.GDP.PCAP.PP.KD)) + geom_line(aes(color=country), size=<span class="hljs-number">2</span>) + scale_color_brewer(palette = <span class="hljs-string">"Set1"</span>)
</code></pre><p><img src="img/class6_26.jpg" alt=""></p><p>Already, this chart shows some interesting differences between the five nations. Notice, for instance, how Brazil, South Africa and particularly Russia were affected by the financial crisis of 2007-8, while growth of GDP per capita in India and China was apparently unaffected. China’s rapidly growing wealth stands out clearly, while Russia’s trajectory is especially interesting. Its economy initially slumped, but turned around sharply in the late 1990s.</p><p>To draw similar charts for the other variables, we could repeat this code, substituting in each of the variable names. But that is rather cumbersome. We already have a list of the variable names in the object <code>indic_list</code>. So we can write “for” loop to iterate over each variable in that list and draw a similar chart for each one:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;for (i in indic_list) {
  brics_line &amp;lt;- ggplot(brics, aes_string(x=&quot;year&quot;, y=i)) + geom_line(aes(color=country), size=2) + scale_color_brewer(palette = &quot;Set1&quot;)
  plot(brics_line)
}
&lt;/code&gt;&lt;/pre&gt;"><span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> indic_list) {
  brics_line &lt;- ggplot(brics, aes_string(x=<span class="hljs-string">"year"</span>, y=i)) + geom_line(aes(color=country), size=<span class="hljs-number">2</span>) + scale_color_brewer(palette = <span class="hljs-string">"Set1"</span>)
  plot(brics_line)
}
</code></pre><p>For loops allow repetitive tasks to be run efficiently with a minimum of code.</p><p>You may be wondering why we used <code>aes_string</code> rather than <code>aes</code> to map the data values to the axes. This is because items in <code>indic_list</code> are strings of text, which refer to the variables in the data, rather than the variables themselves. You can see that by typing <code>str(indic_list)</code>, which gives the following output:</p><pre><code data-origin="&lt;pre&gt;&lt;code&gt;chr [1:5] &quot;NY.GDP.PCAP.PP.KD&quot; &quot;SP.DYN.LE00.IN&quot; &quot;SH.XPD.PCAP.PP.KD&quot; &quot;SP.DYN.IMRT.IN&quot; ...
&lt;/code&gt;&lt;/pre&gt;">chr [1:5] "NY.GDP.PCAP.PP.KD" "SP.DYN.LE00.IN" "SH.XPD.PCAP.PP.KD" "SP.DYN.IMRT.IN" ...
</code></pre><p>Using <code>aes_string</code>, we also need to specify <code>"year"</code> in quote marks, so that it is similarly cast as a text string referring to a variable in the data.</p><p>Note also that each chart in the for loop needs to saved as an object and then plotted; the code will not work if you just start with <code>ggplot</code>.</p><p>Use the arrows in the <code>Plots</code> tab to explore the charts drawn by the loop.</p><p>Now let’s draw a Gapminder-style trajectory trajectory for each country over time showing how life expectancy has varied with GDP per capita:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;ggplot(brics, aes(x=NY.GDP.PCAP.PP.KD, y=SP.DYN.LE00.IN, color=country)) + geom_point() + geom_path() + scale_color_brewer(palette = &quot;Set1&quot;) + geom_text(aes(label=year), size=4, hjust=-0.2)
&lt;/code&gt;&lt;/pre&gt;">ggplot(brics, aes(x=NY.GDP.PCAP.PP.KD, y=SP.DYN.LE00.IN, color=country)) + geom_point() + geom_path() + scale_color_brewer(palette = <span class="hljs-string">"Set1"</span>) + geom_text(aes(label=year), size=<span class="hljs-number">4</span>, hjust=-<span class="hljs-number">0.2</span>)
</code></pre><p><img src="img/class6_27.jpg" alt=""></p><p>The <code>geom_path</code> function draws a line through the points in the original order in which they appear in the data. In this case, the data was already in chronological order. If not, we could use dplyr’s <code>arrange</code> fucntion to order the data before plotting.</p><p>The year labels make the chart look messy, but are worth including in the first instance so we know the direction of the trajectories over time. You can experiment with <code>hjust</code> to see how it affects the labels’ horizontal position.</p><p>We have used the <code>Set1</code> qualitative palette to color the countries. This is not ideal, given that the red and green will create problems for colorblind people — however, there is no fully colorblind-safe qualitative ColorBrewer palette for five categories. (Note also that ColorBrewer is actually baked into ggplot2, so that the package didn’t actually need to be loaded, other than to review the available options.)</p><p>Again, we can write a for loop to draw similar plots to see how each of the variables have varied against GDP per capita over time:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;for (i in indic_list) {
  brics_path &amp;lt;- ggplot(brics, aes_string(x=&quot;NY.GDP.PCAP.PP.KD&quot;, y=i, color=&quot;country&quot;, label=&quot;year&quot;)) + geom_point() + geom_path() + scale_color_brewer(palette = &quot;Set1&quot;) + geom_text(aes(label=year), size=4, hjust=-0.2)
  plot(brics_path)
}
&lt;/code&gt;&lt;/pre&gt;"><span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> indic_list) {
  brics_path &lt;- ggplot(brics, aes_string(x=<span class="hljs-string">"NY.GDP.PCAP.PP.KD"</span>, y=i, color=<span class="hljs-string">"country"</span>, label=<span class="hljs-string">"year"</span>)) + geom_point() + geom_path() + scale_color_brewer(palette = <span class="hljs-string">"Set1"</span>) + geom_text(aes(label=year), size=<span class="hljs-number">4</span>, hjust=-<span class="hljs-number">0.2</span>)
  plot(brics_path)
}
</code></pre><p>Again, use the arrows in the <code>Plots</code> tab to look at the charts drawn by the loop. The GDP per capita versus life expectancy chart still seems the most interesting, so let’s continue to work with that.</p><p>First save and draw the basic plot, omitting the “year” labels to remove clutter, and improving the formatting of the axes:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;brics_gdp_le &amp;lt;- ggplot(brics, aes(x=NY.GDP.PCAP.PP.KD, y=SP.DYN.LE00.IN, color=country)) + geom_point() + geom_path() + ylab(&quot;Life expectancy at birth (years)&quot;) + xlab(&quot;GDP per capita&quot;) + scale_x_continuous(labels = dollar) + scale_color_brewer(palette = &quot;Set1&quot;)
plot(brics_gdp_le)
&lt;/code&gt;&lt;/pre&gt;">brics_gdp_le &lt;- ggplot(brics, aes(x=NY.GDP.PCAP.PP.KD, y=SP.DYN.LE00.IN, color=country)) + geom_point() + geom_path() + ylab(<span class="hljs-string">"Life expectancy at birth (years)"</span>) + xlab(<span class="hljs-string">"GDP per capita"</span>) + scale_x_continuous(labels = dollar) + scale_color_brewer(palette = <span class="hljs-string">"Set1"</span>)
plot(brics_gdp_le)
</code></pre><p><img src="img/class6_28.jpg" alt=""></p><p>It can sometimes be useful to create “faceted” plots, drawing multiple versions of a chart for each value of a categorical variable. So let’s do that, creating one chart for each country:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;brics_gdp_le + facet_wrap(~country)
&lt;/code&gt;&lt;/pre&gt;">brics_gdp_le + facet_wrap(~country)
</code></pre><p><img src="img/class6_29.jpg" alt=""></p><p>In this case the single chart looks better, so we will stick with that.</p><p>Now let’s add another variable, sizing the points according to the infant mortality rate:</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;brics_gdp_le + geom_point(aes(size=SP.DYN.IMRT.IN))
&lt;/code&gt;&lt;/pre&gt;">brics_gdp_le + geom_point(aes(size=SP.DYN.IMRT.IN))
</code></pre><p><img src="img/class6_30.jpg" alt=""></p><p>There is a problem here: The bubbles aren’t sized correctly by area. So let’s fix that, remove the color legend, and also make the legend for infant mortality a little more informative (note that <code>\n</code> in the code for the legend name inserts a new line at that position.):</p><pre><code class="r hljs" data-origin="&lt;pre&gt;&lt;code class=&quot;r&quot;&gt;brics_gdp_le + geom_point(aes(size=SP.DYN.IMRT.IN)) + scale_size_area(name=&quot;Infant mortality \n(per 1,000 live births)&quot;) + guides(color=FALSE)
&lt;/code&gt;&lt;/pre&gt;">brics_gdp_le + geom_point(aes(size=SP.DYN.IMRT.IN)) + scale_size_area(name=<span class="hljs-string">"Infant mortality \n(per 1,000 live births)"</span>) + guides(color=<span class="hljs-literal">FALSE</span>)
</code></pre><p><img src="img/class6_31.jpg" alt=""></p><p>We will edit and annotate this chart in Inkscape later, so save this as a PDF.</p><h3 id="assignment"><a name="assignment" href="#assignment"></a>Assignment</h3><ul>
<li>Draw a line chart showing GDP per capita over time since 1990 for the <a href="http://en.wikipedia.org/wiki/G8">G8</a> members. Customize as you see fit using R code to give a pleasing and informative display.</li>
<li>Do some background research to allow you to annotate the final chart on the BRICS nations. In particular, what may explain the unusual trajectories of South Africa and Russia, respectively?</li>
<li>Send me a PDF of your line chart, the R code you used to filter the data and draw the chart, and some brief notes for annotating the BRICS chart in next week’s class.</li>
</ul><h3 id="further-reading"><a name="further-reading" href="#further-reading"></a>Further reading</h3><p>Winston Chang: <a href="http://www.amazon.com/R-Graphics-Cookbook-Winston-Chang/dp/1449316956"><em>R Graphics Cookbook</em></a><br>(Chang also has <a href="http://www.cookbook-r.com/">a helpful website</a> with much of the same information, available for free.)</p><p>Hadley Wickham: <a href="http://www.amazon.com/gp/product/0387981403/"><em>ggplot2: Elegant Graphics For Data Analysis</em></a></p><p><a href="http://docs.ggplot2.org/current/">ggplot2 Documentation</a></p><p><a href="http://stackoverflow.com/">Stack Overflow</a><br>Search the site, or <a href="http://stackoverflow.com/questions/tagged/r">browse R questions</a></p>

	</div> <!-- /.container all -->
	<script src="http://code.jquery.com/jquery.min.js"></script>
	<script src="../../js/bootstrap.min.js"></script>
</body>
</html>
