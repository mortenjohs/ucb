<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>class11.html</title>
  <meta name="generator" content="Haroopad 0.13.1" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>div.oembedall-githubrepos{border:1px solid #DDD;border-radius:4px;list-style-type:none;margin:0 0 10px;padding:8px 10px 0;font:13.34px/1.4 helvetica,arial,freesans,clean,sans-serif;width:452px;background-color:#fff}div.oembedall-githubrepos .oembedall-body{background:-moz-linear-gradient(center top,#FAFAFA,#EFEFEF);background:-webkit-gradient(linear,left top,left bottom,from(#FAFAFA),to(#EFEFEF));border-bottom-left-radius:4px;border-bottom-right-radius:4px;border-top:1px solid #EEE;margin-left:-10px;margin-top:8px;padding:5px 10px;width:100%}div.oembedall-githubrepos h3{font-size:14px;margin:0;padding-left:18px;white-space:nowrap}div.oembedall-githubrepos p.oembedall-description{color:#444;font-size:12px;margin:0 0 3px}div.oembedall-githubrepos p.oembedall-updated-at{color:#888;font-size:11px;margin:0}div.oembedall-githubrepos ul.oembedall-repo-stats{border:none;float:right;font-size:11px;font-weight:700;padding-left:15px;position:relative;z-index:5;margin:0}div.oembedall-githubrepos ul.oembedall-repo-stats li{border:none;color:#666;display:inline-block;list-style-type:none;margin:0!important}div.oembedall-githubrepos ul.oembedall-repo-stats li a{background-color:transparent;border:none;color:#666!important;background-position:5px -2px;background-repeat:no-repeat;border-left:1px solid #DDD;display:inline-block;height:21px;line-height:21px;padding:0 5px 0 23px}div.oembedall-githubrepos ul.oembedall-repo-stats li:first-child a{border-left:medium none;margin-right:-3px}div.oembedall-githubrepos ul.oembedall-repo-stats li a:hover{background:5px -27px no-repeat #4183C4;color:#FFF!important;text-decoration:none}div.oembedall-githubrepos ul.oembedall-repo-stats li:first-child a:hover{border-bottom-left-radius:3px;border-top-left-radius:3px}ul.oembedall-repo-stats li:last-child a:hover{border-bottom-right-radius:3px;border-top-right-radius:3px}span.oembedall-closehide{background-color:#aaa;border-radius:2px;cursor:pointer;margin-right:3px}div.oembedall-container{margin-top:5px;text-align:left}.oembedall-ljuser{font-weight:700}.oembedall-ljuser img{vertical-align:bottom;border:0;padding-right:1px}.oembedall-stoqembed{border-bottom:1px dotted #999;float:left;overflow:hidden;width:730px;line-height:1;background:#FFF;color:#000;font-family:Arial,Liberation Sans,DejaVu Sans,sans-serif;font-size:80%;text-align:left;margin:0;padding:0}.oembedall-stoqembed a{color:#07C;text-decoration:none;margin:0;padding:0}.oembedall-stoqembed a:hover{text-decoration:underline}.oembedall-stoqembed a:visited{color:#4A6B82}.oembedall-stoqembed h3{font-family:Trebuchet MS,Liberation Sans,DejaVu Sans,sans-serif;font-size:130%;font-weight:700;margin:0;padding:0}.oembedall-stoqembed .oembedall-reputation-score{color:#444;font-size:120%;font-weight:700;margin-right:2px}.oembedall-stoqembed .oembedall-user-info{height:35px;width:185px}.oembedall-stoqembed .oembedall-user-info .oembedall-user-gravatar32{float:left;height:32px;width:32px}.oembedall-stoqembed .oembedall-user-info .oembedall-user-details{float:left;margin-left:5px;overflow:hidden;white-space:nowrap;width:145px}.oembedall-stoqembed .oembedall-question-hyperlink{font-weight:700}.oembedall-stoqembed .oembedall-stats{background:#EEE;margin:0 0 0 7px;padding:4px 7px 6px;width:58px}.oembedall-stoqembed .oembedall-statscontainer{float:left;margin-right:8px;width:86px}.oembedall-stoqembed .oembedall-votes{color:#555;padding:0 0 7px;text-align:center}.oembedall-stoqembed .oembedall-vote-count-post{font-size:240%;color:#808185;display:block;font-weight:700}.oembedall-stoqembed .oembedall-views{color:#999;padding-top:4px;text-align:center}.oembedall-stoqembed .oembedall-status{margin-top:-3px;padding:4px 0;text-align:center;background:#75845C;color:#FFF}.oembedall-stoqembed .oembedall-status strong{color:#FFF;display:block;font-size:140%}.oembedall-stoqembed .oembedall-summary{float:left;width:635px}.oembedall-stoqembed .oembedall-excerpt{line-height:1.2;margin:0;padding:0 0 5px}.oembedall-stoqembed .oembedall-tags{float:left;line-height:18px}.oembedall-stoqembed .oembedall-tags a:hover{text-decoration:none}.oembedall-stoqembed .oembedall-post-tag{background-color:#E0EAF1;border-bottom:1px solid #3E6D8E;border-right:1px solid #7F9FB6;color:#3E6D8E;font-size:90%;line-height:2.4;margin:2px 2px 2px 0;padding:3px 4px;text-decoration:none;white-space:nowrap}.oembedall-stoqembed .oembedall-post-tag:hover{background-color:#3E6D8E;border-bottom:1px solid #37607D;border-right:1px solid #37607D;color:#E0EAF1}.oembedall-stoqembed .oembedall-fr{float:right}.oembedall-stoqembed .oembedall-statsarrow{background-image:url(http://cdn.sstatic.net/stackoverflow/img/sprites.png?v=3);background-repeat:no-repeat;overflow:hidden;background-position:0 -435px;float:right;height:13px;margin-top:12px;width:7px}.oembedall-facebook1{border:1px solid #1A3C6C;padding:0;font:13.34px/1.4 verdana;width:500px}.oembedall-facebook2{background-color:#627add}.oembedall-facebook2 a{color:#e8e8e8;text-decoration:none}.oembedall-facebookBody{background-color:#fff;vertical-align:top;padding:5px}.oembedall-facebookBody .contents{display:inline-block;width:100%}.oembedall-facebookBody div img{float:left;margin-right:5px}div.oembedall-lanyard{-webkit-box-shadow:none;-webkit-transition-delay:0s;-webkit-transition-duration:.4000000059604645s;-webkit-transition-property:width;-webkit-transition-timing-function:cubic-bezier(0.42,0,.58,1);background-attachment:scroll;background-clip:border-box;background-color:transparent;background-image:none;background-origin:padding-box;border-width:0;box-shadow:none;color:#112644;display:block;float:left;font-family:'Trebuchet MS',Trebuchet,sans-serif;font-size:16px;height:253px;line-height:19px;margin:0;max-width:none;min-height:0;outline:#112644 0;overflow-x:visible;overflow-y:visible;padding:0;position:relative;text-align:left;vertical-align:baseline;width:804px}div.oembedall-lanyard .tagline{font-size:1.5em}div.oembedall-lanyard .wrapper{overflow:hidden;clear:both}div.oembedall-lanyard .split{float:left;display:inline}div.oembedall-lanyard .prominent-place .flag:active,div.oembedall-lanyard .prominent-place .flag:focus,div.oembedall-lanyard .prominent-place .flag:hover,div.oembedall-lanyard .prominent-place .flag:link,div.oembedall-lanyard .prominent-place .flag:visited{float:left;display:block;width:48px;height:48px;position:relative;top:-5px;margin-right:10px}div.oembedall-lanyard .place-context{font-size:.889em}div.oembedall-lanyard .prominent-place .sub-place{display:block}div.oembedall-lanyard .prominent-place{font-size:1.125em;line-height:1.1em;font-weight:400}div.oembedall-lanyard .main-date{color:#8CB4E0;font-weight:700;line-height:1.1}div.oembedall-lanyard .first{width:48.57%;margin:0 0 0 2.857%}.mermaid .label{color:#333}.node circle,.node polygon,.node rect{fill:#cde498;stroke:#13540c;stroke-width:1px}.edgePath .path{stroke:green;stroke-width:1.5px}.cluster rect{fill:#cdffb2;rx:40;stroke:#6eaa49;stroke-width:1px}.cluster text{fill:#333}.actor{stroke:#13540c;fill:#cde498}text.actor{fill:#000;stroke:none}.actor-line{stroke:grey}.messageLine0{stroke-width:1.5;stroke-dasharray:"2 2";marker-end:"url(#arrowhead)";stroke:#333}.messageLine1{stroke-width:1.5;stroke-dasharray:"2 2";stroke:#333}#arrowhead{fill:#333}#crosshead path{fill:#333!important;stroke:#333!important}.messageText{fill:#333;stroke:none}.labelBox{stroke:#326932;fill:#cde498}.labelText,.loopText{fill:#000;stroke:none}.loopLine{stroke-width:2;stroke-dasharray:"2 2";marker-end:"url(#arrowhead)";stroke:#326932}.note{stroke:#6eaa49;fill:#fff5ad}.noteText{fill:#000;stroke:none;font-family:'trebuchet ms',verdana,arial;font-size:14px}.section{stroke:none;opacity:.2}.section0,.section2{fill:#6eaa49}.section1,.section3{fill:#fff;opacity:.2}.sectionTitle0,.sectionTitle1,.sectionTitle2,.sectionTitle3{fill:#333}.sectionTitle{text-anchor:start;font-size:11px;text-height:14px}.grid .tick{stroke:lightgrey;opacity:.3;shape-rendering:crispEdges}.grid path{stroke-width:0}.today{fill:none;stroke:red;stroke-width:2px}.task{stroke-width:2}.taskText{text-anchor:middle;font-size:11px}.taskTextOutsideRight{fill:#000;text-anchor:start;font-size:11px}.taskTextOutsideLeft{fill:#000;text-anchor:end;font-size:11px}.taskText0,.taskText1,.taskText2,.taskText3{fill:#fff}.task0,.task1,.task2,.task3{fill:#487e3a;stroke:#13540c}.taskTextOutside0,.taskTextOutside1,.taskTextOutside2,.taskTextOutside3{fill:#000}.active0,.active1,.active2,.active3{fill:#cde498;stroke:#13540c}.activeText0,.activeText1,.activeText2,.activeText3{fill:#000!important}.done0,.done1,.done2,.done3{stroke:grey;fill:lightgrey;stroke-width:2}.doneText0,.doneText1,.doneText2,.doneText3{fill:#000!important}.crit0,.crit1,.crit2,.crit3{stroke:#f88;fill:red;stroke-width:2}.activeCrit0,.activeCrit1,.activeCrit2,.activeCrit3{stroke:#f88;fill:#cde498;stroke-width:2}.doneCrit0,.doneCrit1,.doneCrit2,.doneCrit3{stroke:#f88;fill:lightgrey;stroke-width:2;cursor:pointer;shape-rendering:crispEdges}.activeCritText0,.activeCritText1,.activeCritText2,.activeCritText3,.doneCritText0,.doneCritText1,.doneCritText2,.doneCritText3{fill:#000!important}.titleText{text-anchor:middle;font-size:18px;fill:#000}text{font-family:'trebuchet ms',verdana,arial;font-size:14px}html{height:100%}body{margin:0!important;padding:5px 20px 26px!important;background-color:#fff;font-family:"Lucida Grande","Segoe UI","Apple SD Gothic Neo","Malgun Gothic","Lucida Sans Unicode",Helvetica,Arial,sans-serif;font-size:.9em;overflow-x:hidden;overflow-y:auto}br,h1,h2,h3,h4,h5,h6{clear:both}hr.page{background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC) repeat-x;border:0;height:3px;padding:0}hr.underscore{border-top-style:dashed!important}body >:first-child{margin-top:0!important}img.plugin{box-shadow:0 1px 3px rgba(0,0,0,.1);border-radius:3px}iframe{border:0}figure{-webkit-margin-before:0;-webkit-margin-after:0;-webkit-margin-start:0;-webkit-margin-end:0}kbd{border:1px solid #aaa;-moz-border-radius:2px;-webkit-border-radius:2px;border-radius:2px;-moz-box-shadow:1px 2px 2px #ddd;-webkit-box-shadow:1px 2px 2px #ddd;box-shadow:1px 2px 2px #ddd;background-color:#f9f9f9;background-image:-moz-linear-gradient(top,#eee,#f9f9f9,#eee);background-image:-o-linear-gradient(top,#eee,#f9f9f9,#eee);background-image:-webkit-linear-gradient(top,#eee,#f9f9f9,#eee);background-image:linear-gradient(top,#eee,#f9f9f9,#eee);padding:1px 3px;font-family:inherit;font-size:.85em}.oembeded .oembed_photo{display:inline-block}img[data-echo]{margin:25px 0;width:100px;height:100px;background:url(../img/ajax.gif) center center no-repeat #fff}.spinner{display:inline-block;width:10px;height:10px;margin-bottom:-.1em;border:2px solid rgba(0,0,0,.5);border-top-color:transparent;border-radius:100%;-webkit-animation:spin 1s infinite linear;animation:spin 1s infinite linear}.spinner:after{content:'';display:block;width:0;height:0;position:absolute;top:-6px;left:0;border:4px solid transparent;border-bottom-color:rgba(0,0,0,.5);-webkit-transform:rotate(45deg);transform:rotate(45deg)}@-webkit-keyframes spin{to{-webkit-transform:rotate(360deg)}}@keyframes spin{to{transform:rotate(360deg)}}p.toc{margin:0!important}p.toc ul{padding-left:10px}p.toc>ul{padding:10px;margin:0 10px;display:inline-block;border:1px solid #ededed;border-radius:5px}p.toc li,p.toc ul{list-style-type:none}p.toc li{width:100%;padding:0;overflow:hidden}p.toc li a::after{content:"."}p.toc li a:before{content:"• "}p.toc h5{text-transform:uppercase}p.toc .title{float:left;padding-right:3px}p.toc .number{margin:0;float:right;padding-left:3px;background:#fff;display:none}input.task-list-item{margin-left:-1.62em}.markdown{font-family:"Hiragino Sans GB","Microsoft YaHei",STHeiti,SimSun,"Lucida Grande","Lucida Sans Unicode","Lucida Sans",'Segoe UI',AppleSDGothicNeo-Medium,'Malgun Gothic',Verdana,Tahoma,sans-serif;padding:20px}.markdown a{text-decoration:none;vertical-align:baseline}.markdown a:hover{text-decoration:underline}.markdown h1{font-size:2.2em;font-weight:700;margin:1.5em 0 1em}.markdown h2{font-size:1.8em;font-weight:700;margin:1.275em 0 .85em}.markdown h3{font-size:1.6em;font-weight:700;margin:1.125em 0 .75em}.markdown h4{font-size:1.4em;font-weight:700;margin:.99em 0 .66em}.markdown h5{font-size:1.2em;font-weight:700;margin:.855em 0 .57em}.markdown h6{font-size:1em;font-weight:700;margin:.75em 0 .5em}.markdown h1+p,.markdown h1:first-child,.markdown h2+p,.markdown h2:first-child,.markdown h3+p,.markdown h3:first-child,.markdown h4+p,.markdown h4:first-child,.markdown h5+p,.markdown h5:first-child,.markdown h6+p,.markdown h6:first-child{margin-top:0}.markdown hr{border:1px solid #ccc}.markdown p{margin:1em 0;word-wrap:break-word}.markdown ol{list-style-type:decimal}.markdown li{display:list-item;line-height:1.4em}.markdown blockquote{margin:1em 20px}.markdown blockquote>:first-child{margin-top:0}.markdown blockquote>:last-child{margin-bottom:0}.markdown blockquote cite:before{content:'\2014 \00A0'}.markdown .code{border-radius:3px;word-wrap:break-word}.markdown pre{border-radius:3px;word-wrap:break-word;border:1px solid #ccc;overflow:auto;padding:.5em}.markdown pre code{border:0;display:block}.markdown pre>code{font-family:Consolas,Inconsolata,Courier,monospace;font-weight:700;white-space:pre;margin:0}.markdown code{border-radius:3px;word-wrap:break-word;border:1px solid #ccc;padding:0 5px;margin:0 2px}.markdown img{max-width:100%}.markdown mark{color:#000;background-color:#fcf8e3}.markdown table{padding:0;border-collapse:collapse;border-spacing:0;margin-bottom:16px}.markdown table tr td,.markdown table tr th{border:1px solid #ccc;margin:0;padding:6px 13px}.markdown table tr th{font-weight:700}.markdown table tr th>:first-child{margin-top:0}.markdown table tr th>:last-child{margin-bottom:0}.markdown table tr td>:first-child{margin-top:0}.markdown table tr td>:last-child{margin-bottom:0}.github{padding:20px;font-family:"Helvetica Neue",Helvetica,"Hiragino Sans GB","Microsoft YaHei",STHeiti,SimSun,"Segoe UI",AppleSDGothicNeo-Medium,'Malgun Gothic',Arial,freesans,sans-serif;font-size:15px;background:#fff;line-height:1.6;-webkit-font-smoothing:antialiased}.github a{color:#3269a0}.github a:hover{color:#4183c4}.github h2{border-bottom:1px solid #e6e6e6;line-height:1.6}.github h6{color:#777}.github hr{border:1px solid #e6e6e6}.github pre>code{font-size:.9em;font-family:Consolas,Inconsolata,Courier,monospace}.github blockquote>code,.github h1>code,.github h2>code,.github h3>code,.github h4>code,.github h5>code,.github h6>code,.github li>code,.github p>code,.github td>code{background-color:rgba(0,0,0,.07);font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;font-size:85%;padding:.2em .5em;border:0}.github blockquote{border-left:4px solid #e6e6e6;padding:0 15px;font-style:italic}.github table{background-color:#fafafa}.github table tr td,.github table tr th{border:1px solid #e6e6e6}.github table tr:nth-child(2n){background-color:#f2f2f2}.hljs{display:block;overflow-x:auto;padding:.5em;background:#f0f0f0;-webkit-text-size-adjust:none}.hljs,.hljs-subst,.hljs-tag .hljs-title,.nginx .hljs-title{color:#000}.apache .hljs-cbracket,.apache .hljs-tag,.asciidoc .hljs-header,.bash .hljs-variable,.coffeescript .hljs-attribute,.django .hljs-variable,.erlang_repl .hljs-function_or_atom,.haml .hljs-symbol,.hljs-addition,.hljs-constant,.hljs-flow,.hljs-parent,.hljs-pragma,.hljs-preprocessor,.hljs-rules .hljs-value,.hljs-stream,.hljs-string,.hljs-tag .hljs-value,.hljs-template_tag,.hljs-title,.markdown .hljs-header,.ruby .hljs-symbol,.ruby .hljs-symbol .hljs-string,.smalltalk .hljs-class,.tex .hljs-command,.tex .hljs-special{color:#800}.asciidoc .hljs-blockquote,.diff .hljs-header,.hljs-annotation,.hljs-chunk,.hljs-comment,.markdown .hljs-blockquote,.smartquote{color:#888}.asciidoc .hljs-bullet,.asciidoc .hljs-link_url,.go .hljs-constant,.hljs-change,.hljs-date,.hljs-hexcolor,.hljs-literal,.hljs-number,.hljs-regexp,.lasso .hljs-variable,.makefile .hljs-variable,.markdown .hljs-bullet,.markdown .hljs-link_url,.smalltalk .hljs-char,.smalltalk .hljs-symbol{color:#080}.apache .hljs-sqbracket,.asciidoc .hljs-attribute,.asciidoc .hljs-link_label,.clojure .hljs-attribute,.coffeescript .hljs-property,.erlang_repl .hljs-reserved,.haml .hljs-bullet,.hljs-array,.hljs-attr_selector,.hljs-decorator,.hljs-deletion,.hljs-doctype,.hljs-envvar,.hljs-filter .hljs-argument,.hljs-important,.hljs-javadoc,.hljs-label,.hljs-localvars,.hljs-phony,.hljs-pi,.hljs-prompt,.hljs-pseudo,.hljs-shebang,.lasso .hljs-attribute,.markdown .hljs-link_label,.nginx .hljs-built_in,.ruby .hljs-string,.tex .hljs-formula,.vhdl .hljs-attribute{color:#88f}.apache .hljs-tag,.asciidoc .hljs-strong,.bash .hljs-variable,.css .hljs-tag,.hljs-built_in,.hljs-dartdoc,.hljs-id,.hljs-javadoctag,.hljs-keyword,.hljs-phpdoc,.hljs-request,.hljs-status,.hljs-title,.hljs-type,.hljs-typename,.hljs-winutils,.hljs-yardoctag,.markdown .hljs-strong,.smalltalk .hljs-class,.tex .hljs-command{font-weight:700}.asciidoc .hljs-emphasis,.markdown .hljs-emphasis{font-style:italic}.nginx .hljs-built_in{font-weight:400}.coffeescript .javascript,.javascript .xml,.lasso .markup,.tex .hljs-formula,.xml .css,.xml .hljs-cdata,.xml .javascript,.xml .vbscript{opacity:.5}.MathJax_Hover_Frame{border-radius:.25em;-webkit-border-radius:.25em;-moz-border-radius:.25em;-khtml-border-radius:.25em;box-shadow:0 0 15px #83A;-webkit-box-shadow:0 0 15px #83A;-moz-box-shadow:0 0 15px #83A;-khtml-box-shadow:0 0 15px #83A;border:1px solid #A6D!important;display:inline-block;position:absolute}.MathJax_Hover_Arrow{position:absolute;width:15px;height:11px;cursor:pointer}#MathJax_About{position:fixed;left:50%;width:auto;text-align:center;border:3px outset;padding:1em 2em;background-color:#DDD;color:#000;cursor:default;font-family:message-box;font-size:120%;font-style:normal;text-indent:0;text-transform:none;line-height:normal;letter-spacing:normal;word-spacing:normal;word-wrap:normal;white-space:nowrap;float:none;z-index:201;border-radius:15px;-webkit-border-radius:15px;-moz-border-radius:15px;-khtml-border-radius:15px;box-shadow:0 10px 20px gray;-webkit-box-shadow:0 10px 20px gray;-moz-box-shadow:0 10px 20px gray;-khtml-box-shadow:0 10px 20px gray;filter:progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}.MathJax_Menu{position:absolute;background-color:#fff;color:#000;width:auto;padding:5px 0;border:1px solid #CCC;margin:0;cursor:default;font:menu;text-align:left;text-indent:0;text-transform:none;line-height:normal;letter-spacing:normal;word-spacing:normal;word-wrap:normal;white-space:nowrap;float:none;z-index:201;border-radius:5px;-webkit-border-radius:5px;-moz-border-radius:5px;-khtml-border-radius:5px;box-shadow:0 10px 20px gray;-webkit-box-shadow:0 10px 20px gray;-moz-box-shadow:0 10px 20px gray;-khtml-box-shadow:0 10px 20px gray;filter:progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}.MathJax_MenuItem{padding:1px 2em;background:0 0}.MathJax_MenuArrow{position:absolute;right:.5em;color:#666}.MathJax_MenuActive .MathJax_MenuArrow{color:#fff}.MathJax_MenuArrow.RTL{left:.5em;right:auto}.MathJax_MenuCheck{position:absolute;left:.7em}.MathJax_MenuCheck.RTL{right:.7em;left:auto}.MathJax_MenuRadioCheck{position:absolute;left:.7em}.MathJax_MenuRadioCheck.RTL{right:.7em;left:auto}.MathJax_MenuLabel{padding:1px 2em 3px 1.33em;font-style:italic}.MathJax_MenuRule{border-top:1px solid #DDD;margin:4px 3px}.MathJax_MenuDisabled{color:GrayText}.MathJax_MenuActive{background-color:#606872;color:#fff}.MathJax_Menu_Close{position:absolute;width:31px;height:31px;top:-15px;left:-15px}#MathJax_Zoom{position:absolute;background-color:#F0F0F0;overflow:auto;display:block;z-index:301;padding:.5em;border:1px solid #000;margin:0;font-weight:400;font-style:normal;text-align:left;text-indent:0;text-transform:none;line-height:normal;letter-spacing:normal;word-spacing:normal;word-wrap:normal;white-space:nowrap;float:none;box-shadow:5px 5px 15px #AAA;-webkit-box-shadow:5px 5px 15px #AAA;-moz-box-shadow:5px 5px 15px #AAA;-khtml-box-shadow:5px 5px 15px #AAA;filter:progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}#MathJax_ZoomOverlay{position:absolute;left:0;top:0;z-index:300;display:inline-block;width:100%;height:100%;border:0;padding:0;margin:0;background-color:#fff;opacity:0;filter:alpha(opacity=0)}#MathJax_ZoomFrame{position:relative;display:inline-block;height:0;width:0}#MathJax_ZoomEventTrap{position:absolute;left:0;top:0;z-index:302;display:inline-block;border:0;padding:0;margin:0;background-color:#fff;opacity:0;filter:alpha(opacity=0)}.MathJax_Preview{color:#888}#MathJax_Message{position:fixed;left:1px;bottom:2px;background-color:#E6E6E6;border:1px solid #959595;margin:0;padding:2px 8px;z-index:102;color:#000;font-size:80%;width:auto;white-space:nowrap}#MathJax_MSIE_Frame{position:absolute;top:0;left:0;width:0;z-index:101;border:0;margin:0;padding:0}.MathJax_Error{color:#C00;font-style:italic}footer{position:fixed;font-size:.8em;text-align:right;bottom:0;margin-left:-25px;height:20px;width:100%}</style>
</head>
<body class="markdown github">
<h1 id="manipulating-data-and-making-graphics-in-r"><a name="manipulating-data-and-making-graphics-in-r" href="#manipulating-data-and-making-graphics-in-r"></a>Manipulating data and making graphics in R</h1><h3 id="introducing-r-and-rstudio"><a name="introducing-r-and-rstudio" href="#introducing-r-and-rstudio"></a>Introducing R and RStudio</h3><p>In today’s class we will make graphics and process data using <strong><a href="http://www.r-project.org/">R</a></strong>, which is a very powerful tool, designed by statisticians for data analysis. Described on its website as “free software environment for statistical computing and graphics,” R is a programming language that opens a world of possibilities for making graphics and analyzing and processing data. Indeed, just about anything you may want to do with data can be done with R, from web scraping to making interactive graphics.</p><p>We will explore’s R’s potential for making interactive graphics in week 13. Our goal for this week’s class is to get used to processing data in R, and start making some static graphics.</p><p><strong><a href="http://www.rstudio.com/">RStudio</a></strong> is an “integrated development environment,” or IDE, for R that provides a more user-friendly interface than working in the standard R Console.</p><p>Launch RStudio, and the screen should look like this:</p><p><img src="img/class11_1.jpg" alt=""></p><p>The main panel to the left is the R Console. Type valid R code into here, hit <code>return</code>, and it will be run. See what happens if you run:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;>print(&quot;Hello World!&quot;)
</code></pre>">print(<span class="hljs-string">"Hello World!"</span>)
</code></pre><h3 id="the-data-we-will-use-today"><a name="the-data-we-will-use-today" href="#the-data-we-will-use-today"></a>The data we will use today</h3><p>Download the data for this session from <a href="data/week11.zip">here</a>, unzip the folder and place it on your desktop. It contains the following files:</p><ul>
<li><code>disease_democ.csv</code> Data illustrating a controversial theory suggesting that the emergence of democratic political systems has depended largely on nations having low rates of infectious disease, from the <a href="http://www.gideononline.com/">Global Infectious Diseases and Epidemiology Network</a> and <em><a href="http://www.amazon.com/Democratization-Comparative-Analysis-Countries-Routledge/dp/0415318602">Democratization: A Comparative Analysis of 170 Countries</a></em>, as used in week 1.</li><li><code>food_stamps.csv</code> <a href="http://www.fns.usda.gov/pd/supplemental-nutrition-assistance-program-snap">U.S. Department of Agriculture data</a> on the number of participants, in millions, and costs, in $ billions, of the federal Supplemental Nutrition Assistance Program.</li><li><code>pfizer.csv</code> <code>fda.csv</code> Data on payments to doctors by the drug company Pfizer and warning letters sent by the U.S. Food and Drug Administration, as used in week 5.</li><li><code>column_theme.R</code> R script to set style for column charts using ggplot2 package.</li><li><code>scatter_line_theme.R</code> R script to set style for scatter plots and line charts using ggplot2 package.</li></ul><h3 id="set-your-working-directory"><a name="set-your-working-directory" href="#set-your-working-directory"></a>Set your working directory</h3><p>When starting a new project in R, the first thing to do is set the directory/folder in which you are working. From the top menu, select <code>Session&gt;Set Working Directory&gt;Choose Directory ...</code></p><p>Notice how this code appears in the console:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;>setwd(&quot;~/Desktop/week11&quot;)
</code></pre>">setwd(<span class="hljs-string">"~/Desktop/week11"</span>)
</code></pre><h3 id="reproducibility:-save-your-scripts-and-your-environment"><a name="reproducibility:-save-your-scripts-and-your-environment" href="#reproducibility:-save-your-scripts-and-your-environment"></a>Reproducibility: Save your scripts and your environment</h3><p>As we have already discussed, we should aim for all of our data journalism to be fully documented and reproducible. R makes this easy, as every operation performed can be saved in a script. Click on the <img src="img/class11_2.jpg" alt=""> icon at top left and select <code>R Script</code>. A new panel should now open:</p><p><img src="img/class11_3.jpg" alt=""></p><p>Any code we type in here can be run in the console. Hitting <code>Run</code> will run the line of code on which the cursor is sitting. To run multiple lines of code, highlight them and click <code>Run</code>.</p><p>Copy the code <code>setwd("~/Desktop/week11")</code> into the script then save it as <code>week11.R</code>, by clicking the small save/disk icon on the top left panel. Now the next time you run this script, the working directory will be set automatically.</p><p>The panel at top right has two tabs, the first showing the <code>Environment</code>, or all of the “objects” loaded into memory for this R session. We can save this as well, so we don’t have to load and process data again if we return to return to a project later.</p><p>Click on the save/disk icon in the <code>Environment</code> panel to save and call the file <code>week11.RData</code>. You should see the following code appear in the Console:</p><pre class="r hljs"><code class="r" data-origin="<pre><code class=&quot;r&quot;>save.image(&quot;~/Desktop/week11/week11.RData&quot;)
</code></pre>">save.image(<span class="hljs-string">"~/Desktop/week11/week11.RData"</span>)
</code></pre><p>Copy this code into your script also, placing it at the end. By keeping this code at the end of your script, each time you run the entire script the last action will be to save the environment.</p><p>The second tab in this panel shows the history of all the code run in the current R session.</p><h3 id="install-and-load-r-packages"><a name="install-and-load-r-packages" href="#install-and-load-r-packages"></a>Install and load R packages</h3><p>Much of the power of R comes from the thousands of “packages” written by its community of open source contributors. These are optimized for specific statistical, graphical or data-processing tasks. To see what packages are available in the basic distribution of R, select the <code>Packages</code> tab in the panel at bottom right. To find packages for particular tasks, try searching Google using appropriate keywords and the phrase “R package.”</p><p>In this class, we will work with a series of useful packages, called <strong><a href="https://cran.r-project.org/web/packages/readr/readr.pdf">readr</a></strong>, <strong><a href="http://docs.ggplot2.org/current/">ggplot2</a></strong>, <strong><a href="https://cran.r-project.org/web/packages/dplyr/dplyr.pdf">dplyr</a></strong>, <strong><a href="https://cran.r-project.org/web/packages/scales/scales.pdf">scales</a></strong>, <strong><a href="https://cran.r-project.org/web/packages/RColorBrewer/RColorBrewer.pdf">RColorBrewer</a></strong>, and <strong><a href="https://cran.r-project.org/web/packages/WDI/WDI.pdf">WDI</a></strong>. Click on <code>Install</code>, and enter these names, separated by commas or spaces, as follows:</p><p><img src="img/class11_4.jpg" alt=""></p><p>Make sure that <code>Install dependencies</code> is checked, as some packages will only run correctly if other packages are also installed. Click <code>Install</code> and all of the required packages should install.</p><p>Having installed a package, you can load it into the current R session by checking its box in the <code>Packages</code> tab. However, we will enter the following code into our script, then highlight these lines of code and run them:</p><pre class="r hljs"><code class="r" data-origin="<pre><code class=&quot;r&quot;># package to quickly read data into R
library(readr)

# package to draw charts
library(ggplot2)

# package to format axes on those charts as %, $ and so on
library(scales)

# package for manipulating data
library(dplyr)

# package to use ColorBrewer color schemes
library(RColorBrewer)

# package to import data from World Bank World Development Indicators API
library(WDI)
</code></pre>"><span class="hljs-comment"># package to quickly read data into R</span>
<span class="hljs-keyword">library</span>(readr)

<span class="hljs-comment"># package to draw charts</span>
<span class="hljs-keyword">library</span>(ggplot2)

<span class="hljs-comment"># package to format axes on those charts as %, $ and so on</span>
<span class="hljs-keyword">library</span>(scales)

<span class="hljs-comment"># package for manipulating data</span>
<span class="hljs-keyword">library</span>(dplyr)

<span class="hljs-comment"># package to use ColorBrewer color schemes</span>
<span class="hljs-keyword">library</span>(RColorBrewer)

<span class="hljs-comment"># package to import data from World Bank World Development Indicators API</span>
<span class="hljs-keyword">library</span>(WDI)
</code></pre><p>By saving this code in our script, the packages will load automatically when we run the script in future. Add comments explaining your code using <code>#</code>, which causes everything written subseqeuntly on that line to be ignored. It is good practice to comment your code extensively to remind you of what it does: Don’t reply on your memory!</p><p>Each time you start R, it’s a good idea to click on <code>Update</code> in the <code>Packages</code> panel to update all your installed packages to the latest versions.</p><h3 id="load,-view-and-export-data"><a name="load,-view-and-export-data" href="#load,-view-and-export-data"></a>Load, view and export data</h3><h4 id="load-data"><a name="load-data" href="#load-data"></a>Load data</h4><p>We can load data into the current R session by selecting <code>Import Dataset&gt;From Text File...</code> in the <code>Environment</code> tab.</p><p>Import the file <code>disease_democ.csv</code> in this way. You should see the following dialog box:</p><p><img src="img/class11_5.jpg" alt=""></p><p>Check that RStudio has recognized whether the data has a <code>Heading</code> row, and that it has picked the correct <code>Separator</code> and the correct <code>Quote</code> character designating for text fields. <code>na.strings</code> will replace any null values with <code>NA</code>, which is standard in R. <code>Strings as factors</code> treats any text fields as labels for categorical variables. If this is unchecked they will be imported simply as strings of text.</p><p><code>Import</code> the data, and note that the following code should appear in the Console:</p><pre class="r hljs"><code class="r" data-origin="<pre><code class=&quot;r&quot;>disease_democ &amp;lt;- read.csv(&quot;~/Desktop/week11/disease_democ.csv&quot;)
    View(disease_democ)
</code></pre>">disease_democ &lt;- read.csv(<span class="hljs-string">"~/Desktop/week11/disease_democ.csv"</span>)
    View(disease_democ)
</code></pre><p><code>&lt;-</code> is known as an “assignment operator.” Essentially, <code>&lt;-</code> means: “Make the object named to the left equal to the output of the code to the right.”</p><p>The data should open for inspection in the upper left panel, as instructed by the second line of the above code, and an object called <code>disease_democ</code> will now be visible in the <code>Environment</code> tab. At the top-right of this tab, switch from <code>List</code> to <code>Grid</code> view using the dropdown menu, to see the following:</p><p><img src="img/class11_6.jpg" alt=""></p><p>The object we have created is a <code>data.frame</code>, the standard format for tables of data in R. Its <code>Value</code> details the number of variables, and the number of records, or observations, in the data.</p><p>We can <code>View</code> data at any time by clicking on its table icon in the <code>Environment</code> tab in the <code>Grid</code> view, or using the <code>View()</code> function.</p><p>You can remove any object from your environment by checking it in the <code>Grid</code> view and clikcing the broom icon.</p><p>Now close the <code>disease_democ</code> view.</p><p>Data can also be imported by writing code, and for the rest of this session we will use the <strong>readr</strong> package to import data. Add the following code to your script and run:</p><pre class="r hljs"><code class="r" data-origin="<pre><code class=&quot;r&quot;># load disease and democracy data
disease_democ &amp;lt;- read_csv(&quot;disease_democ.csv&quot;)
</code></pre>"><span class="hljs-comment"># load disease and democracy data</span>
disease_democ &lt;- read_csv(<span class="hljs-string">"disease_democ.csv"</span>)
</code></pre><p>The object is now a <code>tbl_df</code>, which is simply a variant of a <code>data.frame</code>. You don’t need to worry about the difference.</p><p>If you run into any trouble importing data with readr, you may need to specify the data types for some variables — in particular for full date and time strings. <a href="https://github.com/hadley/readr/blob/master/vignettes/column-types.Rmd">This link</a> explains how to set data types for individual variables when importing data with readr.</p><h4 id="view-data"><a name="view-data" href="#view-data"></a>View data</h4><p>Here are some useful commands for looking at data in R:</p><pre class="r hljs"><code class="r" data-origin="<pre><code class=&quot;r&quot;># view structure of data
str(disease_democ)
</code></pre>"><span class="hljs-comment"># view structure of data</span>
str(disease_democ)
</code></pre><p>This should give the following output in the R Console:</p><pre class="json hljs"><code class="JSON" data-origin="<pre><code class=&quot;JSON&quot;>Classes ‘tbl_df’, ‘tbl’ and 'data.frame':    168 obs. of  4 variables:
 $ country     : chr  &quot;Bahrain&quot; &quot;Bahamas, The&quot; &quot;Qatar&quot; &quot;Latvia&quot; ...
 $ income_group: chr  &quot;High income: non-OECD&quot; &quot;High income: non-OECD&quot; &quot;High income: non-OECD&quot; &quot;High income: non-OECD&quot; ...
 $ democ_score : num  45.6 48.4 50.4 52.8 46 64 65.8 70.6 57.6 40.6 ...
 $ infect_rate : int  23 24 24 25 26 26 26 26 27 28 ...
</code></pre>">Classes ‘tbl_df’, ‘tbl’ and 'data.frame':    168 obs. of  4 variables:
 $ country     : chr  "Bahrain" "Bahamas, The" "Qatar" "Latvia" ...
 $ income_group: chr  "High income: non-OECD" "High income: non-OECD" "High income: non-OECD" "High income: non-OECD" ...
 $ democ_score : num  45.6 48.4 50.4 52.8 46 64 65.8 70.6 57.6 40.6 ...
 $ infect_rate : int  23 24 24 25 26 26 26 26 27 28 ...
</code></pre><p>The <code>str</code> function shows the structure of an object, telling us here that <code>country</code> and <code>income_group</code> are characters, or strings of text, <code>democ_score</code> is numeric, or a continuous variable, while <code>infect_rate</code> is a continuous variable that contains only integers, or whole numbers.</p><p>To select an individual variable from a <code>data.frame</code>, use the name of the data frame and the variable name, separated by <code>$</code>. Type this into your script and run:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># view values for infect_rate variable
disease_democ$infect_rate
</code></pre>"><span class="hljs-comment"># view values for infect_rate variable</span>
disease_democ$infect_rate
</code></pre><p>The output will be all of the values for that variable.</p><p>If you need to change the data type for any variables, use the following functions:</p><ul>
<li><code>as.character</code> converts to text string</li><li><code>as.numeric</code> converts to number</li><li><code>as.factor</code> converts to categorical variable</li><li><code>as.integer</code> converts to integer</li><li><code>as.Date</code> converts to a date</li></ul><p>Conversions to full dates and times are a little more complex. If you need to do this, I suggest using the <a href="https://cran.r-project.org/web/packages/lubridate/lubridate.pdf">lubridate</a> package, see notes <a href="http://www.jstatsoft.org/v40/i03/paper">here</a>.</p><p>Now change <code>income_group</code> so it is treated as a categorical variable, like so:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># convert income_group to categorical variable
disease_democ$income_group &amp;lt;- as.factor(disease_democ$income_group)
</code></pre>"><span class="hljs-comment"># convert income_group to categorical variable</span>
disease_democ$income_group &lt;- as.factor(disease_democ$income_group)
</code></pre><p>The following code shows the first <code>n</code> lines from an object, where <code>n</code> is the number given after the comma. It can be useful for quickly examining how data is organized:</p><pre class="r hljs"><code class="r" data-origin="<pre><code class=&quot;r&quot;>#  view first ten rows of data
head(food_stamps, 10)
</code></pre>"><span class="hljs-comment">#  view first ten rows of data</span>
head(food_stamps, <span class="hljs-number">10</span>)
</code></pre><p>This is the output:</p><pre class="json hljs"><code class="JSON" data-origin="<pre><code class=&quot;JSON&quot;>                country          income_group democ_score infect_rate
1               Bahrain High income: non-OECD        45.6          23
2          Bahamas, The High income: non-OECD        48.4          24
3                 Qatar High income: non-OECD        50.4          24
4                Latvia High income: non-OECD        52.8          25
5              Barbados High income: non-OECD        46.0          26
6             Singapore High income: non-OECD        64.0          26
7                Cyprus High income: non-OECD        65.8          26
8                 Malta High income: non-OECD        70.6          26
9               Croatia High income: non-OECD        57.6          27
10 United Arab Emirates High income: non-OECD        40.6          28
</code></pre>">                country          income_group democ_score infect_rate
1               Bahrain High income: non-OECD        45.6          23
2          Bahamas, The High income: non-OECD        48.4          24
3                 Qatar High income: non-OECD        50.4          24
4                Latvia High income: non-OECD        52.8          25
5              Barbados High income: non-OECD        46.0          26
6             Singapore High income: non-OECD        64.0          26
7                Cyprus High income: non-OECD        65.8          26
8                 Malta High income: non-OECD        70.6          26
9               Croatia High income: non-OECD        57.6          27
10 United Arab Emirates High income: non-OECD        40.6          28
</code></pre><p>This would show the final 10 rows in the data:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># view last ten rows of data
tail(disease_democ, 10)
</code></pre>"><span class="hljs-comment"># view last ten rows of data</span>
tail(disease_democ, <span class="hljs-number">10</span>)
</code></pre><p>This code will run a quick statistical summary of the data, calculating mean, median and quartile values for continious variables:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># summary statistics
summary(disease_democ)
</code></pre>"><span class="hljs-comment"># summary statistics</span>
summary(disease_democ)
</code></pre><p>This will be the output:</p><pre class="json hljs"><code class="JSON" data-origin="<pre><code class=&quot;JSON&quot;>  country          income_group        democ_score     infect_rate   
 Length:168         Length:168         Min.   :15.80   Min.   :23.00  
 Class :character   Class :character   1st Qu.:28.40   1st Qu.:27.00  
 Mode  :character   Mode  :character   Median :38.40   Median :32.00  
                                       Mean   :42.78   Mean   :33.33  
                                       3rd Qu.:52.65   3rd Qu.:39.00  
                                       Max.   :86.60   Max.   :48.00
</code></pre>">  country          income_group        democ_score     infect_rate   
 Length:168         Length:168         Min.   :15.80   Min.   :23.00  
 Class :character   Class :character   1st Qu.:28.40   1st Qu.:27.00  
 Mode  :character   Mode  :character   Median :38.40   Median :32.00  
                                       Mean   :42.78   Mean   :33.33  
                                       3rd Qu.:52.65   3rd Qu.:39.00  
                                       Max.   :86.60   Max.   :48.00
</code></pre><p>Often you may want to export data from R. So let’s export the disease and democracy data with a new name:</p><pre class="r hljs"><code class="r" data-origin="<pre><code class=&quot;r&quot;># export a copy of the disease and democracy data
write.csv(disease_democ, &quot;disease_democ_copy.csv&quot;, row.names = FALSE, na = &quot;&quot;)
</code></pre>"><span class="hljs-comment"># export a copy of the disease and democracy data</span>
write.csv(disease_democ, <span class="hljs-string">"disease_democ_copy.csv"</span>, row.names = <span class="hljs-literal">FALSE</span>, na = <span class="hljs-string">""</span>)
</code></pre><p>A file with that name should appear in the folder on your Desktop.</p><p>If <code>row.names = FALSE</code> is not included, R will automatically add a number label to each row; <code>na = ""</code> explains how to export any null values. Here they will be left blank, because there is nothing between the quote marks. If you do not specify this, they will be exported with the value <code>NA</code>.</p><h3 id="draw-scatter-plots-from-the-disease-and-democracy-data"><a name="draw-scatter-plots-from-the-disease-and-democracy-data" href="#draw-scatter-plots-from-the-disease-and-democracy-data"></a>Draw scatter plots from the disease and democracy data</h3><p>Now we will use the <strong>ggplot2</strong> charting package to draw the scatter plot from week 1.</p><p>Add the following code to your script and run:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># draw scatter plot
ggplot(disease_democ, aes(x=infect_rate, y=democ_score)) + geom_point()
</code></pre>"><span class="hljs-comment"># draw scatter plot</span>
ggplot(disease_democ, aes(x=infect_rate, y=democ_score)) + geom_point()
</code></pre><p>A chart should appear in the <code>Plots</code> tab at bottom-right:</p><p><img src="img/class11_7.jpg" alt=""></p><h4 id="ggplot2-and-the-grammar-of-graphics"><a name="ggplot2-and-the-grammar-of-graphics" href="#ggplot2-and-the-grammar-of-graphics"></a>ggplot2 and the grammar of graphics</h4><p>The “gg” in ggplot2 stands for “<a href="http://www.amazon.com/The-Grammar-Graphics-Statistics-Computing/dp/0387245448">grammar of graphics</a>,” an approach to drawing charts devised by the statistician Leland Wilkinson. Rather than thinking in terms of finished charts like a scatter plot or a column chart, it starts by defining the coordinate system (usually the X and Y axes of a cartesian system), maps data onto those coordinates, and then adds layers such as points, bars and so on. This is the logic behind ggplot2 code.</p><p>The function <code>aes</code>, for “aesthetic mapping,” is used to map data values onto a chart — to an axis, to a color scale, and so on. So ggplot2 code usually starts by mapping variables to the X and Y axes. Layers are then added the the graphic using various <code>geom</code> functions. The brackets following each of these each functions may contain global operations to be applied to every item in the layer, and also further <code>aes</code> mappings, as we shall see.</p><p>Before we start customizing the scatter plot, let’s save the basic aesthetic mapping, with <code>infect_rate</code> on the X axis and <code>democ_score</code> on the Y, as an R object:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># save the basic chart with data mapping, but no geom layers
disease_democ_chart &amp;lt;- ggplot(disease_democ, aes(x=infect_rate, y=democ_score))
</code></pre>"><span class="hljs-comment"># save the basic chart with data mapping, but no geom layers</span>
disease_democ_chart &lt;- ggplot(disease_democ, aes(x=infect_rate, y=democ_score))
</code></pre><p>Notice that an object with the Type <code>gg</code> appears in the <code>Environment</code> tab.</p><h4 id="customize-the-scatter-plot"><a name="customize-the-scatter-plot" href="#customize-the-scatter-plot"></a>Customize the scatter plot</h4><p>Add the following code to your script and run:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># draw scatter plot with a locally estimated smoothing trend line
disease_democ_chart %&amp;gt;%
  + geom_point() %&amp;gt;%
  + geom_smooth()
</code></pre>"><span class="hljs-comment"># draw scatter plot with a locally estimated smoothing trend line</span>
disease_democ_chart %&gt;%
  + geom_point() %&gt;%
  + geom_smooth()
</code></pre><p>This code introduces the <code>%&gt;%</code> operator from the <strong>dplyr</strong> package, which takes the output from the previous code and hands it on to the next line. Think of <code>%&gt;%</code> as meaning “then.” Here it is simply being used to separate ggplot2 code into multiple lines, making it easier to read.</p><p>The chart should now look like this:</p><p><img src="img/class11_8.jpg" alt=""></p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># change to linear trend line with no standard error ribbon
# set axis ranges
# customize axis labels
disease_democ_chart %&amp;gt;%
  + geom_point() %&amp;gt;%
  + geom_smooth(method=lm, se=FALSE) %&amp;gt;%
  + scale_x_continuous(limits=c(0,70)) %&amp;gt;%
  + scale_y_continuous(limits=c(0,100)) %&amp;gt;%
  + xlab(&quot;Infectious disease prevalence score&quot;) %&amp;gt;%
  + ylab(&quot;Democratization score&quot;)
</code></pre>"><span class="hljs-comment"># change to linear trend line with no standard error ribbon</span>
<span class="hljs-comment"># set axis ranges</span>
<span class="hljs-comment"># customize axis labels</span>
disease_democ_chart %&gt;%
  + geom_point() %&gt;%
  + geom_smooth(method=lm, se=<span class="hljs-literal">FALSE</span>) %&gt;%
  + scale_x_continuous(limits=c(<span class="hljs-number">0</span>,<span class="hljs-number">70</span>)) %&gt;%
  + scale_y_continuous(limits=c(<span class="hljs-number">0</span>,<span class="hljs-number">100</span>)) %&gt;%
  + xlab(<span class="hljs-string">"Infectious disease prevalence score"</span>) %&gt;%
  + ylab(<span class="hljs-string">"Democratization score"</span>)
</code></pre><p>This code customizes the chart in the following ways:</p><p>First, the <code>geom_smooth()</code> function has been altered: <code>method=lm</code> (for “linear model”) calculates a straight trend line by linear regression; <code>se=FALSE</code> removes the standard error ribbon describing the statistical uncertainty around the line of best fit through the data.</p><p><code>scale_x-continuous(limits=c(0,70))</code> sets the range of the X axis, which is mapping a continuous variable, from 0 to 70. Notice the <code>c(0,70)</code>. Whenever you input a  list of two or more values into R, you must use the function <code>c()</code>, which means “combine values into a list.” This crops up frequently in R code.</p><p><code>xlab("Infectious disease prevalance score")</code> changes the text of the X axis label from the default of the variable name to the text given in quote marks within the function brackets.</p><p>The chart should now look like this:</p><p><img src="img/class11_9.jpg" alt=""></p><p>Now let’s map the countries’ <code>income_group</code> to the color of the points:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># map countries' income group to the color of the points
disease_democ_chart %&amp;gt;%
  + geom_point(aes(color=income_group) %&amp;gt;%
  + geom_smooth(method=lm, se=FALSE) %&amp;gt;%
  + scale_x_continuous(limits=c(0,70)) %&amp;gt;%
  + scale_y_continuous(limits=c(0,100)) %&amp;gt;%
  + xlab(&quot;Infectious disease prevalence score&quot;) %&amp;gt;%
  + ylab(&quot;Democratization score&quot;)
</code></pre>"><span class="hljs-comment"># map countries' income group to the color of the points</span>
disease_democ_chart %&gt;%
  + geom_point(aes(color=income_group) %&gt;%
  + geom_smooth(method=lm, se=<span class="hljs-literal">FALSE</span>) %&gt;%
  + scale_x_continuous(limits=c(<span class="hljs-number">0</span>,<span class="hljs-number">70</span>)) %&gt;%
  + scale_y_continuous(limits=c(<span class="hljs-number">0</span>,<span class="hljs-number">100</span>)) %&gt;%
  + xlab(<span class="hljs-string">"Infectious disease prevalence score"</span>) %&gt;%
  + ylab(<span class="hljs-string">"Democratization score"</span>)
</code></pre><p>Notice the second <code>aes</code> mapping, used in the <code>geom_point()</code> function, to set the color of the points.</p><p>The chart should now look like this:</p><p><img src="img/class11_10.jpg" alt=""></p><p>Return to the <a href="http://rweb.stat.ucla.edu/ggplot2/">ggplot2 web app</a> and recreate this chart — although you won’t be able to customize the axis labels and ranges. Then select <code>View</code> from the top menu and and check <code>code panel</code>. Look at the similarity betwen the code and what we just wrote. It will be written as a single line, without the <code>%&gt;%</code> operators, but you should be able to recognize the structure.</p><p>This feature makes the app a good tool for learning how to code ggplot2 graphics.</p><h3 id="export-your-plots"><a name="export-your-plots" href="#export-your-plots"></a>Export your plots</h3><p>RStudio makes it easy to export graphics from R. Select <code>Export&gt;Save as PDF...</code> from the menu in the <code>Plots</code> tab. At the dialog box, you can select the size and orientation for the export, choose where to save it, and give it an appropriate name:</p><p><img src="img/class11_11.jpg" alt=""></p><p>RStudio also offers the option to export in various image formats. If you intend to edit the graphic subsequently in a vector graphics editor such as <a href="http://www.adobe.com/products/illustrator.html">Adobe Illustrator</a>, however, save as a PDF.</p><p>Notice also the arrows at top left of the <code>Plots</code> tab. These allow you to browse back and forth through the charts drawn in the current R session.</p><h3 id="draw-line,-column-and-other-charts-from-food-stamps-data"><a name="draw-line,-column-and-other-charts-from-food-stamps-data" href="#draw-line,-column-and-other-charts-from-food-stamps-data"></a>Draw line, column and other charts from food stamps data</h3><p>Now we will draw the variety of charts used in week 2 to illustrate different ways of charting participation over time in the U.S. federal government’s food stamps nutritional assistance program.</p><p>First import the food stamps data:</p><pre class="r hljs"><code class="r" data-origin="<pre><code class=&quot;r&quot;># load food stamps data
food_stamps &amp;lt;- read_csv(&quot;food_stamps.csv&quot;)
</code></pre>"><span class="hljs-comment"># load food stamps data</span>
food_stamps &lt;- read_csv(<span class="hljs-string">"food_stamps.csv"</span>)
</code></pre><p>First, create the basic chart with <code>year</code> mapped to the X axis and <code>participants</code> mapped to the Y axis, and customized axis labels:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># save the basic chart with data mapping, but no geom layers
food_stamps_chart &amp;lt;- ggplot(food_stamps, aes(x=year, y=participants))  %&amp;gt;%
  + xlab(&quot;Year&quot;) %&amp;gt;%
  + ylab(&quot;Participants (millions)&quot;)
</code></pre>"><span class="hljs-comment"># save the basic chart with data mapping, but no geom layers</span>
food_stamps_chart &lt;- ggplot(food_stamps, aes(x=year, y=participants))  %&gt;%
  + xlab(<span class="hljs-string">"Year"</span>) %&gt;%
  + ylab(<span class="hljs-string">"Participants (millions)"</span>)
</code></pre><p>Now let’s make a line chart:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># draw a line chart
food_stamps_chart %&amp;gt;%
  + geom_line() %&amp;gt;%
  + ggtitle(&quot;Line chart&quot;)
</code></pre>"><span class="hljs-comment"># draw a line chart</span>
food_stamps_chart %&gt;%
  + geom_line() %&gt;%
  + ggtitle(<span class="hljs-string">"Line chart"</span>)
</code></pre><p><code>geom_line()</code> adds the line. Notice also the use of <code>ggtitle()</code> to add a title to the chart.</p><p>This should be the result:</p><p><img src="img/class11_12.jpg" alt=""></p><p>Now add points to mark the data values:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># draw a dot-and-line chart
food_stamps_chart %&amp;gt;%
  + geom_line() %&amp;gt;%
  + geom_point() %&amp;gt;%
  + ggtitle(&quot;Dot-and-line chart&quot;)
</code></pre>"><span class="hljs-comment"># draw a dot-and-line chart</span>
food_stamps_chart %&gt;%
  + geom_line() %&gt;%
  + geom_point() %&gt;%
  + ggtitle(<span class="hljs-string">"Dot-and-line chart"</span>)
</code></pre><p>This will give the following:</p><p><img src="img/class11_13.jpg" alt=""></p><p>Which we can customize:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># change size of line and points
food_stamps_chart %&amp;gt;%
  + geom_line(size=1.2) %&amp;gt;%
  + geom_point(size=3) %&amp;gt;%
  + ggtitle(&quot;Dot-and-line chart&quot;)
</code></pre>"><span class="hljs-comment"># change size of line and points</span>
food_stamps_chart %&gt;%
  + geom_line(size=<span class="hljs-number">1.2</span>) %&gt;%
  + geom_point(size=<span class="hljs-number">3</span>) %&gt;%
  + ggtitle(<span class="hljs-string">"Dot-and-line chart"</span>)
</code></pre><p>Here is the resulting chart:</p><p><img src="img/class11_14.jpg" alt=""></p><p>Now let’s draw a column chart:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># draw a column chart
food_stamps_chart %&amp;gt;%
  + geom_bar(stat=&quot;identity&quot;) %&amp;gt;%
  + ggtitle(&quot;Column chart&quot;)
</code></pre>"><span class="hljs-comment"># draw a column chart</span>
food_stamps_chart %&gt;%
  + geom_bar(stat=<span class="hljs-string">"identity"</span>) %&gt;%
  + ggtitle(<span class="hljs-string">"Column chart"</span>)
</code></pre><p>To plot the values from a variable using <code>geom_bar()</code>, we need to define <code>stat="identity"</code>. This is because the default behavior from <code>geom_bar</code> is <code>stat="bin"</code>, which counts the number of values when drawing a histogram, if you only map one variable to the Y axis. <a href="http://docs.ggplot2.org/0.9.3.1/geom_bar.html">These notes</a> explain more. You can just remember it as a quirk of ggplot2 code.</p><p>Here is the result:</p><p><img src="img/class11_15.jpg" alt=""></p><p>Note that a vertical bar chart can be turned into a horizontal column chart using the <code>coord_flip()</code> function. Add it to the code for the last chart and see what happens.</p><h3 id="use-different-color-schemes"><a name="use-different-color-schemes" href="#use-different-color-schemes"></a>Use different color schemes</h3><p>Now we will experiment with various ways to use color in ggplot2, customizing the column chart.</p><p>First, run the following code:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># make columns light gray with darker gray border, amd make them semi-transparent
food_stamps_chart %&amp;gt;%
  + geom_bar(stat=&quot;identity&quot;, color=&quot;#888888&quot;, fill=&quot;#cccccc&quot;, alpha=0.5) %&amp;gt;%
  + ggtitle(&quot;Column chart&quot;)
</code></pre>"><span class="hljs-comment"># make columns light gray with darker gray border, amd make them semi-transparent</span>
food_stamps_chart %&gt;%
  + geom_bar(stat=<span class="hljs-string">"identity"</span>, color=<span class="hljs-string">"#888888"</span>, fill=<span class="hljs-string">"#cccccc"</span>, alpha=<span class="hljs-number">0.5</span>) %&gt;%
  + ggtitle(<span class="hljs-string">"Column chart"</span>)
</code></pre><p>When working with <code>geom_bar()</code>, <code>color</code> means the border around the bar, while <code>fill</code> means the color of the shape itself. Here we used the HEX values for two different grays.</p><p>When working with other layers, such as <code>geom_point()</code> and <code>geom_line()</code>, you can just use <code>color</code>.</p><p><code>alpha</code> can be used to set the opacity/transparency of any ggplot2 layer.</p><p>Here is the resulting chart:</p><p><img src="img/class11_16.jpg" alt=""></p><p>Now let’s set the color of the bars to correspond to the costs of the food stamps program in any given year:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># map the costs of the program onto the color of the bars
food_stamps_chart %&amp;gt;%
  + geom_bar(stat=&quot;identity&quot;, aes(fill=costs)) %&amp;gt;%
  + ggtitle(&quot;Column chart&quot;)
</code></pre>"><span class="hljs-comment"># map the costs of the program onto the color of the bars</span>
food_stamps_chart %&gt;%
  + geom_bar(stat=<span class="hljs-string">"identity"</span>, aes(fill=costs)) %&gt;%
  + ggtitle(<span class="hljs-string">"Column chart"</span>)
</code></pre><p>This code makes the following chart:</p><p><img src="img/class11_17.jpg" alt=""></p><p>Notice that this maps a smooth gradient of colors onto the continuous variable of costs, running from dark to light blue, for larger values.</p><p>This is less intuitive than having darker, more intense colors represent larger numbers. So now let’s control the color of the bars using our own color palette.</p><p>First, create a list of colors called <code>pal</code>, for “palette,” taken from ColorBrewer’s Reds sequential color scheme:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># use custom colors from ColorBrewer
pal = c(&quot;#fee5d9&quot;,&quot;#fcae91&quot;,&quot;#fb6a4a&quot;,&quot;#de2d26&quot;)
</code></pre>"><span class="hljs-comment"># use custom colors from ColorBrewer</span>
pal = c(<span class="hljs-string">"#fee5d9"</span>,<span class="hljs-string">"#fcae91"</span>,<span class="hljs-string">"#fb6a4a"</span>,<span class="hljs-string">"#de2d26"</span>)
</code></pre><p>Now we can use those colors to redraw the column chart:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># draw column chart using custom palette
food_stamps_chart %&amp;gt;%
  + geom_bar(stat=&quot;identity&quot;, aes(fill=costs), color=&quot;888888&quot;) %&amp;gt;%
  + scale_fill_gradientn(name=&quot;Costs \n($ billions)&quot;, colours=pal) %&amp;gt;%
  + ggtitle(&quot;Column chart&quot;)
</code></pre>"><span class="hljs-comment"># draw column chart using custom palette</span>
food_stamps_chart %&gt;%
  + geom_bar(stat=<span class="hljs-string">"identity"</span>, aes(fill=costs), color=<span class="hljs-string">"888888"</span>) %&gt;%
  + scale_fill_gradientn(name=<span class="hljs-string">"Costs \n($ billions)"</span>, colours=pal) %&gt;%
  + ggtitle(<span class="hljs-string">"Column chart"</span>)
</code></pre><p>In the <code>geom_bar()</code> function, we have drawn a gray border around each column, and mapped the costs of the program onto the color of the bars.</p><p><code>scale_fill_gradientn()</code> defines the colors to use for this mapping, so here we set <code>colours=pal</code>, to use our custom palette. (The <code>n</code> at the end of <code>gradientn</code> means that the color gradient will pass through a number of listed colors.)</p><p>Note that colors is here spelled <code>colours</code>. This is because ggplot2, like most of the R packages we are using today, was written by a New Zealander, <a href="https://github.com/hadley">Hadley Wickham</a>. In most instances, ggplot2 will accept both U.S. and British/New Zealand spellings, but this is one case where it does not.</p><p><code>name</code> in the <code>scale_fill_gradientn</code> function customizes the text for the color legend title. <code>/n</code> stands for “new line,” so splits that title into two lines of text.</p><p>Here is the result:</p><p><img src="img/class11_18.jpg" alt=""></p><p>We have only explored some of the ways to map data to color in ggplot2 graphics. For the full range of possibilities, see the <code>Scales</code> options in the <a href="http://docs.ggplot2.org/current/index.html">ggplot2 documentation</a>.</p><p>We will later return to working with color after binning data by quantiles, but first we need to explore data processing in R.</p><h3 id="use-dplyr-to-process-data-on-pfizer-payments-and-fda-warning-letters-to-doctors"><a name="use-dplyr-to-process-data-on-pfizer-payments-and-fda-warning-letters-to-doctors" href="#use-dplyr-to-process-data-on-pfizer-payments-and-fda-warning-letters-to-doctors"></a>Use dplyr to process data on Pfizer payments and FDA warning letters to doctors</h3><p><strong>dplyr</strong> is an incredibly useful package that makes it possible to process data in various ways, replicating what can be done with SQL.</p><p>So we will now import the doctors data from week 5, and repeat some of the queries we ran using dplyr code.</p><p>First, load the data:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># load pfizer and fda data
pfizer &amp;lt;- read_csv(&quot;pfizer.csv&quot;)
fda &amp;lt;- read_csv(&quot;fda.csv&quot;)

# check fda$issued has been recognized as dates
str(fda)
</code></pre>"><span class="hljs-comment"># load pfizer and fda data</span>
pfizer &lt;- read_csv(<span class="hljs-string">"pfizer.csv"</span>)
fda &lt;- read_csv(<span class="hljs-string">"fda.csv"</span>)

<span class="hljs-comment"># check fda$issued has been recognized as dates</span>
str(fda)
</code></pre><p>The following dplyr functions have clear counterparts in SQL:</p><ul>
<li><p><code>select()</code> does much the same job as <code>SELECT</code> in SQL, picking which fields or variables to return.</p>
</li><li><p><code>filter()</code> corresponds to <code>WHERE</code> in a filtering query and follows Boolean logic with <code>|</code> representing <code>OR</code> and <code>&amp;</code> representing <code>AND</code>.</p>
</li><li><p><code>arrange()</code> does the same job as <code>ORDER BY</code> in SQL, sorting the data.</p>
</li></ul><p>So this is the dplyr version of the SQL query we used to find doctors in California paid $10,000 or more to run Expert-Led Forums:</p><pre class="r hljs"><code class="r" data-origin="<pre><code class=&quot;r&quot;># select doctors in California paid $10,000 or more to run Expert-Led Forums
ca_docs &amp;lt;- pfizer %&amp;gt;% 
  select(first_plus, last_name, city, state, category, total) %&amp;gt;%
  filter(category==&quot;Expert-Led Forums&quot; &amp;amp; state==&quot;CA&quot; &amp;amp; total &amp;gt;= 10000) %&amp;gt;%
  arrange(desc(total))
</code></pre>"><span class="hljs-comment"># select doctors in California paid $10,000 or more to run Expert-Led Forums</span>
ca_docs &lt;- pfizer %&gt;% 
  select(first_plus, last_name, city, state, category, total) %&gt;%
  filter(category==<span class="hljs-string">"Expert-Led Forums"</span> &amp; state==<span class="hljs-string">"CA"</span> &amp; total &gt;= <span class="hljs-number">10000</span>) %&gt;%
  arrange(desc(total))
</code></pre><p>Note the use of <code>==</code> to look for particular values, rather than a single <code>=</code>, which is used in R to make something equal to the specificied value.</p><p>View the new <code>ca_docs</code> object to see the results.</p><p>Now extend the query to also find doctors in New York state:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># extend that query to doctors in New York state, also
ca_ny_docs &amp;lt;- pfizer %&amp;gt;%
  select(first_plus, last_name, city, state, category, total) %&amp;gt;%
  filter(category==&quot;Expert-Led Forums&quot; &amp;amp; (state==&quot;CA&quot;|state==&quot;NY&quot;) &amp;amp; total &amp;gt;= 10000) %&amp;gt;%
  arrange(desc(total))
</code></pre>"><span class="hljs-comment"># extend that query to doctors in New York state, also</span>
ca_ny_docs &lt;- pfizer %&gt;%
  select(first_plus, last_name, city, state, category, total) %&gt;%
  filter(category==<span class="hljs-string">"Expert-Led Forums"</span> &amp; (state==<span class="hljs-string">"CA"</span>|state==<span class="hljs-string">"NY"</span>) &amp; total &gt;= <span class="hljs-number">10000</span>) %&gt;%
  arrange(desc(total))
</code></pre><p>Note the use of <code>|</code> for <code>OR</code>, and the brackets around that part of the query to ensure that this is run first.</p><p>Get all payments for speaking at Expert-Led Forums or for Professional Advising:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># all payments for running Expert-led Forums and providing Professional advice
speak_advice &amp;lt;- pfizer %&amp;gt;%
  select(first_plus, last_name, city, state, category, total) %&amp;gt;%
  filter(category==&quot;Expert-Led Forums&quot;|category==&quot;Professional Advising&quot;) %&amp;gt;%
  arrange(desc(total))
</code></pre>"><span class="hljs-comment"># all payments for running Expert-led Forums and providing Professional advice</span>
speak_advice &lt;- pfizer %&gt;%
  select(first_plus, last_name, city, state, category, total) %&gt;%
  filter(category==<span class="hljs-string">"Expert-Led Forums"</span>|category==<span class="hljs-string">"Professional Advising"</span>) %&gt;%
  arrange(desc(total))
</code></pre><p>Just like SQL, dplyr can group and aggregate data, using the following functions:</p><ul>
<li><p><code>group_by()</code> does the same job as <code>GROUP BY</code> in SQL.</p>
</li><li><p><code>summarize()</code> allows you to run various aggregations on the grouped data, including <code>sum()</code>, <code>mean()</code>, <code>median()</code>.</p>
</li></ul><p>So, for example, here is how to calculate total payments to doctors by state:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># calculate total payments by state
state_totals &amp;lt;- pfizer %&amp;gt;%
  group_by(state) %&amp;gt;%
  select(state, total) %&amp;gt;%
  summarize(state_total = sum(total)) %&amp;gt;%
  arrange(desc(state_total))
</code></pre>"><span class="hljs-comment"># calculate total payments by state</span>
state_totals &lt;- pfizer %&gt;%
  group_by(state) %&gt;%
  select(state, total) %&gt;%
  summarize(state_total = sum(total)) %&gt;%
  arrange(desc(state_total))
</code></pre><p>In the <code>summarize()</code> function, we have renamed the aggregated variable as <code>state_total</code>, like we did by using <code>AS</code> in SQL. Again, view the new object <code>state_totals</code> to see the result.</p><p>Now let’s run some queries using dates on the FDA warning letters data.</p><p>Return letters sent from the start of 2005 onwards:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># FDA warning letters sent from the start of 2005 onwards
post2005 &amp;lt;- fda %&amp;gt;%
  filter(issued &amp;gt;= &quot;2005-01-01&quot;) %&amp;gt;%
  arrange(desc(issued))
</code></pre>"><span class="hljs-comment"># FDA warning letters sent from the start of 2005 onwards</span>
post2005 &lt;- fda %&gt;%
  filter(issued &gt;= <span class="hljs-string">"2005-01-01"</span>) %&gt;%
  arrange(desc(issued))
</code></pre><p>For the next query, we will use another useful dplyr fuction:</p><ul>
<li><code>mutate()</code> creates a new variable in the data, or alters an existing one.</li></ul><p>So, we will use <code>mutate()</code> to create a version of the data with a new column showing the number of days that have elapsed since the letter was sent:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># add a variable showing the number of days elapsed since each warning letter was sent
elapsed &amp;lt;- fda %&amp;gt;%
  mutate(days_elapsed = Sys.Date()-issued)
</code></pre>"><span class="hljs-comment"># add a variable showing the number of days elapsed since each warning letter was sent</span>
elapsed &lt;- fda %&gt;%
  mutate(days_elapsed = Sys.Date()-issued)
</code></pre><p>Notice that the new object <code>elapsed</code> contains a variable called <code>days_elapsed</code> giving the desired values.</p><p>This code would modify the existing <code>fda</code> <code>data.frame</code>, adding the new variable, rather than creating a new object with a different name:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># add a variable showing the number of days elapsed since each warning letter was sent
fda &amp;lt;- fda %&amp;gt;%
  mutate(days_elapsed = Sys.Date()-issued)
</code></pre>"><span class="hljs-comment"># add a variable showing the number of days elapsed since each warning letter was sent</span>
fda &lt;- fda %&gt;%
  mutate(days_elapsed = Sys.Date()-issued)
</code></pre><p>In this code, <code>Sys.Date()</code> returns the current date, so is equivalent to <code>date('now')</code> from our SQLite class. Subtracting dates is rather easier in R than in SQLite: Things will get more complicated with full dates and times, however — again the I recommend using the lubridate package.</p><p>Now count the number of letters issued by year:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># count the number of warning letters sent by year
letters_per_year &amp;lt;- fda %&amp;gt;%
  group_by(year = format(issued, &quot;%Y&quot;)) %&amp;gt;%
  summarize(letters=n())
</code></pre>"><span class="hljs-comment"># count the number of warning letters sent by year</span>
letters_per_year &lt;- fda %&gt;%
  group_by(year = format(issued, <span class="hljs-string">"%Y"</span>)) %&gt;%
  summarize(letters=n())
</code></pre><p>In the <code>group_by()</code> function, we used the code <code>year = format(issued, "%Y")</code> to extract the year from the dates, and call that new variable <code>year</code>.</p><p>In the <code>summarize()</code> function, we used <code>n()</code>, which is the equivalent of <code>COUNT</code> in SQL; you can think of it as saying “get the number (n) of …”. We then named the new variable with the counts <code>letters</code>.</p><p>Again, view the new object to see the results.</p><p>There are also a number of join functions in dplyr to run queries across two tables of data. Here are the most useful:</p><ul>
<li><code>inner_join()</code> returns values from both tables only where there is a match.</li><li><code>left_join()</code> returns all the values from the first-mentioned table, plus those from the second table that match.</li><li><code>right_join()</code> returns all the values from the second-mentioned table, plus those from the first table that match.</li><li><code>semi_join()</code> filters the first-mentioned table to include only values that have matches in the second table.</li><li><code>anti_join()</code> filters the first-mentioned table to include only values that have no matches in the second table.</li></ul><p>To illustrate, here is the query we ran in SQLite to find doctors who were paid by Pfizer to run expert led forums who had also received a warning letter from the FDA:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># join query to identify doctors paid to run Expert-led forums who also received a warning letter
matches &amp;lt;- inner_join(pfizer, fda, by=c(&quot;first_name&quot; = &quot;name_first&quot;, &quot;last_name&quot; = &quot;name_last&quot;)) %&amp;gt;%
  filter(category==&quot;Expert-Led Forums&quot;)
</code></pre>"><span class="hljs-comment"># join query to identify doctors paid to run Expert-led forums who also received a warning letter</span>
matches &lt;- inner_join(pfizer, fda, by=c(<span class="hljs-string">"first_name"</span> = <span class="hljs-string">"name_first"</span>, <span class="hljs-string">"last_name"</span> = <span class="hljs-string">"name_last"</span>)) %&gt;%
  filter(category==<span class="hljs-string">"Expert-Led Forums"</span>)
</code></pre><p>The code in <code>by=c()</code> defines how the join should be made. If instructions on how to join the tables are not supplied, dplyr will look for variables with matching names, and perform the join based on those. So think carefully about how you are joining tables, just as you would in SQL!</p><p><a href="http://stat545-ubc.github.io/bit001_dplyr-cheatsheet.html">Here is a useful reference</a> for running joins with dplyr.</p><h3 id="bin-data-by-quantiles-and-redraw-the-food-stamps-column-chart"><a name="bin-data-by-quantiles-and-redraw-the-food-stamps-column-chart" href="#bin-data-by-quantiles-and-redraw-the-food-stamps-column-chart"></a>Bin data by quantiles and redraw the food stamps column chart</h3><h4 id="bin-the-data"><a name="bin-the-data" href="#bin-the-data"></a>Bin the data</h4><p>Having learned the basics of dplyr, we will now return the the food stamps column chart, bin the costs data it into five quantiles, and then use that binned data to color the columns.</p><p>This is how to calculate quantiles in R:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># calculate five quantiles for the food stamps costs data
quantile(food_stamps$costs,(0:5)/5)
</code></pre>"><span class="hljs-comment"># calculate five quantiles for the food stamps costs data</span>
quantile(food_stamps$costs,(<span class="hljs-number">0</span>:<span class="hljs-number">5</span>)/<span class="hljs-number">5</span>)
</code></pre><p>This should be the output:</p><pre class="json hljs"><code class="JSON" data-origin="<pre><code class=&quot;JSON&quot;>   0%   20%   40%   60%   80%  100% 
 0.25  5.69 11.85 20.64 31.07 79.93
</code></pre>">   0%   20%   40%   60%   80%  100% 
 0.25  5.69 11.85 20.64 31.07 79.93
</code></pre><p>Now create a new object containing those quantile breaks, and use it to bin the costs data:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># calculate breaks for five quantile bins
breaks &amp;lt;- quantile(food_stamps$costs,(0:5)/5)

# create a new binned variable using these breaks
food_stamps &amp;lt;- food_stamps %&amp;gt;%
  mutate(cost_bin = cut(costs, breaks, include.lowest=TRUE))
</code></pre>"><span class="hljs-comment"># calculate breaks for five quantile bins</span>
breaks &lt;- quantile(food_stamps$costs,(<span class="hljs-number">0</span>:<span class="hljs-number">5</span>)/<span class="hljs-number">5</span>)

<span class="hljs-comment"># create a new binned variable using these breaks</span>
food_stamps &lt;- food_stamps %&gt;%
  mutate(cost_bin = cut(costs, breaks, include.lowest=<span class="hljs-literal">TRUE</span>))
</code></pre><p>Here were are using the <code>mutate()</code> function from dplyr to create a new variable called <code>cost_bin</code>, using the <code>cut()</code> function. A quirk of this function is that you must specify <code>include.lowest=TRUE</code>, otherwise this value will be ignored.</p><p>View the <code>food_stamps</code> <code>data.frame</code> to see the new column:</p><p><img src="img/class11_19.jpg" alt=""></p><p>Run <code>str(food_stamps)</code> to see that the new variable is a <code>Factor</code>, or categorical variable.</p><p>To change the labels for these bins to something we might actually want to use on a chart legend, use the following code:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># clean up the labels for the bins
levels(food_stamps$cost_bin) &amp;lt;- c(&quot;&amp;lt;5.69&quot;,&quot;5.69-11.8&quot;,&quot;11.8-20.6&quot;,&quot;20.6-31.1&quot;,&quot;&amp;gt;31.1&quot;)
</code></pre>"><span class="hljs-comment"># clean up the labels for the bins</span>
levels(food_stamps$cost_bin) &lt;- c(<span class="hljs-string">"&lt;5.69"</span>,<span class="hljs-string">"5.69-11.8"</span>,<span class="hljs-string">"11.8-20.6"</span>,<span class="hljs-string">"20.6-31.1"</span>,<span class="hljs-string">"&gt;31.1"</span>)
</code></pre><p>Here we used the <code>levels()</code> function to rename the groups, or levels, of a categorical variable. The new names were supplied as a list.</p><p>Again view the data to see the result:</p><p><img src="img/class11_20.jpg" alt=""></p><h4 id="redraw-the-column-chart-using-the-binned-data"><a name="redraw-the-column-chart-using-the-binned-data" href="#redraw-the-column-chart-using-the-binned-data"></a>Redraw the column chart using the binned data</h4><p>First, create a new version of the basic food stamps chart, without any layers. We need to do this, because the new variable <code>cost_bin</code> was not included in the original <code>food_stamps_chart</code>:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># save modified chart with data mapping but no geom layers
food_stamps_chart_2 &amp;lt;- ggplot(food_stamps, aes(x=year, y=participants, fill=cost_bin)) %&amp;gt;%
  + xlab(&quot;Year&quot;) %&amp;gt;%
  + ylab(&quot;Participants (millions)&quot;)
</code></pre>"><span class="hljs-comment"># save modified chart with data mapping but no geom layers</span>
food_stamps_chart_2 &lt;- ggplot(food_stamps, aes(x=year, y=participants, fill=cost_bin)) %&gt;%
  + xlab(<span class="hljs-string">"Year"</span>) %&gt;%
  + ylab(<span class="hljs-string">"Participants (millions)"</span>)
</code></pre><p>Notice that this time we have mapped the fill of the bars in the initial aesthetic mapping, so it will carry through to the <code>geom_bar()</code> layer when we add that.</p><p>So now let’s add that layer:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># draw the chart coloring the columns using the binned data
food_stamps_chart_2 %&amp;gt;%
  + geom_bar(stat=&quot;identity&quot;) %&amp;gt;%
  + scale_fill_brewer(name=&quot;Costs \n($ billions)&quot;) %&amp;gt;%
  + ggtitle(&quot;Column chart&quot;)
</code></pre>"><span class="hljs-comment"># draw the chart coloring the columns using the binned data</span>
food_stamps_chart_2 %&gt;%
  + geom_bar(stat=<span class="hljs-string">"identity"</span>) %&gt;%
  + scale_fill_brewer(name=<span class="hljs-string">"Costs \n($ billions)"</span>) %&gt;%
  + ggtitle(<span class="hljs-string">"Column chart"</span>)
</code></pre><p>Notice that this time we have used <code>scale_fill_brewer()</code> to color the columns. This uses ColorBrewer schemes, and is very useful for mapping colors to categorical variables, or to continuous variables that have been binned to make categorical variables, as we did here.</p><p>Note the differences from the charts with color gradients that we made earlier:</p><p><img src="img/class11_21.jpg" alt=""></p><p>Usually, however, you will want to select a particular ColorBrewer palette, rather than accepting the default blues.</p><p>To see the available options, use the following code:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># view ColorBrewer palettes
display.brewer.all()
</code></pre>"><span class="hljs-comment"># view ColorBrewer palettes</span>
display.brewer.all()
</code></pre><p>I recommending saving this plot as a PDF for future referencee:</p><p><img src="img/class11_22.jpg" alt=""></p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># redraw the chart using ColorBrewer Reds palette
food_stamps_chart_2 %&amp;gt;%
  + geom_bar(stat=&quot;identity&quot;) %&amp;gt;%
  + scale_fill_brewer(name=&quot;Costs \n($ billions)&quot;, palette=&quot;Reds&quot;) %&amp;gt;%
  + ggtitle(&quot;Column chart&quot;)
</code></pre>"><span class="hljs-comment"># redraw the chart using ColorBrewer Reds palette</span>
food_stamps_chart_2 %&gt;%
  + geom_bar(stat=<span class="hljs-string">"identity"</span>) %&gt;%
  + scale_fill_brewer(name=<span class="hljs-string">"Costs \n($ billions)"</span>, palette=<span class="hljs-string">"Reds"</span>) %&gt;%
  + ggtitle(<span class="hljs-string">"Column chart"</span>)
</code></pre><p>This should be the result:</p><p><img src="img/class11_23.jpg" alt=""></p><h3 id="customize-your-ggplot2-charts-using-themes"><a name="customize-your-ggplot2-charts-using-themes" href="#customize-your-ggplot2-charts-using-themes"></a>Customize your ggplot2 charts using themes</h3><p>The charts we have made so far, using ggplot2’s default gray theme, have a somewhat “academic” look to them. However, ggplot2 has some other built-in themes that you may wish to use.</p><p>Run each of these lines of code, after each running the code for the last chart again</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># set ggplot2 themes
theme_set(theme_bw())

theme_set(theme_minimal())

theme_set(theme_gray())
</code></pre>"><span class="hljs-comment"># set ggplot2 themes</span>
theme_set(theme_bw())

theme_set(theme_minimal())

theme_set(theme_gray())
</code></pre><p>The results from the first two themes should be as follows:</p><p><img src="img/class11_24.jpg" alt=""></p><p><img src="img/class11_25.jpg" alt=""></p><p>The last <code>theme_set()</code> will return to the default gray theme.</p><p>You can also define your own customized theme to draw plots with just about any desired appearance, using the various options available under <code>Themes</code> in the <a href="http://docs.ggplot2.org/current/index.html">ggplot2 documentation</a>.</p><p>However, I do not recommend coding your themes manually, certainly not on each chart you draw. Instead, use <a href="https://bchartoff.shinyapps.io/ggShinyApp/">this web app</a> to set your theme options. When you are statisfied with the appearance of the chart in the app, click the <code>R script for theme (run every R session)</code> button to download your theme as an R script.</p><p>The data folder for this week includes two themes downloaded from this app, intended for use with column/bar charts and line/scatter plots respectively.</p><p>Double-click on the file <code>column_theme.R</code> and it will open in RStudio. Select and run all of the code in the file. Now run the code for the last chart again.</p><p>This should be the result:</p><p><img src="img/class11_26.jpg" alt=""></p><h3 id="import-and-process-data-from-world-bank-api"><a name="import-and-process-data-from-world-bank-api" href="#import-and-process-data-from-world-bank-api"></a>Import and process data from World Bank API</h3><p>One very nice thing about R is that its community of open source developers has written many packages that include useful datasets, or provide access to them by connecting to online APIs.</p><p>When working in R, it is worthwhile to run some Google searches to look for the existence of such packages, which can save you a lot of time.</p><p>The <a href="https://github.com/vincentarelbundock/WDI">WDI</a> package, for example, gives access to <a href="http://data.worldbank.org/indicator/all">World Bank indicators</a> via the World Bank’s <a href="http://data.worldbank.org/node/9">API</a>.</p><p>You can search for indicators containing key terms, such as “gdp,” using the following code:</p><pre class="r hljs"><code class="r" data-origin="<pre><code class=&quot;r&quot;>WDIsearch(&quot;gdp&quot;)
</code></pre>">WDIsearch(<span class="hljs-string">"gdp"</span>)
</code></pre><p><img src="img/class11_27.jpg" alt=""></p><p><img src="img/class11_28.jpg" alt=""></p><p><img src="img/class11_29.jpg" alt=""></p><p>We are going to import data for WDI variables used to make three charts in <a href="http://www.buzzfeed.com/peteraldhous/what-five-years-of-austerity-did-to-greeks-health">this BuzzFeed News article</a>.</p><p>The indicators are:</p><ul>
<li><code>SP.DYN.LE00.IN</code> Life expectancy at birth in years.</li><li><code>SH.XPD.PCA.PP.KD</code> Health spending per person, public and private, in 2011 dollars, correcting for purchasing power in different territories.</li><li><code>SL.UEM.TOTL.ZS</code> Unemployment rate, as a percentage of the total labor force.</li></ul><p>First make a list of the indicators to be imported:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># list of indicators to be imported using WDI package
indic_list &amp;lt;- c(&quot;SP.DYN.LE00.IN&quot;, &quot;SH.XPD.PCAP.PP.KD&quot;, &quot;SL.UEM.TOTL.ZS&quot;)
</code></pre>"><span class="hljs-comment"># list of indicators to be imported using WDI package</span>
indic_list &lt;- c(<span class="hljs-string">"SP.DYN.LE00.IN"</span>, <span class="hljs-string">"SH.XPD.PCAP.PP.KD"</span>, <span class="hljs-string">"SL.UEM.TOTL.ZS"</span>)
</code></pre><p>Now import the data and give the variables less cumbersome names:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># import data from World Bank API, rename variables
indicators &amp;lt;- WDI(indicator=indic_list, country=&quot;all&quot;, start=1990, end=2014) %&amp;gt;%
  rename(life_expect=SP.DYN.LE00.IN, health_spend=SH.XPD.PCAP.PP.KD, unemploy_rate=SL.UEM.TOTL.ZS)
</code></pre>"><span class="hljs-comment"># import data from World Bank API, rename variables</span>
indicators &lt;- WDI(indicator=indic_list, country=<span class="hljs-string">"all"</span>, start=<span class="hljs-number">1990</span>, end=<span class="hljs-number">2014</span>) %&gt;%
  rename(life_expect=SP.DYN.LE00.IN, health_spend=SH.XPD.PCAP.PP.KD, unemploy_rate=SL.UEM.TOTL.ZS)
</code></pre><p>This code used dplyr’s <code>rename()</code> function to rename the variables. The data will take a little time to load. When it has done so, view the data and examine its structure.</p><h3 id="assignment"><a name="assignment" href="#assignment"></a>Assignment</h3><ul>
<li><p>Use this data to make ggplot2 versions of three line charts shown above. You won’t be able to exactly replicate the appearance of the charts — for instance the legend and the gridlines will be different — but get as close as you can.</p>
<p>Here are some hints:</p>
<ul>
<li>Before you start, remember that you need to load the packages you will use in each R session.</li><li>For two of the charts you will need to filter using dplyr to obtain just the data for Germany, Greece and the EU. For the life expectancy chart you will need to include Russia as well. To keep your code concise, filter using the <code>iso2c</code> country code variable rather than the full <code>country</code> name.</li><li>For the health spending chart, you will either need to filter by <code>year</code>, or customize the X axis range, so that the chart starts in 1995, rather than 1990. Try experimenting with both options.</li><li>Make these charts using ggplot2’s <code>theme_minimal()</code></li><li>Customize the text on the X and Y axis labels.</li><li>Customize the <code>size</code> of the lines to make them a little thicker than the default.</li><li>Use a ColorBrewer qualatitative palette such as <code>Set1</code> or <code>Dark2</code> for the lines. You will need to use the <code>scale_color_brewer()</code> function to achieve this, which works like <code>scale_fill_brewer()</code>.</li><li>The units for the health spending chart should be <code>$</code>. This where the <strong>scales</strong> package comes in.<code>+ scale_y_continuous(label = dollar)</code> will format the axis as <code>$</code>.</li></ul>
</li></ul><ul>
<li><p>Export your charts as PDFs and sabve the R script for this exercise. Send me your PDFs and R script by the start of next week’s class.</p>
<p>This will be a challenging exercise, requiring you to review what we covered today and understand how the code works. Ask for help if you get stuck!</p>
</li></ul><h3 id="further-reading"><a name="further-reading" href="#further-reading"></a>Further reading</h3><p>Winston Chang: <a href="http://www.amazon.com/R-Graphics-Cookbook-Winston-Chang/dp/1449316956"><em>R Graphics Cookbook</em></a><br>(Chang also has <a href="http://www.cookbook-r.com/">a helpful website</a> with much of the same information, available for free.)</p><p>Hadley Wickham: <a href="http://www.amazon.com/gp/product/0387981403/"><em>ggplot2: Elegant Graphics For Data Analysis</em></a></p><p><a href="https://www.rstudio.com/wp-content/uploads/2015/08/ggplot2-cheatsheet.pdf">ggplot2</a> and <a href="https://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf">dplyr</a> cheat sheets from RStudio. The latter also introduces the <strong><a href="https://cran.r-project.org/web/packages/tidyr/tidyr.pdf">tidyr</a></strong> package, useful for converting data between wide and londg formats.</p><p><a href="http://docs.ggplot2.org/current/">ggplot2 documentation</a></p><p><a href="http://stcorp.nl/R_course/tutorial_ggplot2.html">ggplot2</a> and <a href="http://stcorp.nl/R_course/tutorial_dplyr.html">dplyr</a> tutorials from <a href="http://www.numbertheory.nl/about/">Paul Hiemstra</a>.</p><p><a href="http://stackoverflow.com/">Stack Overflow</a><br>Search the site, or <a href="http://stackoverflow.com/questions/tagged/r">browse R questions</a></p>

<footer style="position:fixed; font-size:.8em; text-align:right; bottom:0px; margin-left:-25px; height:20px; width:100%;">generated by <a href="http://pad.haroopress.com" target="_blank">haroopad</a></footer>
</body>
</html>
