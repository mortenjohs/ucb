<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>class13.html</title>
  <meta name="generator" content="Haroopad 0.13.1" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>div.oembedall-githubrepos{border:1px solid #DDD;border-radius:4px;list-style-type:none;margin:0 0 10px;padding:8px 10px 0;font:13.34px/1.4 helvetica,arial,freesans,clean,sans-serif;width:452px;background-color:#fff}div.oembedall-githubrepos .oembedall-body{background:-moz-linear-gradient(center top,#FAFAFA,#EFEFEF);background:-webkit-gradient(linear,left top,left bottom,from(#FAFAFA),to(#EFEFEF));border-bottom-left-radius:4px;border-bottom-right-radius:4px;border-top:1px solid #EEE;margin-left:-10px;margin-top:8px;padding:5px 10px;width:100%}div.oembedall-githubrepos h3{font-size:14px;margin:0;padding-left:18px;white-space:nowrap}div.oembedall-githubrepos p.oembedall-description{color:#444;font-size:12px;margin:0 0 3px}div.oembedall-githubrepos p.oembedall-updated-at{color:#888;font-size:11px;margin:0}div.oembedall-githubrepos ul.oembedall-repo-stats{border:none;float:right;font-size:11px;font-weight:700;padding-left:15px;position:relative;z-index:5;margin:0}div.oembedall-githubrepos ul.oembedall-repo-stats li{border:none;color:#666;display:inline-block;list-style-type:none;margin:0!important}div.oembedall-githubrepos ul.oembedall-repo-stats li a{background-color:transparent;border:none;color:#666!important;background-position:5px -2px;background-repeat:no-repeat;border-left:1px solid #DDD;display:inline-block;height:21px;line-height:21px;padding:0 5px 0 23px}div.oembedall-githubrepos ul.oembedall-repo-stats li:first-child a{border-left:medium none;margin-right:-3px}div.oembedall-githubrepos ul.oembedall-repo-stats li a:hover{background:5px -27px no-repeat #4183C4;color:#FFF!important;text-decoration:none}div.oembedall-githubrepos ul.oembedall-repo-stats li:first-child a:hover{border-bottom-left-radius:3px;border-top-left-radius:3px}ul.oembedall-repo-stats li:last-child a:hover{border-bottom-right-radius:3px;border-top-right-radius:3px}span.oembedall-closehide{background-color:#aaa;border-radius:2px;cursor:pointer;margin-right:3px}div.oembedall-container{margin-top:5px;text-align:left}.oembedall-ljuser{font-weight:700}.oembedall-ljuser img{vertical-align:bottom;border:0;padding-right:1px}.oembedall-stoqembed{border-bottom:1px dotted #999;float:left;overflow:hidden;width:730px;line-height:1;background:#FFF;color:#000;font-family:Arial,Liberation Sans,DejaVu Sans,sans-serif;font-size:80%;text-align:left;margin:0;padding:0}.oembedall-stoqembed a{color:#07C;text-decoration:none;margin:0;padding:0}.oembedall-stoqembed a:hover{text-decoration:underline}.oembedall-stoqembed a:visited{color:#4A6B82}.oembedall-stoqembed h3{font-family:Trebuchet MS,Liberation Sans,DejaVu Sans,sans-serif;font-size:130%;font-weight:700;margin:0;padding:0}.oembedall-stoqembed .oembedall-reputation-score{color:#444;font-size:120%;font-weight:700;margin-right:2px}.oembedall-stoqembed .oembedall-user-info{height:35px;width:185px}.oembedall-stoqembed .oembedall-user-info .oembedall-user-gravatar32{float:left;height:32px;width:32px}.oembedall-stoqembed .oembedall-user-info .oembedall-user-details{float:left;margin-left:5px;overflow:hidden;white-space:nowrap;width:145px}.oembedall-stoqembed .oembedall-question-hyperlink{font-weight:700}.oembedall-stoqembed .oembedall-stats{background:#EEE;margin:0 0 0 7px;padding:4px 7px 6px;width:58px}.oembedall-stoqembed .oembedall-statscontainer{float:left;margin-right:8px;width:86px}.oembedall-stoqembed .oembedall-votes{color:#555;padding:0 0 7px;text-align:center}.oembedall-stoqembed .oembedall-vote-count-post{font-size:240%;color:#808185;display:block;font-weight:700}.oembedall-stoqembed .oembedall-views{color:#999;padding-top:4px;text-align:center}.oembedall-stoqembed .oembedall-status{margin-top:-3px;padding:4px 0;text-align:center;background:#75845C;color:#FFF}.oembedall-stoqembed .oembedall-status strong{color:#FFF;display:block;font-size:140%}.oembedall-stoqembed .oembedall-summary{float:left;width:635px}.oembedall-stoqembed .oembedall-excerpt{line-height:1.2;margin:0;padding:0 0 5px}.oembedall-stoqembed .oembedall-tags{float:left;line-height:18px}.oembedall-stoqembed .oembedall-tags a:hover{text-decoration:none}.oembedall-stoqembed .oembedall-post-tag{background-color:#E0EAF1;border-bottom:1px solid #3E6D8E;border-right:1px solid #7F9FB6;color:#3E6D8E;font-size:90%;line-height:2.4;margin:2px 2px 2px 0;padding:3px 4px;text-decoration:none;white-space:nowrap}.oembedall-stoqembed .oembedall-post-tag:hover{background-color:#3E6D8E;border-bottom:1px solid #37607D;border-right:1px solid #37607D;color:#E0EAF1}.oembedall-stoqembed .oembedall-fr{float:right}.oembedall-stoqembed .oembedall-statsarrow{background-image:url(http://cdn.sstatic.net/stackoverflow/img/sprites.png?v=3);background-repeat:no-repeat;overflow:hidden;background-position:0 -435px;float:right;height:13px;margin-top:12px;width:7px}.oembedall-facebook1{border:1px solid #1A3C6C;padding:0;font:13.34px/1.4 verdana;width:500px}.oembedall-facebook2{background-color:#627add}.oembedall-facebook2 a{color:#e8e8e8;text-decoration:none}.oembedall-facebookBody{background-color:#fff;vertical-align:top;padding:5px}.oembedall-facebookBody .contents{display:inline-block;width:100%}.oembedall-facebookBody div img{float:left;margin-right:5px}div.oembedall-lanyard{-webkit-box-shadow:none;-webkit-transition-delay:0s;-webkit-transition-duration:.4000000059604645s;-webkit-transition-property:width;-webkit-transition-timing-function:cubic-bezier(0.42,0,.58,1);background-attachment:scroll;background-clip:border-box;background-color:transparent;background-image:none;background-origin:padding-box;border-width:0;box-shadow:none;color:#112644;display:block;float:left;font-family:'Trebuchet MS',Trebuchet,sans-serif;font-size:16px;height:253px;line-height:19px;margin:0;max-width:none;min-height:0;outline:#112644 0;overflow-x:visible;overflow-y:visible;padding:0;position:relative;text-align:left;vertical-align:baseline;width:804px}div.oembedall-lanyard .tagline{font-size:1.5em}div.oembedall-lanyard .wrapper{overflow:hidden;clear:both}div.oembedall-lanyard .split{float:left;display:inline}div.oembedall-lanyard .prominent-place .flag:active,div.oembedall-lanyard .prominent-place .flag:focus,div.oembedall-lanyard .prominent-place .flag:hover,div.oembedall-lanyard .prominent-place .flag:link,div.oembedall-lanyard .prominent-place .flag:visited{float:left;display:block;width:48px;height:48px;position:relative;top:-5px;margin-right:10px}div.oembedall-lanyard .place-context{font-size:.889em}div.oembedall-lanyard .prominent-place .sub-place{display:block}div.oembedall-lanyard .prominent-place{font-size:1.125em;line-height:1.1em;font-weight:400}div.oembedall-lanyard .main-date{color:#8CB4E0;font-weight:700;line-height:1.1}div.oembedall-lanyard .first{width:48.57%;margin:0 0 0 2.857%}.mermaid .label{color:#333}.node circle,.node polygon,.node rect{fill:#cde498;stroke:#13540c;stroke-width:1px}.edgePath .path{stroke:green;stroke-width:1.5px}.cluster rect{fill:#cdffb2;rx:40;stroke:#6eaa49;stroke-width:1px}.cluster text{fill:#333}.actor{stroke:#13540c;fill:#cde498}text.actor{fill:#000;stroke:none}.actor-line{stroke:grey}.messageLine0{stroke-width:1.5;stroke-dasharray:"2 2";marker-end:"url(#arrowhead)";stroke:#333}.messageLine1{stroke-width:1.5;stroke-dasharray:"2 2";stroke:#333}#arrowhead{fill:#333}#crosshead path{fill:#333!important;stroke:#333!important}.messageText{fill:#333;stroke:none}.labelBox{stroke:#326932;fill:#cde498}.labelText,.loopText{fill:#000;stroke:none}.loopLine{stroke-width:2;stroke-dasharray:"2 2";marker-end:"url(#arrowhead)";stroke:#326932}.note{stroke:#6eaa49;fill:#fff5ad}.noteText{fill:#000;stroke:none;font-family:'trebuchet ms',verdana,arial;font-size:14px}.section{stroke:none;opacity:.2}.section0,.section2{fill:#6eaa49}.section1,.section3{fill:#fff;opacity:.2}.sectionTitle0,.sectionTitle1,.sectionTitle2,.sectionTitle3{fill:#333}.sectionTitle{text-anchor:start;font-size:11px;text-height:14px}.grid .tick{stroke:lightgrey;opacity:.3;shape-rendering:crispEdges}.grid path{stroke-width:0}.today{fill:none;stroke:red;stroke-width:2px}.task{stroke-width:2}.taskText{text-anchor:middle;font-size:11px}.taskTextOutsideRight{fill:#000;text-anchor:start;font-size:11px}.taskTextOutsideLeft{fill:#000;text-anchor:end;font-size:11px}.taskText0,.taskText1,.taskText2,.taskText3{fill:#fff}.task0,.task1,.task2,.task3{fill:#487e3a;stroke:#13540c}.taskTextOutside0,.taskTextOutside1,.taskTextOutside2,.taskTextOutside3{fill:#000}.active0,.active1,.active2,.active3{fill:#cde498;stroke:#13540c}.activeText0,.activeText1,.activeText2,.activeText3{fill:#000!important}.done0,.done1,.done2,.done3{stroke:grey;fill:lightgrey;stroke-width:2}.doneText0,.doneText1,.doneText2,.doneText3{fill:#000!important}.crit0,.crit1,.crit2,.crit3{stroke:#f88;fill:red;stroke-width:2}.activeCrit0,.activeCrit1,.activeCrit2,.activeCrit3{stroke:#f88;fill:#cde498;stroke-width:2}.doneCrit0,.doneCrit1,.doneCrit2,.doneCrit3{stroke:#f88;fill:lightgrey;stroke-width:2;cursor:pointer;shape-rendering:crispEdges}.activeCritText0,.activeCritText1,.activeCritText2,.activeCritText3,.doneCritText0,.doneCritText1,.doneCritText2,.doneCritText3{fill:#000!important}.titleText{text-anchor:middle;font-size:18px;fill:#000}text{font-family:'trebuchet ms',verdana,arial;font-size:14px}html{height:100%}body{margin:0!important;padding:5px 20px 26px!important;background-color:#fff;font-family:"Lucida Grande","Segoe UI","Apple SD Gothic Neo","Malgun Gothic","Lucida Sans Unicode",Helvetica,Arial,sans-serif;font-size:.9em;overflow-x:hidden;overflow-y:auto}br,h1,h2,h3,h4,h5,h6{clear:both}hr.page{background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC) repeat-x;border:0;height:3px;padding:0}hr.underscore{border-top-style:dashed!important}body >:first-child{margin-top:0!important}img.plugin{box-shadow:0 1px 3px rgba(0,0,0,.1);border-radius:3px}iframe{border:0}figure{-webkit-margin-before:0;-webkit-margin-after:0;-webkit-margin-start:0;-webkit-margin-end:0}kbd{border:1px solid #aaa;-moz-border-radius:2px;-webkit-border-radius:2px;border-radius:2px;-moz-box-shadow:1px 2px 2px #ddd;-webkit-box-shadow:1px 2px 2px #ddd;box-shadow:1px 2px 2px #ddd;background-color:#f9f9f9;background-image:-moz-linear-gradient(top,#eee,#f9f9f9,#eee);background-image:-o-linear-gradient(top,#eee,#f9f9f9,#eee);background-image:-webkit-linear-gradient(top,#eee,#f9f9f9,#eee);background-image:linear-gradient(top,#eee,#f9f9f9,#eee);padding:1px 3px;font-family:inherit;font-size:.85em}.oembeded .oembed_photo{display:inline-block}img[data-echo]{margin:25px 0;width:100px;height:100px;background:url(../img/ajax.gif) center center no-repeat #fff}.spinner{display:inline-block;width:10px;height:10px;margin-bottom:-.1em;border:2px solid rgba(0,0,0,.5);border-top-color:transparent;border-radius:100%;-webkit-animation:spin 1s infinite linear;animation:spin 1s infinite linear}.spinner:after{content:'';display:block;width:0;height:0;position:absolute;top:-6px;left:0;border:4px solid transparent;border-bottom-color:rgba(0,0,0,.5);-webkit-transform:rotate(45deg);transform:rotate(45deg)}@-webkit-keyframes spin{to{-webkit-transform:rotate(360deg)}}@keyframes spin{to{transform:rotate(360deg)}}p.toc{margin:0!important}p.toc ul{padding-left:10px}p.toc>ul{padding:10px;margin:0 10px;display:inline-block;border:1px solid #ededed;border-radius:5px}p.toc li,p.toc ul{list-style-type:none}p.toc li{width:100%;padding:0;overflow:hidden}p.toc li a::after{content:"."}p.toc li a:before{content:"• "}p.toc h5{text-transform:uppercase}p.toc .title{float:left;padding-right:3px}p.toc .number{margin:0;float:right;padding-left:3px;background:#fff;display:none}input.task-list-item{margin-left:-1.62em}.markdown{font-family:"Hiragino Sans GB","Microsoft YaHei",STHeiti,SimSun,"Lucida Grande","Lucida Sans Unicode","Lucida Sans",'Segoe UI',AppleSDGothicNeo-Medium,'Malgun Gothic',Verdana,Tahoma,sans-serif;padding:20px}.markdown a{text-decoration:none;vertical-align:baseline}.markdown a:hover{text-decoration:underline}.markdown h1{font-size:2.2em;font-weight:700;margin:1.5em 0 1em}.markdown h2{font-size:1.8em;font-weight:700;margin:1.275em 0 .85em}.markdown h3{font-size:1.6em;font-weight:700;margin:1.125em 0 .75em}.markdown h4{font-size:1.4em;font-weight:700;margin:.99em 0 .66em}.markdown h5{font-size:1.2em;font-weight:700;margin:.855em 0 .57em}.markdown h6{font-size:1em;font-weight:700;margin:.75em 0 .5em}.markdown h1+p,.markdown h1:first-child,.markdown h2+p,.markdown h2:first-child,.markdown h3+p,.markdown h3:first-child,.markdown h4+p,.markdown h4:first-child,.markdown h5+p,.markdown h5:first-child,.markdown h6+p,.markdown h6:first-child{margin-top:0}.markdown hr{border:1px solid #ccc}.markdown p{margin:1em 0;word-wrap:break-word}.markdown ol{list-style-type:decimal}.markdown li{display:list-item;line-height:1.4em}.markdown blockquote{margin:1em 20px}.markdown blockquote>:first-child{margin-top:0}.markdown blockquote>:last-child{margin-bottom:0}.markdown blockquote cite:before{content:'\2014 \00A0'}.markdown .code{border-radius:3px;word-wrap:break-word}.markdown pre{border-radius:3px;word-wrap:break-word;border:1px solid #ccc;overflow:auto;padding:.5em}.markdown pre code{border:0;display:block}.markdown pre>code{font-family:Consolas,Inconsolata,Courier,monospace;font-weight:700;white-space:pre;margin:0}.markdown code{border-radius:3px;word-wrap:break-word;border:1px solid #ccc;padding:0 5px;margin:0 2px}.markdown img{max-width:100%}.markdown mark{color:#000;background-color:#fcf8e3}.markdown table{padding:0;border-collapse:collapse;border-spacing:0;margin-bottom:16px}.markdown table tr td,.markdown table tr th{border:1px solid #ccc;margin:0;padding:6px 13px}.markdown table tr th{font-weight:700}.markdown table tr th>:first-child{margin-top:0}.markdown table tr th>:last-child{margin-bottom:0}.markdown table tr td>:first-child{margin-top:0}.markdown table tr td>:last-child{margin-bottom:0}.github{padding:20px;font-family:"Helvetica Neue",Helvetica,"Hiragino Sans GB","Microsoft YaHei",STHeiti,SimSun,"Segoe UI",AppleSDGothicNeo-Medium,'Malgun Gothic',Arial,freesans,sans-serif;font-size:15px;background:#fff;line-height:1.6;-webkit-font-smoothing:antialiased}.github a{color:#3269a0}.github a:hover{color:#4183c4}.github h2{border-bottom:1px solid #e6e6e6;line-height:1.6}.github h6{color:#777}.github hr{border:1px solid #e6e6e6}.github pre>code{font-size:.9em;font-family:Consolas,Inconsolata,Courier,monospace}.github blockquote>code,.github h1>code,.github h2>code,.github h3>code,.github h4>code,.github h5>code,.github h6>code,.github li>code,.github p>code,.github td>code{background-color:rgba(0,0,0,.07);font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;font-size:85%;padding:.2em .5em;border:0}.github blockquote{border-left:4px solid #e6e6e6;padding:0 15px;font-style:italic}.github table{background-color:#fafafa}.github table tr td,.github table tr th{border:1px solid #e6e6e6}.github table tr:nth-child(2n){background-color:#f2f2f2}.hljs{display:block;overflow-x:auto;padding:.5em;background:#f0f0f0;-webkit-text-size-adjust:none}.hljs,.hljs-subst,.hljs-tag .hljs-title,.nginx .hljs-title{color:#000}.apache .hljs-cbracket,.apache .hljs-tag,.asciidoc .hljs-header,.bash .hljs-variable,.coffeescript .hljs-attribute,.django .hljs-variable,.erlang_repl .hljs-function_or_atom,.haml .hljs-symbol,.hljs-addition,.hljs-constant,.hljs-flow,.hljs-parent,.hljs-pragma,.hljs-preprocessor,.hljs-rules .hljs-value,.hljs-stream,.hljs-string,.hljs-tag .hljs-value,.hljs-template_tag,.hljs-title,.markdown .hljs-header,.ruby .hljs-symbol,.ruby .hljs-symbol .hljs-string,.smalltalk .hljs-class,.tex .hljs-command,.tex .hljs-special{color:#800}.asciidoc .hljs-blockquote,.diff .hljs-header,.hljs-annotation,.hljs-chunk,.hljs-comment,.markdown .hljs-blockquote,.smartquote{color:#888}.asciidoc .hljs-bullet,.asciidoc .hljs-link_url,.go .hljs-constant,.hljs-change,.hljs-date,.hljs-hexcolor,.hljs-literal,.hljs-number,.hljs-regexp,.lasso .hljs-variable,.makefile .hljs-variable,.markdown .hljs-bullet,.markdown .hljs-link_url,.smalltalk .hljs-char,.smalltalk .hljs-symbol{color:#080}.apache .hljs-sqbracket,.asciidoc .hljs-attribute,.asciidoc .hljs-link_label,.clojure .hljs-attribute,.coffeescript .hljs-property,.erlang_repl .hljs-reserved,.haml .hljs-bullet,.hljs-array,.hljs-attr_selector,.hljs-decorator,.hljs-deletion,.hljs-doctype,.hljs-envvar,.hljs-filter .hljs-argument,.hljs-important,.hljs-javadoc,.hljs-label,.hljs-localvars,.hljs-phony,.hljs-pi,.hljs-prompt,.hljs-pseudo,.hljs-shebang,.lasso .hljs-attribute,.markdown .hljs-link_label,.nginx .hljs-built_in,.ruby .hljs-string,.tex .hljs-formula,.vhdl .hljs-attribute{color:#88f}.apache .hljs-tag,.asciidoc .hljs-strong,.bash .hljs-variable,.css .hljs-tag,.hljs-built_in,.hljs-dartdoc,.hljs-id,.hljs-javadoctag,.hljs-keyword,.hljs-phpdoc,.hljs-request,.hljs-status,.hljs-title,.hljs-type,.hljs-typename,.hljs-winutils,.hljs-yardoctag,.markdown .hljs-strong,.smalltalk .hljs-class,.tex .hljs-command{font-weight:700}.asciidoc .hljs-emphasis,.markdown .hljs-emphasis{font-style:italic}.nginx .hljs-built_in{font-weight:400}.coffeescript .javascript,.javascript .xml,.lasso .markup,.tex .hljs-formula,.xml .css,.xml .hljs-cdata,.xml .javascript,.xml .vbscript{opacity:.5}.MathJax_Hover_Frame{border-radius:.25em;-webkit-border-radius:.25em;-moz-border-radius:.25em;-khtml-border-radius:.25em;box-shadow:0 0 15px #83A;-webkit-box-shadow:0 0 15px #83A;-moz-box-shadow:0 0 15px #83A;-khtml-box-shadow:0 0 15px #83A;border:1px solid #A6D!important;display:inline-block;position:absolute}.MathJax_Hover_Arrow{position:absolute;width:15px;height:11px;cursor:pointer}#MathJax_About{position:fixed;left:50%;width:auto;text-align:center;border:3px outset;padding:1em 2em;background-color:#DDD;color:#000;cursor:default;font-family:message-box;font-size:120%;font-style:normal;text-indent:0;text-transform:none;line-height:normal;letter-spacing:normal;word-spacing:normal;word-wrap:normal;white-space:nowrap;float:none;z-index:201;border-radius:15px;-webkit-border-radius:15px;-moz-border-radius:15px;-khtml-border-radius:15px;box-shadow:0 10px 20px gray;-webkit-box-shadow:0 10px 20px gray;-moz-box-shadow:0 10px 20px gray;-khtml-box-shadow:0 10px 20px gray;filter:progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}.MathJax_Menu{position:absolute;background-color:#fff;color:#000;width:auto;padding:5px 0;border:1px solid #CCC;margin:0;cursor:default;font:menu;text-align:left;text-indent:0;text-transform:none;line-height:normal;letter-spacing:normal;word-spacing:normal;word-wrap:normal;white-space:nowrap;float:none;z-index:201;border-radius:5px;-webkit-border-radius:5px;-moz-border-radius:5px;-khtml-border-radius:5px;box-shadow:0 10px 20px gray;-webkit-box-shadow:0 10px 20px gray;-moz-box-shadow:0 10px 20px gray;-khtml-box-shadow:0 10px 20px gray;filter:progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}.MathJax_MenuItem{padding:1px 2em;background:0 0}.MathJax_MenuArrow{position:absolute;right:.5em;color:#666}.MathJax_MenuActive .MathJax_MenuArrow{color:#fff}.MathJax_MenuArrow.RTL{left:.5em;right:auto}.MathJax_MenuCheck{position:absolute;left:.7em}.MathJax_MenuCheck.RTL{right:.7em;left:auto}.MathJax_MenuRadioCheck{position:absolute;left:.7em}.MathJax_MenuRadioCheck.RTL{right:.7em;left:auto}.MathJax_MenuLabel{padding:1px 2em 3px 1.33em;font-style:italic}.MathJax_MenuRule{border-top:1px solid #DDD;margin:4px 3px}.MathJax_MenuDisabled{color:GrayText}.MathJax_MenuActive{background-color:#606872;color:#fff}.MathJax_Menu_Close{position:absolute;width:31px;height:31px;top:-15px;left:-15px}#MathJax_Zoom{position:absolute;background-color:#F0F0F0;overflow:auto;display:block;z-index:301;padding:.5em;border:1px solid #000;margin:0;font-weight:400;font-style:normal;text-align:left;text-indent:0;text-transform:none;line-height:normal;letter-spacing:normal;word-spacing:normal;word-wrap:normal;white-space:nowrap;float:none;box-shadow:5px 5px 15px #AAA;-webkit-box-shadow:5px 5px 15px #AAA;-moz-box-shadow:5px 5px 15px #AAA;-khtml-box-shadow:5px 5px 15px #AAA;filter:progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}#MathJax_ZoomOverlay{position:absolute;left:0;top:0;z-index:300;display:inline-block;width:100%;height:100%;border:0;padding:0;margin:0;background-color:#fff;opacity:0;filter:alpha(opacity=0)}#MathJax_ZoomFrame{position:relative;display:inline-block;height:0;width:0}#MathJax_ZoomEventTrap{position:absolute;left:0;top:0;z-index:302;display:inline-block;border:0;padding:0;margin:0;background-color:#fff;opacity:0;filter:alpha(opacity=0)}.MathJax_Preview{color:#888}#MathJax_Message{position:fixed;left:1px;bottom:2px;background-color:#E6E6E6;border:1px solid #959595;margin:0;padding:2px 8px;z-index:102;color:#000;font-size:80%;width:auto;white-space:nowrap}#MathJax_MSIE_Frame{position:absolute;top:0;left:0;width:0;z-index:101;border:0;margin:0;padding:0}.MathJax_Error{color:#C00;font-style:italic}footer{position:fixed;font-size:.8em;text-align:right;bottom:0;margin-left:-25px;height:20px;width:100%}</style>
</head>
<body class="markdown github">
<h1 id="from-r-to-interactive-charts-and-maps"><a name="from-r-to-interactive-charts-and-maps" href="#from-r-to-interactive-charts-and-maps"></a>From R to interactive charts and maps</h1><h3 id="let's-make-this-easier"><a name="let's-make-this-easier" href="#let's-make-this-easier"></a>Let’s make this easier</h3><p>As we saw in last week’s class, coding graphics from scratch using D3 is a laborious process. For standard chart types, as we discussed, you may wish to write D3 templates that can be modified for individual projects.</p><p>However, we will today explore another approach: Making JavaScript visualizations directly from R/RStudio. This has become possible recently thanks to an R package called <a href="http://rcharts.io/">rCharts</a>, which connects to multiple JavaScript charting libraries, and a group of packages collectively known as <a href="http://www.htmlwidgets.org/">htmlwidgets</a>.</p><p>I have used these in my own work to create simple interactive charts, in posts such as <a href="http://www.buzzfeed.com/peteraldhous/what-five-years-of-austerity-did-to-greeks-health">this</a> and <a href="http://www.buzzfeed.com/peteraldhous/why-katrina-was-the-storm-from-hell">this</a>.</p><p>One advantage of this approach is that I can work in a single environment both to process my data and to make my online charts. Maintaining a simple, streamlined workflow allows me to produce graphics quickly on news deadlines.</p><h3 id="the-data-we-will-use-today"><a name="the-data-we-will-use-today" href="#the-data-we-will-use-today"></a>The data we will use today</h3><p>Download the data for this session from <a href="data/week13.zip">here</a>, unzip the folder and place it on your desktop. It contains the following folders and files:</p><ul>
<li><code>src</code> Folder containing local copies of the following JavaScript libraries: <a href="http://d3js.org/">D3</a>, <a href="http://nvd3.org/">NVD3</a>, <a href="http://www.highcharts.com/">Highcharts</a> and <a href="https://jquery.com/">jQuery</a>.</li><li><code>css</code> Folder with CSS style sheet for the NVD3 library.</li><li><code>seismic_risk_clip</code> Folder containing <a href="http://earthquake.usgs.gov/hazards/products/conterminous/index.php#2014">U.S. Geological Survey shapefile</a>,  detailing the risk of experiencing a major earthquake, clipped to the boundaries of the continental United States.</li><li><code>storms.csv</code> Data on North Atlantic <a href="http://www.aoml.noaa.gov/hrd/hurdat/Data_Storm.html">tropical storms and hurricanes</a> compiled by by the Hurricane Research Division of the U.S. National Oceanic and Atmospheric Administration.</li><li><code>senate-113-2014.json</code> JSON data on voting patterns in the U.S. Senate in 2014, detailing the number and percentage of times pairs of Senators voted the same way in each year. Scraped from <a href="https://www.govtrack.us/">GovTrack.US</a>, as described <a href="http://paldhous.github.io/NICAR/2015/gephi.html">here</a>.</li></ul><h3 id="install-rcharts-and-make-some-simple-charts"><a name="install-rcharts-and-make-some-simple-charts" href="#install-rcharts-and-make-some-simple-charts"></a>Install rCharts and make some simple charts</h3><p>Launch RStudio, create a new RScript, and set the working directory to the downloaded folder using the following code:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># set working directory
setwd(&quot;~/Desktop/week13&quot;)
</code></pre>"><span class="hljs-comment"># set working directory</span>
setwd(<span class="hljs-string">"~/Desktop/week13"</span>)
</code></pre><p>Save the script as <code>week13.R</code>.</p><p>We are going to install rCharts directly from its <a href="https://github.com/ramnathv/rCharts">GitHub repository</a>. To do this, we first need to install and load a package called <a href="https://cran.r-project.org/web/packages/devtools/devtools.pdf">devtools</a>, which you can do with the following code:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># install and load devtools
install.packages(&quot;devtools&quot;)
library(devtools)
</code></pre>"><span class="hljs-comment"># install and load devtools</span>
install.packages(<span class="hljs-string">"devtools"</span>)
<span class="hljs-keyword">library</span>(devtools)
</code></pre><p>Now we can install and load rCharts:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># install and load rCharts
install_github(&quot;rCharts&quot;, &quot;ramnathv&quot;)
library(rCharts)
</code></pre>"><span class="hljs-comment"># install and load rCharts</span>
install_github(<span class="hljs-string">"rCharts"</span>, <span class="hljs-string">"ramnathv"</span>)
<span class="hljs-keyword">library</span>(rCharts)
</code></pre><h4 id="make-line-charts-from-world-bank-data"><a name="make-line-charts-from-world-bank-data" href="#make-line-charts-from-world-bank-data"></a>Make line charts from World Bank data</h4><p>As in Week 11, we are going to download and process data from the World Bank’s World Development Indicators. So again, we need the <a href="https://cran.r-project.org/web/packages/WDI/WDI.pdf">WDI</a> and <a href="https://cran.rstudio.com/web/packages/dplyr/vignettes/introduction.html">dplyr</a> packages. Load them now:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># load WDI and dplyr
library(WDI)
library(dplyr)
</code></pre>"><span class="hljs-comment"># load WDI and dplyr</span>
<span class="hljs-keyword">library</span>(WDI)
<span class="hljs-keyword">library</span>(dplyr)
</code></pre><p>Next run this block of code:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># import World Bank data
# list of indicators to be imported
indic_list &amp;lt;- c(&quot;SP.DYN.LE00.IN&quot;, &quot;SH.XPD.PCAP.PP.KD&quot;, &quot;SL.UEM.TOTL.ZS&quot;)

# import indicators, rename variables, and round numbers
indicators &amp;lt;- WDI(indicator=indic_list, 
                  country=&quot;all&quot;, 
                  start=1990, 
                  end=2013) %&amp;gt;%
  rename(life_expect=SP.DYN.LE00.IN, 
         health_spend=SH.XPD.PCAP.PP.KD, 
         unemploy_rate=SL.UEM.TOTL.ZS) %&amp;gt;%
  mutate(life_expect=round(life_expect, digits=2),
         unemploy_rate=round(unemploy_rate, digits=2), 
         health_spend=round(health_spend, digits=0))

# filter for countries/region of interest
countries &amp;lt;- filter(indicators, iso2c==&quot;GR&quot;|iso2c==&quot;DE&quot;|iso2c==&quot;EU&quot;|iso2c==&quot;RU&quot;)

# edit country/region names
countries$country &amp;lt;- gsub(&quot;Russian Federation&quot;, &quot;Russia&quot;, countries$country)
countries$country &amp;lt;- gsub(&quot;European Union&quot;, &quot;EU&quot;, countries$country)
</code></pre>"><span class="hljs-comment"># import World Bank data</span>
<span class="hljs-comment"># list of indicators to be imported</span>
indic_list &lt;- c(<span class="hljs-string">"SP.DYN.LE00.IN"</span>, <span class="hljs-string">"SH.XPD.PCAP.PP.KD"</span>, <span class="hljs-string">"SL.UEM.TOTL.ZS"</span>)

<span class="hljs-comment"># import indicators, rename variables, and round numbers</span>
indicators &lt;- WDI(indicator=indic_list, 
                  country=<span class="hljs-string">"all"</span>, 
                  start=<span class="hljs-number">1990</span>, 
                  end=<span class="hljs-number">2013</span>) %&gt;%
  rename(life_expect=SP.DYN.LE00.IN, 
         health_spend=SH.XPD.PCAP.PP.KD, 
         unemploy_rate=SL.UEM.TOTL.ZS) %&gt;%
  mutate(life_expect=round(life_expect, digits=<span class="hljs-number">2</span>),
         unemploy_rate=round(unemploy_rate, digits=<span class="hljs-number">2</span>), 
         health_spend=round(health_spend, digits=<span class="hljs-number">0</span>))

<span class="hljs-comment"># filter for countries/region of interest</span>
countries &lt;- filter(indicators, iso2c==<span class="hljs-string">"GR"</span>|iso2c==<span class="hljs-string">"DE"</span>|iso2c==<span class="hljs-string">"EU"</span>|iso2c==<span class="hljs-string">"RU"</span>)

<span class="hljs-comment"># edit country/region names</span>
countries$country &lt;- gsub(<span class="hljs-string">"Russian Federation"</span>, <span class="hljs-string">"Russia"</span>, countries$country)
countries$country &lt;- gsub(<span class="hljs-string">"European Union"</span>, <span class="hljs-string">"EU"</span>, countries$country)
</code></pre><p>This is similar to the code we ran in Week 11. In addition, we have used the dplyr function <code>mutate()</code> to apply some rounding to the data in the renamed variables <code>life_expect</code>, <code>health_spend</code> and <code>unemploy_rate</code>.</p><p>Then we have created a new data frame called <code>countries</code> by filtering the full dataset.</p><p>Finally, we have used R’s <code>gsub()</code> function, which substitutes one string of text for another, to shorten the names for Russia and the EU, which will help keep the chart legend labels brief.</p><h5 id="line-chart-with-nvd3"><a name="line-chart-with-nvd3" href="#line-chart-with-nvd3"></a>Line chart with NVD3</h5><p>Now we will use rCharts with the <a href="http://nvd3.org/">NVD3</a> JavaScript library to draw a line chart from this data. NVD3 sits on top of D3, and can produce a range of standard chart types (see the examples in the further reading/resources, below).</p><p>This code will approximately replicate the last chart in <a href="http://www.buzzfeed.com/peteraldhous/what-five-years-of-austerity-did-to-greeks-health">this article</a>:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># make life expectancy line chart with NVD3
life_expect_n &amp;lt;- nPlot(life_expect ~ year, 
                          group = &quot;country&quot;, 
                          data = countries, 
                          type = &quot;lineChart&quot;)
</code></pre>"><span class="hljs-comment"># make life expectancy line chart with NVD3</span>
life_expect_n &lt;- nPlot(life_expect ~ year, 
                          group = <span class="hljs-string">"country"</span>, 
                          data = countries, 
                          type = <span class="hljs-string">"lineChart"</span>)
</code></pre><p><code>nPlot()</code> is an rCharts function that creates a plot using the NVD3 library. The first part of the code in this function puts the variable <code>life_expect</code> on the Y axis and <code>year</code> on the X axis; <code>data = countries</code> draws the chart from the <code>countries</code> data frame, <code>type = "lineChart"</code> selects the relevant NVD3 chart type (see the <a href="http://nvd3-community.github.io/nvd3/">examples</a> for others that are available); <code>group = "country"</code> uses the categorical variable of <code>country</code> to draw a different line for each country in the data, in a different color. The chart type and grouping variable should be put inside quote marks.</p><p>Running this code creates an <code>Nvd3</code> object in your Environment that can then be plotted in RStudio’s Viewer just by running its name:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># plot chart
life_expect_n
</code></pre>"><span class="hljs-comment"># plot chart</span>
life_expect_n
</code></pre><p>Your RStudio window should now look like this:</p><p><img src="img/class13_1.jpg" alt=""></p><p>By default, NVD3 uses the <code>d3.scale.category20()</code> color palette for categorical variables. However, having made the basic chart, we can customize it, here manually applying a ColorBrewer qualitative palette, and adding a label for the Y axis.</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># customize the chart
life_expect_n$yAxis(axisLabel=(&quot;Life expectancy at birth (years)&quot;))
life_expect_n$chart(color = c(&quot;#e41a1c&quot;, &quot;#377eb8&quot;, &quot;#4daf4a&quot;, &quot;#984ea3&quot;))
</code></pre>"><span class="hljs-comment"># customize the chart</span>
life_expect_n$yAxis(axisLabel=(<span class="hljs-string">"Life expectancy at birth (years)"</span>))
life_expect_n$chart(color = c(<span class="hljs-string">"#e41a1c"</span>, <span class="hljs-string">"#377eb8"</span>, <span class="hljs-string">"#4daf4a"</span>, <span class="hljs-string">"#984ea3"</span>))
</code></pre><p>Plot the chart again after running this code, and your RStudio window should look like this:</p><p><img src="img/class13_2.jpg" alt=""></p><p>Don’t worry if your chart extends beyond your Viewer panel: rCharts by default makes charts at 800px wide, but we will switch to a responsive width after we save the graphic to a web page.</p><p>So let’s save the page now now, by running this code:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># save chart as a web page
life_expect_n$save(&quot;life_expect_n.html&quot;, cdn = FALSE)
</code></pre>"><span class="hljs-comment"># save chart as a web page</span>
life_expect_n$save(<span class="hljs-string">"life_expect_n.html"</span>, cdn = <span class="hljs-literal">FALSE</span>)
</code></pre><p>The saved web page should now be in your <code>week13</code> folder. So open it in a web browser and explore its interactivity. There will be a tooltip, and you can remove a line by clicking on the corresponding legend item.</p><p>Now open the file <code>life_expect_n.html</code> in your text editor. You will notice the following between the <code>&lt;head&gt; &lt;/head&gt;</code> tags of the web page:</p><pre class="css hljs"><code class="CSS" data-origin="<pre><code class=&quot;CSS&quot;>    &amp;lt;link rel='stylesheet' href='/Library/Frameworks/R.framework/Versions/3.2/Resources/library/rCharts/libraries/nvd3/css/nv.d3.css'&amp;gt;
    &amp;lt;link rel='stylesheet' href='/Library/Frameworks/R.framework/Versions/3.2/Resources/library/rCharts/libraries/nvd3/css/rNVD3.css'&amp;gt;

    &amp;lt;script src='/Library/Frameworks/R.framework/Versions/3.2/Resources/library/rCharts/libraries/nvd3/js/jquery-1.8.2.min.js' type='text/javascript'&amp;gt;&amp;lt;/script&amp;gt;
    &amp;lt;script src='/Library/Frameworks/R.framework/Versions/3.2/Resources/library/rCharts/libraries/nvd3/js/d3.v3.min.js' type='text/javascript'&amp;gt;&amp;lt;/script&amp;gt;
    &amp;lt;script src='/Library/Frameworks/R.framework/Versions/3.2/Resources/library/rCharts/libraries/nvd3/js/nv.d3.min-new.js' type='text/javascript'&amp;gt;&amp;lt;/script&amp;gt;
    &amp;lt;script src='/Library/Frameworks/R.framework/Versions/3.2/Resources/library/rCharts/libraries/nvd3/js/fisheye.js' type='text/javascript'&amp;gt;&amp;lt;/script&amp;gt;
</code></pre>">    &lt;link rel='stylesheet' href='/Library/Frameworks/R.framework/Versions/3.2/Resources/library/rCharts/libraries/nvd3/css/nv.d3.css'&gt;
    &lt;link rel='stylesheet' href='/Library/Frameworks/R.framework/Versions/3.2/Resources/library/rCharts/libraries/nvd3/css/rNVD3.css'&gt;

    &lt;script src='/Library/Frameworks/R.framework/Versions/3.2/Resources/library/rCharts/libraries/nvd3/js/jquery-1.8.2.min.js' type='text/javascript'&gt;&lt;/script&gt;
    &lt;script src='/Library/Frameworks/R.framework/Versions/3.2/Resources/library/rCharts/libraries/nvd3/js/d3.v3.min.js' type='text/javascript'&gt;&lt;/script&gt;
    &lt;script src='/Library/Frameworks/R.framework/Versions/3.2/Resources/library/rCharts/libraries/nvd3/js/nv.d3.min-new.js' type='text/javascript'&gt;&lt;/script&gt;
    &lt;script src='/Library/Frameworks/R.framework/Versions/3.2/Resources/library/rCharts/libraries/nvd3/js/fisheye.js' type='text/javascript'&gt;&lt;/script&gt;
</code></pre><p>This shows that the page is loading the JavaScript libraries and CSS needed to make the graphic from within the rCharts package, so we need to switch to the local versions in the <code>week13</code> folder.</p><p>To do this, replace the block of code above with the following:</p><pre class="css hljs"><code class="CSS" data-origin="<pre><code class=&quot;CSS&quot;>  &amp;lt;link rel=&quot;stylesheet&quot; href=&quot;css/nv.d3.css&quot;&amp;gt;
  &amp;lt;script src=&quot;src/d3.min.js&quot;&amp;gt;&amp;lt;/script&amp;gt;
  &amp;lt;script src=&quot;src/nv.d3.1.7.js&quot;&amp;gt;&amp;lt;/script&amp;gt;
  &amp;lt;script src=&quot;src/jquery-1.11.3.min.js&quot;&amp;gt;&amp;lt;/script&amp;gt;
</code></pre>">  &lt;link rel="stylesheet" href="css/nv.d3.css"&gt;
  &lt;script src="src/d3.min.js"&gt;&lt;/script&gt;
  &lt;script src="src/nv.d3.1.7.js"&gt;&lt;/script&gt;
  &lt;script src="src/jquery-1.11.3.min.js"&gt;&lt;/script&gt;
</code></pre><p>(Here we are loading the <code>1.7</code> release of NVD3, because the <code>1.8</code> release currently has a bug that can cause the colors of a line chart to render incorrectly when the chart is redrawn.)</p><p>Between the <code>&lt;style&gt; &lt;/style</code> tags immediately below, change <code>width: 800px;</code> to <code>width: 100%;</code>. Finally, scroll down the page and in the script that draws the chart, and delete or comment out this line:</p><pre class="javascript hljs"><code class="JavaScript" data-origin="<pre><code class=&quot;JavaScript&quot;>&quot;width&quot;:    800,
</code></pre>"><span class="hljs-string">"width"</span>:    <span class="hljs-number">800</span>,
</code></pre><p>These two changes will override the default width of 800px, allowing the chart to be responsive.</p><p>It is also possibile to customize the chart using some CSS. Paste the following code between the page’s <style> </style> tags to remove the Y axis and increase the thickness of the lines on the chart:</p><pre class="css hljs"><code class="CSS" data-origin="<pre><code class=&quot;CSS&quot;>    /* remove y axis */
     .nv-axis path { display: none; }

    /* set stroke width */
    .nvd3 g.nv-groups path.nv-line {
      stroke-width: 4px;
    }
</code></pre>">    <span class="hljs-comment">/* remove y axis */</span>
     <span class="hljs-class">.nv-axis</span> <span class="hljs-tag">path</span> <span class="hljs-rules">{ <span class="hljs-rule"><span class="hljs-attribute">display</span>:<span class="hljs-value"> none</span></span>; <span class="hljs-rule">}</span></span>

    <span class="hljs-comment">/* set stroke width */</span>
    <span class="hljs-class">.nvd3</span> <span class="hljs-tag">g</span><span class="hljs-class">.nv-groups</span> <span class="hljs-tag">path</span><span class="hljs-class">.nv-line</span> <span class="hljs-rules">{
      <span class="hljs-rule"><span class="hljs-attribute">stroke-width</span>:<span class="hljs-value"> <span class="hljs-number">4px</span></span></span>;
    <span class="hljs-rule">}</span></span>
</code></pre><p>The chart should now look like this:</p><p><img src="img/class13_3.jpg" alt=""></p><h5 id="line-chart-with-highcharts"><a name="line-chart-with-highcharts" href="#line-chart-with-highcharts"></a>Line chart with Highcharts</h5><p>Now we’ll draw a similar chart using the <a href="http://www.highcharts.com/">Highcharts</a>. (Note that Highcharts requires a <a href="http://shop.highsoft.com/highcharts.html">paid license</a> for use on commercial websites.)</p><p>The basic code is similar to before, except that it uses the rCharts function <code>hPlot()</code>:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># make life expectancy line chart with HighCharts
life_expect_h &amp;lt;- hPlot(life_expect ~ year, 
                          group = &quot;country&quot;, 
                          data = countries, 
                          type = &quot;line&quot;)

# plot chart
life_expect_h
</code></pre>"><span class="hljs-comment"># make life expectancy line chart with HighCharts</span>
life_expect_h &lt;- hPlot(life_expect ~ year, 
                          group = <span class="hljs-string">"country"</span>, 
                          data = countries, 
                          type = <span class="hljs-string">"line"</span>)

<span class="hljs-comment"># plot chart</span>
life_expect_h
</code></pre><p>Note that Highcharts types have different names: See <a href="http://www.highcharts.com/docs/chart-and-series-types/chart-types">here</a> for the available options.</p><p>This code should draw the following chart:</p><p><img src="img/class13_4.jpg" alt=""></p><p>Again, we can customize the chart and replot:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># customize chart
life_expect_h$yAxis(title = list(text = &quot;Life expectancy at birth (years)&quot;))
life_expect_h$xAxis(title = list(text = &quot;&quot;))
life_expect_h$colors(&quot;#e41a1c&quot;, &quot;#377eb8&quot;, &quot;#4daf4a&quot;, &quot;#984ea3&quot;)
life_expect_h$plotOptions(line=list(marker=list(enabled=FALSE)))

# plot chart
life_expect_h
</code></pre>"><span class="hljs-comment"># customize chart</span>
life_expect_h$yAxis(title = list(text = <span class="hljs-string">"Life expectancy at birth (years)"</span>))
life_expect_h$xAxis(title = list(text = <span class="hljs-string">""</span>))
life_expect_h$colors(<span class="hljs-string">"#e41a1c"</span>, <span class="hljs-string">"#377eb8"</span>, <span class="hljs-string">"#4daf4a"</span>, <span class="hljs-string">"#984ea3"</span>)
life_expect_h$plotOptions(line=list(marker=list(enabled=<span class="hljs-literal">FALSE</span>)))

<span class="hljs-comment"># plot chart</span>
life_expect_h
</code></pre><p>You will see that code to change the axis labels and colors is a little different than for NVD3, which reflects differences in the two libraries’ syntax. <a href="https://github.com/ramnathv">Ramnath Vaidyanathan</a>, the author of rCharts, has a series of examples for <a href="https://github.com/ramnathv/rCharts/blob/master/inst/libraries/nvd3/examples.R">NVD3</a> and <a href="https://github.com/ramnathv/rCharts/blob/master/inst/libraries/highcharts/examples.R">Highcharts</a>, which will help explain how to customize your charts using each library.</p><p>The last line of the code used to customize the chart removes the point markers, rendering a simple line chart, which should now look like this:</p><p><img src="img/class13_4.jpg" alt=""></p><p>Save the chart as a web page:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># save the chart as web page
life_expect_h$save(&quot;life_expect_h.html&quot;, cdn = FALSE)
</code></pre>"><span class="hljs-comment"># save the chart as web page</span>
life_expect_h$save(<span class="hljs-string">"life_expect_h.html"</span>, cdn = <span class="hljs-literal">FALSE</span>)
</code></pre><p>Again, we need to swap out some code from the head of the page to use our local copies of Highcharts and jQuery. Between the <code>&lt;head&gt; &lt;/head&gt;</code> tags of the web page, replace this:</p><pre class="css hljs"><code class="CSS" data-origin="<pre><code class=&quot;CSS&quot;>   &amp;lt;script src='/Library/Frameworks/R.framework/Versions/3.2/Resources/library/rCharts/libraries/highcharts/js/jquery-1.9.1.min.js' type='text/javascript'&amp;gt;&amp;lt;/script&amp;gt;
    &amp;lt;script src='/Library/Frameworks/R.framework/Versions/3.2/Resources/library/rCharts/libraries/highcharts/js/highcharts.js' type='text/javascript'&amp;gt;&amp;lt;/script&amp;gt;
    &amp;lt;script src='/Library/Frameworks/R.framework/Versions/3.2/Resources/library/rCharts/libraries/highcharts/js/highcharts-more.js' type='text/javascript'&amp;gt;&amp;lt;/script&amp;gt;
    &amp;lt;script src='/Library/Frameworks/R.framework/Versions/3.2/Resources/library/rCharts/libraries/highcharts/js/exporting.js' type='text/javascript'&amp;gt;&amp;lt;/script&amp;gt;
</code></pre>">   &lt;script src='/Library/Frameworks/R.framework/Versions/3.2/Resources/library/rCharts/libraries/highcharts/js/jquery-1.9.1.min.js' type='text/javascript'&gt;&lt;/script&gt;
    &lt;script src='/Library/Frameworks/R.framework/Versions/3.2/Resources/library/rCharts/libraries/highcharts/js/highcharts.js' type='text/javascript'&gt;&lt;/script&gt;
    &lt;script src='/Library/Frameworks/R.framework/Versions/3.2/Resources/library/rCharts/libraries/highcharts/js/highcharts-more.js' type='text/javascript'&gt;&lt;/script&gt;
    &lt;script src='/Library/Frameworks/R.framework/Versions/3.2/Resources/library/rCharts/libraries/highcharts/js/exporting.js' type='text/javascript'&gt;&lt;/script&gt;
</code></pre><p>With this:</p><pre class="css hljs"><code class="CSS" data-origin="<pre><code class=&quot;CSS&quot;>  &amp;lt;script src='src/jquery-1.11.3.min.js' type='text/javascript'&amp;gt;&amp;lt;/script&amp;gt;
  &amp;lt;script src='src/highcharts.js' type='text/javascript'&amp;gt;&amp;lt;/script&amp;gt;
  &amp;lt;script src='src/highcharts-more.js' type='text/javascript'&amp;gt;&amp;lt;/script&amp;gt;
</code></pre>">  &lt;script src='src/jquery-1.11.3.min.js' type='text/javascript'&gt;&lt;/script&gt;
  &lt;script src='src/highcharts.js' type='text/javascript'&gt;&lt;/script&gt;
  &lt;script src='src/highcharts-more.js' type='text/javascript'&gt;&lt;/script&gt;
</code></pre><p>Finally, override the 800px width by making the same two changes as before.</p><p>Both of these charts are now ready to be uploaded to a web server — remembering to also include the <code>src</code> folder, and for the NVD3 chart, the <code>css</code> folder.</p><h4 id="make-column-charts-from-north-atlantic-storms-data"><a name="make-column-charts-from-north-atlantic-storms-data" href="#make-column-charts-from-north-atlantic-storms-data"></a>Make column charts from North Atlantic storms data</h4><p>First load the storms data:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># import storms data
storms &amp;lt;- read.csv(&quot;storms.csv&quot;)
</code></pre>"><span class="hljs-comment"># import storms data</span>
storms &lt;- read.csv(<span class="hljs-string">"storms.csv"</span>)
</code></pre><p>This contains observations of storms recorded every 6 hours, so to count the number of storms and hurricanes per year we will have to process the data uysing dplyr. To do this, run the following block of code:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># count storms and hurricanes per year
storms_year &amp;lt;- storms %&amp;gt;%
  filter(year &amp;gt;= 1980) %&amp;gt;%
  group_by(year,name) %&amp;gt;%
  summarize(max_wind = max(max_wind_mph, na.rm = TRUE)) %&amp;gt;%
  mutate(type = ifelse(max_wind &amp;gt;= 74, &quot;Hurricanes&quot;, &quot;Storms&quot;)) %&amp;gt;%
  ungroup() %&amp;gt;%
  group_by(year, type) %&amp;gt;%
  summarize(count = n())
</code></pre>"><span class="hljs-comment"># count storms and hurricanes per year</span>
storms_year &lt;- storms %&gt;%
  filter(year &gt;= <span class="hljs-number">1980</span>) %&gt;%
  group_by(year,name) %&gt;%
  summarize(max_wind = max(max_wind_mph, na.rm = <span class="hljs-literal">TRUE</span>)) %&gt;%
  mutate(type = ifelse(max_wind &gt;= <span class="hljs-number">74</span>, <span class="hljs-string">"Hurricanes"</span>, <span class="hljs-string">"Storms"</span>)) %&gt;%
  ungroup() %&gt;%
  group_by(year, type) %&gt;%
  summarize(count = n())
</code></pre><p>This creates a new data frame called <code>storms_years</code>. First the storms data frame is filtered to retain only data from 1980 onwards. Then the data is grouped by year and name, which isolates individual storms, and then for each storm we calculate the maximum value of the recorded maximum wind speeds using dplyr’s <code>summarize()</code> function.</p><p>If a storm’s maximum wind speed exceeds 74 mph, it is classed as a hurricane, so this line of code creates a new column called <code>type</code>, labelling the storms as <code>Hurricanes</code> or <code>Storms</code> accordingly:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;>  mutate(type=ifelse(max_wind &amp;gt;= 74, &quot;Hurricanes&quot;, &quot;Storms&quot;))
</code></pre>">  mutate(type=ifelse(max_wind &gt;= <span class="hljs-number">74</span>, <span class="hljs-string">"Hurricanes"</span>, <span class="hljs-string">"Storms"</span>))
</code></pre><p>Then we ungroup the data, and group again by year and type, to count the number of <code>Storms</code> and <code>Hurricanes</code> in each year.</p><h5 id="column-chart-with-nvd3"><a name="column-chart-with-nvd3" href="#column-chart-with-nvd3"></a>Column chart with NVD3</h5><p>Having processed the data, we can now make a column chart using NVD3, with the following code:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># make column chart with NVD3
storms_n &amp;lt;- nPlot(count ~ year, 
                       group= &quot;type&quot;, 
                       data = storms_year, 
                       type = &quot;multiBarChart&quot;)

# plot chart
storms_n
</code></pre>"><span class="hljs-comment"># make column chart with NVD3</span>
storms_n &lt;- nPlot(count ~ year, 
                       group= <span class="hljs-string">"type"</span>, 
                       data = storms_year, 
                       type = <span class="hljs-string">"multiBarChart"</span>)

<span class="hljs-comment"># plot chart</span>
storms_n
</code></pre><p>This will draw the following chart:</p><p><img src="img/class13_6.jpg" alt=""></p><p>Notice the control at top left, which allows users to switch between grouped and stacked columns. The latter is the best view for this data, so now we will customize the chart to force the stacked view, and remove the control:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># customize chart
storms_n$chart(showControls = FALSE,
               stacked = TRUE)
storms_n$yAxis(axisLabel=(&quot;Number of storms&quot;),
               tickFormat = &quot;#! d3.format(',0f') !#&quot;)

# plot chart
storms_n
</code></pre>"><span class="hljs-comment"># customize chart</span>
storms_n$chart(showControls = <span class="hljs-literal">FALSE</span>,
               stacked = <span class="hljs-literal">TRUE</span>)
storms_n$yAxis(axisLabel=(<span class="hljs-string">"Number of storms"</span>),
               tickFormat = <span class="hljs-string">"#! d3.format(',0f') !#"</span>)

<span class="hljs-comment"># plot chart</span>
storms_n
</code></pre><p>The second part of the Y axis customization sets the format for the tick labels on the chart, removing the decimal place to show whole numbers. This is done with D3 code, which is designated by appearing between <code>#!</code> and <code>!#</code>.</p><p>The following chart should now appear:</p><p><img src="img/class13_7.jpg" alt=""></p><p>Again save the chart as a web page:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># save the chart as web page
storms_n$save(&quot;storms_n.html&quot;, cdn = FALSE)
</code></pre>"><span class="hljs-comment"># save the chart as web page</span>
storms_n$save(<span class="hljs-string">"storms_n.html"</span>, cdn = <span class="hljs-literal">FALSE</span>)
</code></pre><p>Open the file <code>storms_n.html</code> in your text editor, and replace the code that loads the JavaScript libraries and NVD3 CSS with the following:</p><pre class="css hljs"><code class="CSS" data-origin="<pre><code class=&quot;CSS&quot;>  &amp;lt;link rel=&quot;stylesheet&quot; href=&quot;css/nv.d3.css&quot;&amp;gt;
  &amp;lt;script src=&quot;src/d3.min.js&quot;&amp;gt;&amp;lt;/script&amp;gt;
  &amp;lt;script src=&quot;src/nv.d3.js&quot;&amp;gt;&amp;lt;/script&amp;gt;
  &amp;lt;script src=&quot;src/jquery-1.11.3.min.js&quot;&amp;gt;&amp;lt;/script&amp;gt;
</code></pre>">  &lt;link rel="stylesheet" href="css/nv.d3.css"&gt;
  &lt;script src="src/d3.min.js"&gt;&lt;/script&gt;
  &lt;script src="src/nv.d3.js"&gt;&lt;/script&gt;
  &lt;script src="src/jquery-1.11.3.min.js"&gt;&lt;/script&gt;
</code></pre><p>Again we can apply some CSS to customize the chart between the <code>&lt;style&gt; &lt;/style&gt;</code> tags, here removing the vertical grid lines and the Y axis:</p><pre class="css hljs"><code class="CSS" data-origin="<pre><code class=&quot;CSS&quot;>    /* remove x axis grid lines */
     .nv-x .tick line { display: none} 
    /* remove y axis */
     .nv-axis path { display: none; }
</code></pre>">    <span class="hljs-comment">/* remove x axis grid lines */</span>
     <span class="hljs-class">.nv-x</span> <span class="hljs-class">.tick</span> <span class="hljs-tag">line</span> <span class="hljs-rules">{ <span class="hljs-rule"><span class="hljs-attribute">display</span>:<span class="hljs-value"> none</span></span></span>} 
    <span class="hljs-comment">/* remove y axis */</span>
     <span class="hljs-class">.nv-axis</span> <span class="hljs-tag">path</span> <span class="hljs-rules">{ <span class="hljs-rule"><span class="hljs-attribute">display</span>:<span class="hljs-value"> none</span></span>; <span class="hljs-rule">}</span></span>
</code></pre><p>The chart should now look like this:</p><p><img src="img/class13_8.jpg" alt=""></p><h5 id="column-chart-with-highcharts"><a name="column-chart-with-highcharts" href="#column-chart-with-highcharts"></a>Column chart with Highcharts</h5><p>Now we will make a similar chart with Highcharts:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># make storms column chart with HighCharts
storms_h &amp;lt;- hPlot(count ~ year, 
                  group = &quot;type&quot;, 
                  data = storms_year, 
                  type = &quot;column&quot;)

# plot chart
storms_h
</code></pre>"><span class="hljs-comment"># make storms column chart with HighCharts</span>
storms_h &lt;- hPlot(count ~ year, 
                  group = <span class="hljs-string">"type"</span>, 
                  data = storms_year, 
                  type = <span class="hljs-string">"column"</span>)

<span class="hljs-comment"># plot chart</span>
storms_h
</code></pre><p>This will draw the following chart:</p><p><img src="img/class13_9.jpg" alt=""></p><p>If we want to stack the columns, and emulate the color scheme of our earlier NVD3 chart, we again need some customization:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># customize chart
storms_h$plotOptions(column = list(stacking = &quot;normal&quot;))
storms_h$yAxis(title = list(text = &quot;Number of storms&quot;),
               reversedStacks = FALSE)
storms_h$xAxis(title = list(text = &quot;&quot;))
storms_h$colors(&quot;#1f77b4&quot;, &quot;#aec7e8&quot;)

# plot chart
storms_h

# save chart
storms_h$save(&quot;storms_h.html&quot;, cdn = FALSE)
</code></pre>"><span class="hljs-comment"># customize chart</span>
storms_h$plotOptions(column = list(stacking = <span class="hljs-string">"normal"</span>))
storms_h$yAxis(title = list(text = <span class="hljs-string">"Number of storms"</span>),
               reversedStacks = <span class="hljs-literal">FALSE</span>)
storms_h$xAxis(title = list(text = <span class="hljs-string">""</span>))
storms_h$colors(<span class="hljs-string">"#1f77b4"</span>, <span class="hljs-string">"#aec7e8"</span>)

<span class="hljs-comment"># plot chart</span>
storms_h

<span class="hljs-comment"># save chart</span>
storms_h$save(<span class="hljs-string">"storms_h.html"</span>, cdn = <span class="hljs-literal">FALSE</span>)
</code></pre><p>The first line of this code switches to stacked columns. If we want the columns to stack in the same order as the NVD3 chart, we need also to include <code>reversedStacks = FALSE</code> in the Y axis customization.</p><p>Edit the file <code>storms_h.html</code> as before, to load local copes of Highcharts and jQuery, and to make the chart responsive, rather than 800px wide.</p><p>The final chart should look like this:</p><p><img src="img/class13_10.jpg" alt=""></p><h3 id="install-htmlwidgets"><a name="install-htmlwidgets" href="#install-htmlwidgets"></a>Install htmlwidgets</h3><p>Now we will explore the possibilities offered by htmlwidgets, so we need to install and load the htmlwidgets package:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># install and load htmlwidgets
install.packages(&quot;htmlwidgets&quot;)
library(htmlwidgets)
</code></pre>"><span class="hljs-comment"># install and load htmlwidgets</span>
install.packages(<span class="hljs-string">"htmlwidgets"</span>)
<span class="hljs-keyword">library</span>(htmlwidgets)
</code></pre><h3 id="make-maps-of-seismic-risks-and-earthquakes-using-leaflet"><a name="make-maps-of-seismic-risks-and-earthquakes-using-leaflet" href="#make-maps-of-seismic-risks-and-earthquakes-using-leaflet"></a>Make maps of seismic risks and earthquakes using Leaflet</h3><p><a href="http://leafletjs.com/">Leaflet</a> is the most widely-used JavaScript code library for making interactive online maps. It can be accessed from R using the <a href="http://rstudio.github.io/leaflet/">leaflet</a> htmlwidget. So we need to install and load that:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># install and load leaflet
install.packages(&quot;leaflet&quot;)
library(leaflet)
</code></pre>"><span class="hljs-comment"># install and load leaflet</span>
install.packages(<span class="hljs-string">"leaflet"</span>)
<span class="hljs-keyword">library</span>(leaflet)
</code></pre><p>Step by step, we are going to recreate a version of <a href="http://paldhous.github.io/earthquakes/">this map</a>, which I originally coded from Leaflet in scratch. After class, you may wish to download the code for that map from its <a href="https://github.com/paldhous/earthquakes">GitHub repository</a>, to compare with the R version.</p><p>First let’s see how to make a basic Leaflet map, centered on Berkeley:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># make leaflet map centered on Berkeley
map &amp;lt;- leaflet() %&amp;gt;% 
  setView(lng = -122.2705383, lat = 37.8698807, zoom = 11) %&amp;gt;%
  addTiles() 

# plot the map
map
</code></pre>"><span class="hljs-comment"># make leaflet map centered on Berkeley</span>
map &lt;- leaflet() %&gt;% 
  setView(lng = -<span class="hljs-number">122.2705383</span>, lat = <span class="hljs-number">37.8698807</span>, zoom = <span class="hljs-number">11</span>) %&gt;%
  addTiles() 

<span class="hljs-comment"># plot the map</span>
map
</code></pre><p>The following map should appear in your RStudio Viewer:</p><p><img src="img/class13_11.jpg" alt=""></p><p>The function <code>setView()</code> allows us to set the starting position of the map, centering it on the defined coordinates and with the defined zoom level; <code>addTiles()</code> adds <a href="https://www.openstreetmap.org/">OpenStreetMap</a> tiles to the map, which would otherwise be blank. Notice that the map is interactive, and can be panned and zoomed just like a Google Map.</p><p>We aren’t limited to using OpenStreetMap tiles:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># make leaflet map centered on Berkeley with CartoDB tiles
map &amp;lt;- leaflet() %&amp;gt;% 
  setView(lng = -122.2705383, lat = 37.8698807, zoom = 11) %&amp;gt;%
  addProviderTiles(&quot;CartoDB.Positron&quot;) 

# plot the map
map
</code></pre>"><span class="hljs-comment"># make leaflet map centered on Berkeley with CartoDB tiles</span>
map &lt;- leaflet() %&gt;% 
  setView(lng = -<span class="hljs-number">122.2705383</span>, lat = <span class="hljs-number">37.8698807</span>, zoom = <span class="hljs-number">11</span>) %&gt;%
  addProviderTiles(<span class="hljs-string">"CartoDB.Positron"</span>) 

<span class="hljs-comment"># plot the map</span>
map
</code></pre><p>The map should now look like this:</p><p><img src="img/class13_12.jpg" alt=""></p><p>The function <code>addProviderTiles()</code> uses the <a href="https://github.com/leaflet-extras/leaflet-providers">Leaflet Providers</a> plugin to add various tiles to a map. You can see the available options <a href="http://leaflet-extras.github.io/leaflet-providers/preview/">here</a>.</p><p>Now let’s load the data we need to make the earthquakes map. To load the <code>seismic_risk_clip</code> shapefile, we need another R package, called <a href="https://cran.r-project.org/web/packages/rgdal/rgdal.pdf">rgdal</a>.</p><p>So install and load that:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># install and load rgdal
install.packages(&quot;rgdal&quot;)
library(rgdal)
</code></pre>"><span class="hljs-comment"># install and load rgdal</span>
install.packages(<span class="hljs-string">"rgdal"</span>)
<span class="hljs-keyword">library</span>(rgdal)
</code></pre><p>Now we can load the shapefile with the following code:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># load seismic risk shapefile
seismic_risk &amp;lt;- readOGR(&quot;seismic_risk_clip&quot;, &quot;seismic_risk_clip&quot;)
</code></pre>"><span class="hljs-comment"># load seismic risk shapefile</span>
seismic_risk &lt;- readOGR(<span class="hljs-string">"seismic_risk_clip"</span>, <span class="hljs-string">"seismic_risk_clip"</span>)
</code></pre><p>The two mentions of <code>seismic_risk_clip</code> refer to the folder and the shapefile within it, respectively.</p><p>You should now have in your environment an object called <code>seismic_risk</code> which is a <code>SpatialPolygonsDataFrame</code>.</p><p>We can also load data on earthquakes, from the U.S. Geological Survey API we encountered in week 4:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># load quakes data from USGS earthquakes API
quakes &amp;lt;- read.csv(&quot;http://earthquake.usgs.gov/fdsnws/event/1/query?starttime=1965-01-01T00:00:00&amp;amp;minmagnitude=6&amp;amp;format=csv&amp;amp;latitude=39.828175&amp;amp;longitude=-98.5795&amp;amp;maxradiuskm=6000&amp;amp;orderby=magnitude&quot;)
</code></pre>"><span class="hljs-comment"># load quakes data from USGS earthquakes API</span>
quakes &lt;- read.csv(<span class="hljs-string">"http://earthquake.usgs.gov/fdsnws/event/1/query?starttime=1965-01-01T00:00:00&amp;minmagnitude=6&amp;format=csv&amp;latitude=39.828175&amp;longitude=-98.5795&amp;maxradiuskm=6000&amp;orderby=magnitude"</span>)
</code></pre><p>Using this url, we have loaded earthquakes since the start of 1965 that had a magnitude of 6 and above, within a 6,000 kilometer radius of the geographic center of the continental United States.</p><p>Let’s look at a summary of the <code>seismic_risk</code> data by running:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># view summary of seismic_risk data
summary(seismic_risk)
</code></pre>"><span class="hljs-comment"># view summary of seismic_risk data</span>
summary(seismic_risk)
</code></pre><p>This is what should be returned in the R Console:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;>Object of class SpatialPolygonsDataFrame
Coordinates:
      min       max
x -124.71 -66.98701
y   24.60  49.36968
Is projected: FALSE 
proj4string :
[+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0]
Data attributes:
    ACC_VAL           VALLEY       
 Min.   :  0.00   Min.   :0.00000  
 1st Qu.: 18.00   1st Qu.:0.00000  
 Median : 40.00   Median :0.00000  
 Mean   : 44.57   Mean   :0.08264  
 3rd Qu.: 60.00   3rd Qu.:0.00000  
 Max.   :200.00   Max.   :1.00000
</code></pre>">Object of class SpatialPolygonsDataFrame
Coordinates:
      min       max
x -<span class="hljs-number">124.71</span> -<span class="hljs-number">66.98701</span>
y   <span class="hljs-number">24.60</span>  <span class="hljs-number">49.36968</span>
Is projected: <span class="hljs-literal">FALSE</span> 
proj4string :
[+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>]
Data attributes:
    ACC_VAL           VALLEY       
 Min.   :  <span class="hljs-number">0.00</span>   Min.   :<span class="hljs-number">0.00000</span>  
 1st Qu.: <span class="hljs-number">18.00</span>   1st Qu.:<span class="hljs-number">0.00000</span>  
 Median : <span class="hljs-number">40.00</span>   Median :<span class="hljs-number">0.00000</span>  
 Mean   : <span class="hljs-number">44.57</span>   Mean   :<span class="hljs-number">0.08264</span>  
 3rd Qu.: <span class="hljs-number">60.00</span>   3rd Qu.:<span class="hljs-number">0.00000</span>  
 Max.   :<span class="hljs-number">200.00</span>   Max.   :<span class="hljs-number">1.00000</span>
</code></pre><p>The data defining the risk of a major earthquake is in the variable <code>ACC_VAL</code>, and has values that run from 0 to 200.</p><p>Now let’s load this data into a Leaflet map:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># load the seismic risk data into a leaflet map
seismic_map &amp;lt;- leaflet(data=seismic_risk)
</code></pre>"><span class="hljs-comment"># load the seismic risk data into a leaflet map</span>
seismic_map &lt;- leaflet(data=seismic_risk)
</code></pre><p>For the time being this map will be blank, as we have not added any tiles, or styled the <code>seismic_risk</code> data in any way.</p><p>We are going to make a choropleth map, so we will first set breaks to divide the data in into bins:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># set breaks for custom bins
breaks &amp;lt;- c(0,19,39,59,79,200)
</code></pre>"><span class="hljs-comment"># set breaks for custom bins</span>
breaks &lt;- c(<span class="hljs-number">0</span>,<span class="hljs-number">19</span>,<span class="hljs-number">39</span>,<span class="hljs-number">59</span>,<span class="hljs-number">79</span>,<span class="hljs-number">200</span>)
</code></pre><p>Then set a color palette, using these breaks and a “Reds” sequential color scheme from ColorBrewer (which can be called by name in the leaflet htmlwidget):</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># set palette
binpal &amp;lt;- colorBin(&quot;Reds&quot;, seismic_map$ACC_VAL, breaks)
</code></pre>"><span class="hljs-comment"># set palette</span>
binpal &lt;- colorBin(<span class="hljs-string">"Reds"</span>, seismic_map$ACC_VAL, breaks)
</code></pre><p>Now we are ready to make a choropleth map, using the following code:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># make choropleth map of seismic risks
seismic &amp;lt;- seismic_map %&amp;gt;%
  setView(lng = -98.5795, lat = 39.828175, zoom = 4) %&amp;gt;%
  addProviderTiles(&quot;CartoDB.Positron&quot;) %&amp;gt;% 
  addPolygons(
    stroke = FALSE, 
    fillOpacity = 0.7, 
    smoothFactor = 0.1,
    color = ~binpal(ACC_VAL)
  )

# draw map
seismic
</code></pre>"><span class="hljs-comment"># make choropleth map of seismic risks</span>
seismic &lt;- seismic_map %&gt;%
  setView(lng = -<span class="hljs-number">98.5795</span>, lat = <span class="hljs-number">39.828175</span>, zoom = <span class="hljs-number">4</span>) %&gt;%
  addProviderTiles(<span class="hljs-string">"CartoDB.Positron"</span>) %&gt;% 
  addPolygons(
    stroke = <span class="hljs-literal">FALSE</span>, 
    fillOpacity = <span class="hljs-number">0.7</span>, 
    smoothFactor = <span class="hljs-number">0.1</span>,
    color = ~binpal(ACC_VAL)
  )

<span class="hljs-comment"># draw map</span>
seismic
</code></pre><p>The function <code>addPolygons()</code> adds polygons to the map: <code>stroke = FALSE</code> gives them no outline; <code>fillOpacity = 0.7</code> makes them slightly transparent; <code>color = ~binpal(ACC_VAL)</code> uses the color palette and breaks we set up earlier to color the polygons according to values in the <code>ACC_VAL</code> data.</p><p><code>smoothFactor</code> controls the extent to which the polygons are simplified. See what happens to the map if you replace <code>0.1</code> with <code>10</code>. Simplified polygons will load more quickly, but there’s a tradeoff with the appearance of the map. Choose an appropriate value for your maps through trial and error.</p><p>Your RStudio Viewer should now contain the following map:</p><p><img src="img/class13_13.jpg" alt=""></p><p>We can add circles for the quakes as a second data layer, by extending the code as follows:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># make choropleth map of seismic hazards
seismic &amp;lt;- seismic_map %&amp;gt;%
  setView(lng = -98.5795, lat = 39.828175, zoom = 4) %&amp;gt;%
  addProviderTiles(&quot;CartoDB.Positron&quot;) %&amp;gt;% 
  addPolygons(
    stroke = FALSE, 
    fillOpacity = 0.7, 
    smoothFactor = 0.1,
    color = ~binpal(ACC_VAL)
  ) %&amp;gt;%
  # add historical earthquakes
  addCircles(
    data = quakes, 
    radius = sqrt(10^quakes$mag)*50, 
    color = &quot;#000000&quot;,
    weight = 0.2,
    fillColor =&quot;#ffffff&quot;,
    fillOpacity = 0.3,
    popup = paste0(&quot;&amp;lt;strong&amp;gt;Magnitude: &amp;lt;/strong&amp;gt;&quot;, quakes$mag, &quot;&amp;lt;/br&amp;gt;&quot;,
                   &quot;&amp;lt;strong&amp;gt;Date: &amp;lt;/strong&amp;gt;&quot;, format(as.Date(quakes$time), &quot;%b %d, %Y&quot;))
  )

# draw map
seismic
</code></pre>"><span class="hljs-comment"># make choropleth map of seismic hazards</span>
seismic &lt;- seismic_map %&gt;%
  setView(lng = -<span class="hljs-number">98.5795</span>, lat = <span class="hljs-number">39.828175</span>, zoom = <span class="hljs-number">4</span>) %&gt;%
  addProviderTiles(<span class="hljs-string">"CartoDB.Positron"</span>) %&gt;% 
  addPolygons(
    stroke = <span class="hljs-literal">FALSE</span>, 
    fillOpacity = <span class="hljs-number">0.7</span>, 
    smoothFactor = <span class="hljs-number">0.1</span>,
    color = ~binpal(ACC_VAL)
  ) %&gt;%
  <span class="hljs-comment"># add historical earthquakes</span>
  addCircles(
    data = quakes, 
    radius = sqrt(<span class="hljs-number">10</span>^quakes$mag)*<span class="hljs-number">50</span>, 
    color = <span class="hljs-string">"#000000"</span>,
    weight = <span class="hljs-number">0.2</span>,
    fillColor =<span class="hljs-string">"#ffffff"</span>,
    fillOpacity = <span class="hljs-number">0.3</span>,
    popup = paste0(<span class="hljs-string">"&lt;strong&gt;Magnitude: &lt;/strong&gt;"</span>, quakes$mag, <span class="hljs-string">"&lt;/br&gt;"</span>,
                   <span class="hljs-string">"&lt;strong&gt;Date: &lt;/strong&gt;"</span>, format(as.Date(quakes$time), <span class="hljs-string">"%b %d, %Y"</span>))
  )

<span class="hljs-comment"># draw map</span>
seismic
</code></pre><p>The <code>addCircles()</code> function adds circles to the map; <code>color</code> sets the color for their outlines, while <code>weight</code> sets the thickness of these lines; <code>fillColor</code> and <code>fillOpacity</code> style the circles’ interiors.</p><p>The size if the circles is set by <code>radius = sqrt(quakes$mag^10)*50</code>. Here <code>50</code> is simply a scaling factor for all of the circles, set by trial and error to give a reasonable appearance on the map. The size of the circles is set from the variable <code>mag</code> in the quakes data, which is their magnitude. We have raised 10 to the power of these magnitude values: This is a quirk of working with earthquake magnitudes, which are on a logarithmic scale, so that a magnitude difference of 1 corresponds to a 10-fold difference in earth movement, as recorded on a seismogram.</p><p>Usually, when scaling circles, you will simply use the values from the data, and then take their square roots, using the <code>sqrt()</code> function. This is important, to ensure that the circles are scaled correctly, by area, rather than by radius, as we discussed in Week 2.</p><p><code>popup</code> is used to define the HTML code the appears in the popup that appears when any quake is clicked or tapped. here were are using the R function <code>paste0()</code> to paste together a series of elements, separated by commas, that will write the html. They include the <code>mag</code> and <code>time</code> values from the quakes data, the latter being formatted as an easy-to-read date using R’s <code>format()</code> function for dates. See <a href="http://www.statmethods.net/input/dates.html">here</a> for more on formatting dates in R.</p><p>The map should now look like this:</p><p><img src="img/class13_14.jpg" alt=""></p><p>We can add a legend, by extending the code again:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># make choropleth map of seismic hazards
seismic &amp;lt;- seismic_map %&amp;gt;%
  setView(lng = -98.5795, lat = 39.828175, zoom = 4) %&amp;gt;%
  addProviderTiles(&quot;CartoDB.Positron&quot;) %&amp;gt;% 
  addPolygons(
    stroke = FALSE, 
    fillOpacity = 0.7, 
    smoothFactor = 0.1,
    color = ~binpal(ACC_VAL)
  ) %&amp;gt;%
  # add historical earthquakes
  addCircles(
    data = quakes, 
    radius = sqrt(10^quakes$mag)*50, 
    color = &quot;#000000&quot;,
    weight = 0.2,
    fillColor =&quot;#ffffff&quot;,
    fillOpacity = 0.3,
    popup = paste0(&quot;&amp;lt;strong&amp;gt;Magnitude: &amp;lt;/strong&amp;gt;&quot;, quakes$mag, &quot;&amp;lt;/br&amp;gt;&quot;,
                   &quot;&amp;lt;strong&amp;gt;Date: &amp;lt;/strong&amp;gt;&quot;, format(as.Date(quakes$time), &quot;%b %d, %Y&quot;))
  ) %&amp;gt;%
  # add legend
  addLegend (
    &quot;bottomleft&quot;, pal = binpal, values = ~ACC_VAL,
    title = &quot;Seismic risk&quot;,
    opacity = 0.7)

# draw map
seismic
</code></pre>"><span class="hljs-comment"># make choropleth map of seismic hazards</span>
seismic &lt;- seismic_map %&gt;%
  setView(lng = -<span class="hljs-number">98.5795</span>, lat = <span class="hljs-number">39.828175</span>, zoom = <span class="hljs-number">4</span>) %&gt;%
  addProviderTiles(<span class="hljs-string">"CartoDB.Positron"</span>) %&gt;% 
  addPolygons(
    stroke = <span class="hljs-literal">FALSE</span>, 
    fillOpacity = <span class="hljs-number">0.7</span>, 
    smoothFactor = <span class="hljs-number">0.1</span>,
    color = ~binpal(ACC_VAL)
  ) %&gt;%
  <span class="hljs-comment"># add historical earthquakes</span>
  addCircles(
    data = quakes, 
    radius = sqrt(<span class="hljs-number">10</span>^quakes$mag)*<span class="hljs-number">50</span>, 
    color = <span class="hljs-string">"#000000"</span>,
    weight = <span class="hljs-number">0.2</span>,
    fillColor =<span class="hljs-string">"#ffffff"</span>,
    fillOpacity = <span class="hljs-number">0.3</span>,
    popup = paste0(<span class="hljs-string">"&lt;strong&gt;Magnitude: &lt;/strong&gt;"</span>, quakes$mag, <span class="hljs-string">"&lt;/br&gt;"</span>,
                   <span class="hljs-string">"&lt;strong&gt;Date: &lt;/strong&gt;"</span>, format(as.Date(quakes$time), <span class="hljs-string">"%b %d, %Y"</span>))
  ) %&gt;%
  <span class="hljs-comment"># add legend</span>
  addLegend (
    <span class="hljs-string">"bottomleft"</span>, pal = binpal, values = ~ACC_VAL,
    title = <span class="hljs-string">"Seismic risk"</span>,
    opacity = <span class="hljs-number">0.7</span>)

<span class="hljs-comment"># draw map</span>
seismic
</code></pre><p>The final version of the code, below, adds a second tileset, and sets up layer controls to allow users to switch between basemaps, and to turn the quakes layer on and off:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># make multi-layered leaflet map with layer-switching control
# make choropleth map of seismic hazards
seismic &amp;lt;- seismic_map %&amp;gt;%
  setView(lng = -98.5795, lat = 39.828175, zoom = 4) %&amp;gt;%
  addProviderTiles(&quot;CartoDB.Positron&quot;, group = &quot;CartoDB&quot;) %&amp;gt;% 
  addProviderTiles(&quot;Stamen.TonerLite&quot;, group = &quot;Toner&quot;) %&amp;gt;%
  addPolygons(
    stroke = FALSE, fillOpacity = 0.7, 
    smoothFactor = 0.1,
    color = ~binpal(ACC_VAL)
  ) %&amp;gt;%
  # add historical earthquakes
  addCircles(
             data=quakes, 
             radius = sqrt(10^quakes$mag)*50, 
             weight = 0.2, 
             color = &quot;#000000&quot;, 
             fillColor =&quot;#ffffff&quot;,
             fillOpacity = 0.3,
             popup = paste0(&quot;&amp;lt;strong&amp;gt;Magnitude: &amp;lt;/strong&amp;gt;&quot;, quakes$mag, &quot;&amp;lt;/br&amp;gt;&quot;,
                            &quot;&amp;lt;strong&amp;gt;Date: &amp;lt;/strong&amp;gt;&quot;, format(as.Date(quakes$time), &quot;%b %d, %Y&quot;)),
             group = &quot;Quakes&quot;
  ) %&amp;gt;%
  # add legend
  addLegend(
            &quot;bottomleft&quot;, pal = binpal, values = ~ACC_VAL,
            title = &quot;Seismic risk&quot;,
            opacity = 0.7
  ) %&amp;gt;%
  # add layers control
  addLayersControl(
  baseGroups = c(&quot;CartoDB&quot;, &quot;Toner&quot;),
  overlayGroups = &quot;Quakes&quot;,
  options = layersControlOptions(collapsed = FALSE)
  )

# draw map
seismic
</code></pre>"><span class="hljs-comment"># make multi-layered leaflet map with layer-switching control</span>
<span class="hljs-comment"># make choropleth map of seismic hazards</span>
seismic &lt;- seismic_map %&gt;%
  setView(lng = -<span class="hljs-number">98.5795</span>, lat = <span class="hljs-number">39.828175</span>, zoom = <span class="hljs-number">4</span>) %&gt;%
  addProviderTiles(<span class="hljs-string">"CartoDB.Positron"</span>, group = <span class="hljs-string">"CartoDB"</span>) %&gt;% 
  addProviderTiles(<span class="hljs-string">"Stamen.TonerLite"</span>, group = <span class="hljs-string">"Toner"</span>) %&gt;%
  addPolygons(
    stroke = <span class="hljs-literal">FALSE</span>, fillOpacity = <span class="hljs-number">0.7</span>, 
    smoothFactor = <span class="hljs-number">0.1</span>,
    color = ~binpal(ACC_VAL)
  ) %&gt;%
  <span class="hljs-comment"># add historical earthquakes</span>
  addCircles(
             data=quakes, 
             radius = sqrt(<span class="hljs-number">10</span>^quakes$mag)*<span class="hljs-number">50</span>, 
             weight = <span class="hljs-number">0.2</span>, 
             color = <span class="hljs-string">"#000000"</span>, 
             fillColor =<span class="hljs-string">"#ffffff"</span>,
             fillOpacity = <span class="hljs-number">0.3</span>,
             popup = paste0(<span class="hljs-string">"&lt;strong&gt;Magnitude: &lt;/strong&gt;"</span>, quakes$mag, <span class="hljs-string">"&lt;/br&gt;"</span>,
                            <span class="hljs-string">"&lt;strong&gt;Date: &lt;/strong&gt;"</span>, format(as.Date(quakes$time), <span class="hljs-string">"%b %d, %Y"</span>)),
             group = <span class="hljs-string">"Quakes"</span>
  ) %&gt;%
  <span class="hljs-comment"># add legend</span>
  addLegend(
            <span class="hljs-string">"bottomleft"</span>, pal = binpal, values = ~ACC_VAL,
            title = <span class="hljs-string">"Seismic risk"</span>,
            opacity = <span class="hljs-number">0.7</span>
  ) %&gt;%
  <span class="hljs-comment"># add layers control</span>
  addLayersControl(
  baseGroups = c(<span class="hljs-string">"CartoDB"</span>, <span class="hljs-string">"Toner"</span>),
  overlayGroups = <span class="hljs-string">"Quakes"</span>,
  options = layersControlOptions(collapsed = <span class="hljs-literal">FALSE</span>)
  )

<span class="hljs-comment"># draw map</span>
seismic
</code></pre><p>Study the differences between this code and the preceding example to understand how the layers control works.</p><p>The final map should now look like this:</p><p><img src="img/class13_15.jpg" alt=""></p><p>Having completed our map, we can save it as a web page using the following code:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># save the map
saveWidget(seismic, &quot;seismic.html&quot;, selfcontained = TRUE, libdir = NULL,
           background = &quot;white&quot;)
</code></pre>"><span class="hljs-comment"># save the map</span>
saveWidget(seismic, <span class="hljs-string">"seismic.html"</span>, selfcontained = <span class="hljs-literal">TRUE</span>, libdir = <span class="hljs-literal">NULL</span>,
           background = <span class="hljs-string">"white"</span>)
</code></pre><p>The page will be saved with supporting JavaScript files in a folder called  <code>siesmic_files</code>. To put the map online, it must be uploaded to a webserver together with this folder.</p><h3 id="draw-line-charts-of-company-stock-prices-over-time-using-dygraphs"><a name="draw-line-charts-of-company-stock-prices-over-time-using-dygraphs" href="#draw-line-charts-of-company-stock-prices-over-time-using-dygraphs"></a>Draw line charts of company stock prices over time using dygraphs</h3><p>Next we will use the <a href="http://dygraphs.com/">dygraphs</a> Javascript charting library to draw a line graph of two companies’ stock prices. While this is also possible with libraries like NVD3, dygraphs is better at handling large datasets with thousands of values in a time series.</p><p>So let’s now install and load the <a href="http://rstudio.github.io/dygraphs/">dygraphs</a> htmlwidget:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># install and load dygraphs
install.packages(&quot;dygraphs&quot;)
library(dygraphs)
</code></pre>"><span class="hljs-comment"># install and load dygraphs</span>
install.packages(<span class="hljs-string">"dygraphs"</span>)
<span class="hljs-keyword">library</span>(dygraphs)
</code></pre><p>We will compare changes on the stock price of a drug company called Valeant, which has <a href="http://www.businessinsider.com/why-have-valeant-pharmaceuticals-shares-collapsed-2015-11">become controversial</a> in recent months because of alleged “price gouging,” with the pharmaceuticals giant GlaxoSmithKline.</p><p>First we need to load data on each company’s stock market performance, which we can obtain from <a href="http://finance.yahoo.com/">Yahoo Finance</a>.</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># load and process data for Valeant
valeant &amp;lt;- read.csv(&quot;http://real-chart.finance.yahoo.com/table.csv?s=VRX&quot;) %&amp;gt;%
  mutate(Date=as.Date(Date)) %&amp;gt;%
  select(Date, Close) %&amp;gt;%
  rename(VRX = Close)

# and for GSK
gsk &amp;lt;- read.csv(&quot;http://real-chart.finance.yahoo.com/table.csv?s=GSK&quot;) %&amp;gt;%
  mutate(Date=as.Date(Date))  %&amp;gt;%
  select(Date, Close) %&amp;gt;%
  rename(GSK = Close)
</code></pre>"><span class="hljs-comment"># load and process data for Valeant</span>
valeant &lt;- read.csv(<span class="hljs-string">"http://real-chart.finance.yahoo.com/table.csv?s=VRX"</span>) %&gt;%
  mutate(Date=as.Date(Date)) %&gt;%
  select(Date, Close) %&gt;%
  rename(VRX = Close)

<span class="hljs-comment"># and for GSK</span>
gsk &lt;- read.csv(<span class="hljs-string">"http://real-chart.finance.yahoo.com/table.csv?s=GSK"</span>) %&gt;%
  mutate(Date=as.Date(Date))  %&gt;%
  select(Date, Close) %&gt;%
  rename(GSK = Close)
</code></pre><p>The data for each company will initially load with seven columns of data. This code ensures that the dates in the <code>Date</code> column are treated as such, then selects just the <code>Date</code> and <code>Close</code> variables, containing the closing prices for each day. Finally it renames the <code>Close</code> column with each company’s stock market ticker.</p><p>Dygraphs requires each time series to be plotted in a separate column, so now we need to create a data frame with a column for each companies’ data. </p><p>The following code does with using a dplyr join, and then filters the data from the start of 2010 onwards:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># combine into a single data frame with separate column for each company 
# and filter for 2010 onwards
valeant_gsk &amp;lt;- inner_join(gsk, valeant, by=&quot;Date&quot;) %&amp;gt;%
  filter(Date &amp;gt;= &quot;2010-01-01&quot;)
</code></pre>"><span class="hljs-comment"># combine into a single data frame with separate column for each company </span>
<span class="hljs-comment"># and filter for 2010 onwards</span>
valeant_gsk &lt;- inner_join(gsk, valeant, by=<span class="hljs-string">"Date"</span>) %&gt;%
  filter(Date &gt;= <span class="hljs-string">"2010-01-01"</span>)
</code></pre><p>The dygraphs htmlwidget works with R objects called extensible time series, or xts, rather than standard data frames, so now we have to make that conversion.</p><p>To do this, we need to install and load the <a href="https://cran.rstudio.com/web/packages/xts/xts.pdf">xts</a> package:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># install and load xts
install.packages(&quot;xts&quot;)
library(xts)
</code></pre>"><span class="hljs-comment"># install and load xts</span>
install.packages(<span class="hljs-string">"xts"</span>)
<span class="hljs-keyword">library</span>(xts)
</code></pre><p>And then convert the dataframe to an xts object:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># convert to extensible time series (xts)
valeant_gsk &amp;lt;- xts(valeant_gsk, order.by = valeant_gsk$Date)
</code></pre>"><span class="hljs-comment"># convert to extensible time series (xts)</span>
valeant_gsk &lt;- xts(valeant_gsk, order.by = valeant_gsk$Date)
</code></pre><p>We can then draw the time series chart with this code:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># make dygraph line chart
drug_cos &amp;lt;- dygraph(valeant_gsk) %&amp;gt;%
  dyRangeSelector()

# plot chart
drug_cos
</code></pre>"><span class="hljs-comment"># make dygraph line chart</span>
drug_cos &lt;- dygraph(valeant_gsk) %&gt;%
  dyRangeSelector()

<span class="hljs-comment"># plot chart</span>
drug_cos
</code></pre><p><code>dyRangeSelector()</code> adds a control to the bottom of the chart that can be used to focus in on parts of the time series.</p><p>The chart should now look like this</p><p><img src="img/class13_16.jpg" alt=""></p><p>As for rCharts, it is possible to customize dygraph chart. in various ways For example, this version of the code will create anarea chart with the areas filled with an opacity of 0.4:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># make dygraph area chart
drug_cos &amp;lt;- dygraph(valeant_gsk) %&amp;gt;%
  dyOptions(fillGraph = TRUE, 
            fillAlpha = 0.4) %&amp;gt;%
  dyRangeSelector()

dygraph(valeant) %&amp;gt;%
  dyRangeSelector()

# plot chart
drug_cos
</code></pre>"><span class="hljs-comment"># make dygraph area chart</span>
drug_cos &lt;- dygraph(valeant_gsk) %&gt;%
  dyOptions(fillGraph = <span class="hljs-literal">TRUE</span>, 
            fillAlpha = <span class="hljs-number">0.4</span>) %&gt;%
  dyRangeSelector()

dygraph(valeant) %&gt;%
  dyRangeSelector()

<span class="hljs-comment"># plot chart</span>
drug_cos
</code></pre><p>The resulting chart should look like this:</p><p><img src="img/class13_17.jpg" alt=""></p><p>For more customization options, for example <a href="http://rstudio.github.io/dygraphs/gallery-shaded-regions.html">adding shaded bands</a> to the chart area, see the dyrgraphs htmlwidget <a href="http://rstudio.github.io/dygraphs">documentation</a>.</p><p>Again, we can now save the chart as a web page:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># save the chart
saveWidget(drug_cos, &quot;drug_cos.html&quot;, selfcontained = TRUE, libdir = NULL,
           background = &quot;white&quot;)
</code></pre>"><span class="hljs-comment"># save the chart</span>
saveWidget(drug_cos, <span class="hljs-string">"drug_cos.html"</span>, selfcontained = <span class="hljs-literal">TRUE</span>, libdir = <span class="hljs-literal">NULL</span>,
           background = <span class="hljs-string">"white"</span>)
</code></pre><p>Notice that saved htmlwidgets are responsive by default, and will expand to fill the space available. This means they can be easily iframed into divs on a web page.</p><h3 id="draw-a-network-diagram-of-voting-patterns-in-the-u.s.-senate-using-networkd3"><a name="draw-a-network-diagram-of-voting-patterns-in-the-u.s.-senate-using-networkd3" href="#draw-a-network-diagram-of-voting-patterns-in-the-u.s.-senate-using-networkd3"></a>Draw a network diagram of voting patterns in the U.S. Senate using networkD3</h3><p>In Week 2, we discussed how network diagrams can be used to visualize connections between people or things. Now we will use the <a href="http://christophergandrud.github.io/networkD3/">networkD3</a> htmlwidget to draw a D3 network graphic illustrating patterns of voting in the U.S. Senate in 2014.</p><p>See <a href="http://paldhous.github.io/NICAR/2015/gephi.html">here</a> a more detailed tutorial on creating a similar network from Senate voting data, using <a href="https://gephi.github.io/">Gephi</a> and the <a href="http://sigmajs.org/">Sigma.js</a> JavaScript library, with notes on how the data was prepared.</p><p>The data is in the file <code>senate-113-2014.json</code>. To load this into R, first install and load the <a href="https://cran.r-project.org/web/packages/jsonlite/jsonlite.pdf">jsonlite</a> package:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># install and load jsonlite
install.packages(&quot;jsonlite&quot;)
library(jsonlite)
</code></pre>"><span class="hljs-comment"># install and load jsonlite</span>
install.packages(<span class="hljs-string">"jsonlite"</span>)
<span class="hljs-keyword">library</span>(jsonlite)
</code></pre><p>Then load the data and view its structure:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># load senate voting data and view its structure
senate &amp;lt;- fromJSON(&quot;senate-113-2014.json&quot;)
str(senate)
</code></pre>"><span class="hljs-comment"># load senate voting data and view its structure</span>
senate &lt;- fromJSON(<span class="hljs-string">"senate-113-2014.json"</span>)
str(senate)
</code></pre><p>This is what should be returned in the R Console:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;>List of 5
 $ directed  : logi FALSE
 $ graph     : list()
 $ nodes     :'data.frame':    100 obs. of  3 variables:
  ..$ color: chr [1:100] &quot;red&quot; &quot;blue&quot; &quot;red&quot; &quot;blue&quot; ...
  ..$ party: chr [1:100] &quot;R&quot; &quot;D&quot; &quot;R&quot; &quot;D&quot; ...
  ..$ id   : chr [1:100] &quot;Alexander (R-TN)&quot; &quot;Klobuchar (D-MN)&quot; &quot;Graham (R-SC)&quot; &quot;Reid (D-NV)&quot; ...
 $ links     :'data.frame':    4679 obs. of  4 variables:
  ..$ source       : int [1:4679] 0 0 0 0 0 0 0 0 0 0 ...
  ..$ percent_agree: num [1:4679] 0.263 0.789 0.316 0.211 0.263 ...
  ..$ target       : int [1:4679] 1 2 3 4 5 6 7 8 9 10 ...
  ..$ votes_agree  : int [1:4679] 5 15 6 4 5 5 3 5 12 11 ...
 $ multigraph: logi FALSE
</code></pre>">List of <span class="hljs-number">5</span>
 $ directed  : logi <span class="hljs-literal">FALSE</span>
 $ graph     : list()
 $ nodes     :<span class="hljs-string">'data.frame'</span>:    <span class="hljs-number">100</span> obs. of  <span class="hljs-number">3</span> variables:
  ..$ color: chr [<span class="hljs-number">1</span>:<span class="hljs-number">100</span>] <span class="hljs-string">"red"</span> <span class="hljs-string">"blue"</span> <span class="hljs-string">"red"</span> <span class="hljs-string">"blue"</span> <span class="hljs-keyword">...</span>
  ..$ party: chr [<span class="hljs-number">1</span>:<span class="hljs-number">100</span>] <span class="hljs-string">"R"</span> <span class="hljs-string">"D"</span> <span class="hljs-string">"R"</span> <span class="hljs-string">"D"</span> <span class="hljs-keyword">...</span>
  ..$ id   : chr [<span class="hljs-number">1</span>:<span class="hljs-number">100</span>] <span class="hljs-string">"Alexander (R-TN)"</span> <span class="hljs-string">"Klobuchar (D-MN)"</span> <span class="hljs-string">"Graham (R-SC)"</span> <span class="hljs-string">"Reid (D-NV)"</span> <span class="hljs-keyword">...</span>
 $ links     :<span class="hljs-string">'data.frame'</span>:    <span class="hljs-number">4679</span> obs. of  <span class="hljs-number">4</span> variables:
  ..$ <span class="hljs-keyword">source</span>       : int [<span class="hljs-number">1</span>:<span class="hljs-number">4679</span>] <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-keyword">...</span>
  ..$ percent_agree: num [<span class="hljs-number">1</span>:<span class="hljs-number">4679</span>] <span class="hljs-number">0.263</span> <span class="hljs-number">0.789</span> <span class="hljs-number">0.316</span> <span class="hljs-number">0.211</span> <span class="hljs-number">0.263</span> <span class="hljs-keyword">...</span>
  ..$ target       : int [<span class="hljs-number">1</span>:<span class="hljs-number">4679</span>] <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">10</span> <span class="hljs-keyword">...</span>
  ..$ votes_agree  : int [<span class="hljs-number">1</span>:<span class="hljs-number">4679</span>] <span class="hljs-number">5</span> <span class="hljs-number">15</span> <span class="hljs-number">6</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">5</span> <span class="hljs-number">3</span> <span class="hljs-number">5</span> <span class="hljs-number">12</span> <span class="hljs-number">11</span> <span class="hljs-keyword">...</span>
 $ multigraph: logi <span class="hljs-literal">FALSE</span>
</code></pre><p>This shows that <code>senate</code> is a list containing objects including two data frames, called <code>nodes</code> and <code>links</code>. </p><p>Let’s now view the contents of each data frame</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># view contents of nodes and links 
View(senate$nodes)
View(senate$links)
</code></pre>"><span class="hljs-comment"># view contents of nodes and links </span>
View(senate$nodes)
View(senate$links)
</code></pre><p>The <code>nodes</code> data frame contains three columns, including an <code>id</code> for each Senator, and their <code>party</code>:</p><p><img src="img/class13_18.jpg" alt=""></p><p>The <code>links</code> data frame contains four columns, including <code>source</code> and <code>target</code>, which refer to the row numbers for the Senators in the <code>nodes</code> data frame. The <code>percent_agree</code> column shows how often, as a digital fraction of 1, that pair of senators voted the same way in 2014.</p><p><img src="img/class13_19.jpg" alt=""></p><p>We are going to create a network diagram of these voting patterns, first filtering the data so that a link is drawn between a pair of Senators only if they voted the same way at least two-thirds of the time. We need a filter to reveal the partisan dynamics of the chamber, because almost all Senators voted the same way at least once. It’s how <em>often</em> they did so that matters.</p><p>Now read the data frames from the list into the main R environment, and apply this filter to the links:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># read nodes and links into the main R environment, and apply filter
nodes &amp;lt;- senate$nodes

links &amp;lt;- senate$links %&amp;gt;%
  filter(percent_agree &amp;gt; 0.67)
</code></pre>"><span class="hljs-comment"># read nodes and links into the main R environment, and apply filter</span>
nodes &lt;- senate$nodes

links &lt;- senate$links %&gt;%
  filter(percent_agree &gt; <span class="hljs-number">0.67</span>)
</code></pre><p>We can now draw the network with this code:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># create D3 network
senate_network &amp;lt;- forceNetwork(
  Links = links, 
  Nodes = nodes, 
  Source = &quot;source&quot;,
  Target = &quot;target&quot;, 
  NodeID = &quot;id&quot;,
  Group = &quot;party&quot;, 
  opacity = 1, 
  bounded = TRUE, 
  linkColour = &quot;#cccccc&quot; 
)

# plot the network
senate_network
</code></pre>"><span class="hljs-comment"># create D3 network</span>
senate_network &lt;- forceNetwork(
  Links = links, 
  Nodes = nodes, 
  Source = <span class="hljs-string">"source"</span>,
  Target = <span class="hljs-string">"target"</span>, 
  NodeID = <span class="hljs-string">"id"</span>,
  Group = <span class="hljs-string">"party"</span>, 
  opacity = <span class="hljs-number">1</span>, 
  bounded = <span class="hljs-literal">TRUE</span>, 
  linkColour = <span class="hljs-string">"#cccccc"</span> 
)

<span class="hljs-comment"># plot the network</span>
senate_network
</code></pre><p>Notice that columns from the two data frames are referred to in quote marks. <code>linkColour = "#cccccc"</code> sets the color of the links to a light gray; note the British English spelling of <code>linkColour</code>: networkD3 was written by <a href="http://christophergandrud.blogspot.com/p/biocontact.html">Christopher Gandrud</a>, a political economist at City University in London.</p><p>The following network graph should appear in your RStudio Viewer:</p><p><img src="img/class13_20.jpg" alt=""></p><p>Notice that networkD3 by default uses the <code>d3.scale.category20()</code> color palette. To use colors that reflect the Democratic and Rebublican parties, simply adjust the code to the following:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># set color palette
colors &amp;lt;- JS(&quot;d3.scale.ordinal().range(['#ff0000','#0000ff','#d2691e'])&quot;)

# create D3 network
senate_network &amp;lt;- forceNetwork(
             Links = links, 
             Nodes = nodes, 
             Source = &quot;source&quot;,
             Target = &quot;target&quot;, 
             NodeID = &quot;id&quot;,
             Group = &quot;party&quot;, 
             opacity = 1, 
             bounded = TRUE, 
             linkColour = &quot;#cccccc&quot;, 
             colourScale = colors
             )

# plot the network
senate_network
</code></pre>"><span class="hljs-comment"># set color palette</span>
colors &lt;- JS(<span class="hljs-string">"d3.scale.ordinal().range(['#ff0000','#0000ff','#d2691e'])"</span>)

<span class="hljs-comment"># create D3 network</span>
senate_network &lt;- forceNetwork(
             Links = links, 
             Nodes = nodes, 
             Source = <span class="hljs-string">"source"</span>,
             Target = <span class="hljs-string">"target"</span>, 
             NodeID = <span class="hljs-string">"id"</span>,
             Group = <span class="hljs-string">"party"</span>, 
             opacity = <span class="hljs-number">1</span>, 
             bounded = <span class="hljs-literal">TRUE</span>, 
             linkColour = <span class="hljs-string">"#cccccc"</span>, 
             colourScale = colors
             )

<span class="hljs-comment"># plot the network</span>
senate_network
</code></pre><p>For more networkD3 customization options, see <a href="https://github.com/christophergandrud/networkD3/blob/master/inst/examples/examples.R">these code examples</a>.</p><p>The network graph should now look like this:</p><p><img src="img/class13_21.jpg" alt=""></p><p>Again, we can save the graphic to a webpage with the following code:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># save the network chart
saveWidget(senate_network, &quot;senate.html&quot;, selfcontained = TRUE, libdir = NULL,
           background = &quot;white&quot;)
</code></pre>"><span class="hljs-comment"># save the network chart</span>
saveWidget(senate_network, <span class="hljs-string">"senate.html"</span>, selfcontained = <span class="hljs-literal">TRUE</span>, libdir = <span class="hljs-literal">NULL</span>,
           background = <span class="hljs-string">"white"</span>)
</code></pre><h3 id="further-reading/resources"><a name="further-reading/resources" href="#further-reading/resources"></a>Further reading/resources</h3><p><a href="https://media.readthedocs.org/pdf/rcharts/latest/rcharts.pdf">rCharts Documentation</a></p><p><a href="http://rcharts.io/gallery/#title=all">rCharts Gallery</a><br>Contains many examples with underlying code. Some use additional libraries that will need to be installed separately.</p><p><a href="http://nvd3-community.github.io/nvd3/">NVD3 Examples</a></p><p><a href="http://www.highcharts.com/demo/">Highcharts Demos</a></p><p><a href="http://www.highcharts.com/docs">Highcharts Documentation</a></p><p><a href="http://www.htmlwidgets.org/showcase_leaflet.html">htmlwidgets Showcase</a><br>Gives links tp documentation and code examples for the htmlwidgets developed so far.</p>

<footer style="position:fixed; font-size:.8em; text-align:right; bottom:0px; margin-left:-25px; height:20px; width:100%;">generated by <a href="http://pad.haroopress.com" target="_blank">haroopad</a></footer>
</body>
</html>
